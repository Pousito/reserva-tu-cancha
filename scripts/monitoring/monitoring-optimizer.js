/**
 * Script de Optimizaci√≥n de Monitoreo
 * Implementa el sistema completo de monitoreo y analytics
 */

const fs = require('fs');
const path = require('path');

console.log('üöÄ Iniciando implementaci√≥n del Sistema de Monitoreo y Analytics...\n');

// Funci√≥n para verificar si un archivo existe
function fileExists(filePath) {
  return fs.existsSync(filePath);
}

// Funci√≥n para crear directorio si no existe
function ensureDirectoryExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    console.log(`‚úÖ Directorio creado: ${dirPath}`);
  }
}

// Funci√≥n para integrar middleware en server.js
function integrateMonitoringInServer() {
  const serverPath = path.join(__dirname, '../../server.js');
  
  if (!fileExists(serverPath)) {
    console.error('‚ùå No se encontr√≥ server.js');
    return false;
  }

  let serverContent = fs.readFileSync(serverPath, 'utf8');
  
  // Verificar si ya est√° integrado
  if (serverContent.includes('metricsCollector')) {
    console.log('‚ö†Ô∏è  El sistema de monitoreo ya est√° integrado en server.js');
    return true;
  }

  // Agregar imports
  const importsToAdd = `
// Importar sistema de monitoreo
const metricsCollector = require('./src/utils/metrics-collector');
const alertSystem = require('./src/utils/alert-system');
const monitoringRoutes = require('./src/routes/monitoring');
const {
  apiMetricsMiddleware,
  databaseMetricsMiddleware,
  authMetricsMiddleware,
  pageMetricsMiddleware,
  errorMetricsMiddleware,
  userMetricsMiddleware,
  metricsCleanupMiddleware
} = require('./src/middleware/metrics-middleware');
`;

  // Insertar imports despu√©s de los imports existentes
  const importInsertionPoint = serverContent.indexOf('const bcrypt = require(\'bcryptjs\');');
  if (importInsertionPoint !== -1) {
    const insertAfter = serverContent.indexOf('\n', importInsertionPoint);
    serverContent = serverContent.slice(0, insertAfter + 1) + importsToAdd + serverContent.slice(insertAfter + 1);
  }

  // Agregar configuraci√≥n de alertas
  const alertConfigToAdd = `
// Configurar sistema de alertas
alertSystem.setupAlerts();

// Conectar eventos de m√©tricas con alertas
metricsCollector.on('slowApiCall', (data) => {
  alertSystem.processEvent('slowApi', data);
});

metricsCollector.on('slowDatabaseQuery', (data) => {
  alertSystem.processEvent('slowDatabaseQuery', data);
});

metricsCollector.on('error', (data) => {
  alertSystem.processEvent('error', data);
});

metricsCollector.on('highMemoryUsage', (data) => {
  alertSystem.processEvent('highMemoryUsage', data);
});

metricsCollector.on('reservationMetric', (data) => {
  alertSystem.processEvent('reservation', data);
});

metricsCollector.on('paymentMetric', (data) => {
  alertSystem.processEvent('payment', data);
});
`;

  // Insertar configuraci√≥n de alertas despu√©s de CORS
  const corsInsertionPoint = serverContent.indexOf('app.use(cors(corsOptions));');
  if (corsInsertionPoint !== -1) {
    const insertAfter = serverContent.indexOf('\n', corsInsertionPoint);
    serverContent = serverContent.slice(0, insertAfter + 1) + alertConfigToAdd + serverContent.slice(insertAfter + 1);
  }

  // Agregar middleware de m√©tricas
  const middlewareToAdd = `
// Middleware de m√©tricas
app.use(apiMetricsMiddleware);
app.use(authMetricsMiddleware);
app.use(pageMetricsMiddleware);
app.use(userMetricsMiddleware);
app.use(metricsCleanupMiddleware);

// Middleware de m√©tricas de base de datos (se aplicar√° despu√©s de la conexi√≥n DB)
`;

  // Insertar middleware despu√©s de la configuraci√≥n de alertas
  const middlewareInsertionPoint = serverContent.indexOf('metricsCollector.on(\'paymentMetric\', (data) => {');
  if (middlewareInsertionPoint !== -1) {
    const insertAfter = serverContent.indexOf('});', middlewareInsertionPoint) + 3;
    serverContent = serverContent.slice(0, insertAfter + 1) + middlewareToAdd + serverContent.slice(insertAfter + 1);
  }

  // Agregar rutas de monitoreo
  const routesToAdd = `
// Rutas de monitoreo
app.use('/api/monitoring', monitoringRoutes);

// Dashboard de monitoreo
app.get('/monitoring', (req, res) => {
  res.sendFile(path.join(__dirname, 'public/monitoring-dashboard.html'));
});
`;

  // Insertar rutas antes de las rutas existentes
  const routesInsertionPoint = serverContent.indexOf('app.use(\'/api\', apiRoutes);');
  if (routesInsertionPoint !== -1) {
    serverContent = serverContent.slice(0, routesInsertionPoint) + routesToAdd + '\n' + serverContent.slice(routesInsertionPoint);
  }

  // Agregar middleware de errores de m√©tricas
  const errorMiddlewareToAdd = `
// Middleware de errores de m√©tricas (debe ir al final)
app.use(errorMetricsMiddleware);
`;

  // Insertar al final del archivo, antes de app.listen
  const listenInsertionPoint = serverContent.lastIndexOf('app.listen');
  if (listenInsertionPoint !== -1) {
    serverContent = serverContent.slice(0, listenInsertionPoint) + errorMiddlewareToAdd + '\n' + serverContent.slice(listenInsertionPoint);
  }

  // Aplicar middleware de base de datos despu√©s de la conexi√≥n
  const dbConnectionPoint = serverContent.indexOf('const db = new Pool({');
  if (dbConnectionPoint !== -1) {
    const insertAfter = serverContent.indexOf('});', dbConnectionPoint) + 3;
    const dbMiddlewareCode = `
// Aplicar middleware de m√©tricas de base de datos
app.use(databaseMetricsMiddleware(db));
`;
    serverContent = serverContent.slice(0, insertAfter + 1) + dbMiddlewareCode + serverContent.slice(insertAfter + 1);
  }

  fs.writeFileSync(serverPath, serverContent);
  console.log('‚úÖ Sistema de monitoreo integrado en server.js');
  return true;
}

// Funci√≥n para actualizar package.json con scripts de monitoreo
function updatePackageJson() {
  const packagePath = path.join(__dirname, '../../package.json');
  
  if (!fileExists(packagePath)) {
    console.error('‚ùå No se encontr√≥ package.json');
    return false;
  }

  const packageContent = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
  
  // Agregar scripts de monitoreo
  const monitoringScripts = {
    "monitoring:setup": "node scripts/monitoring/monitoring-optimizer.js",
    "monitoring:dashboard": "echo 'Dashboard disponible en: http://localhost:3000/monitoring'",
    "monitoring:metrics": "curl -s http://localhost:3000/api/monitoring/summary | jq",
    "monitoring:alerts": "curl -s http://localhost:3000/api/monitoring/alerts | jq",
    "monitoring:health": "curl -s http://localhost:3000/api/monitoring/health | jq",
    "monitoring:cleanup": "node scripts/monitoring/cleanup-old-metrics.js"
  };

  packageContent.scripts = { ...packageContent.scripts, ...monitoringScripts };

  fs.writeFileSync(packagePath, JSON.stringify(packageContent, null, 2));
  console.log('‚úÖ Scripts de monitoreo agregados a package.json');
  return true;
}

// Funci√≥n para crear script de limpieza de m√©tricas
function createCleanupScript() {
  const cleanupScriptPath = path.join(__dirname, 'cleanup-old-metrics.js');
  
  const cleanupScript = `/**
 * Script de Limpieza de M√©tricas Antiguas
 * Limpia m√©tricas y alertas antiguas para mantener el rendimiento
 */

const metricsCollector = require('../../src/utils/metrics-collector');
const alertSystem = require('../../src/utils/alert-system');

console.log('üßπ Iniciando limpieza de m√©tricas antiguas...');

try {
  // Limpiar m√©tricas antiguas (m√°s de 7 d√≠as)
  metricsCollector.cleanupOldMetrics();
  console.log('‚úÖ M√©tricas antiguas limpiadas');

  // Limpiar alertas antiguas (m√°s de 30 d√≠as)
  alertSystem.cleanupOldAlerts(30 * 24 * 60 * 60 * 1000);
  console.log('‚úÖ Alertas antiguas limpiadas');

  console.log('üéâ Limpieza completada exitosamente');
} catch (error) {
  console.error('‚ùå Error durante la limpieza:', error);
  process.exit(1);
}
`;

  fs.writeFileSync(cleanupScriptPath, cleanupScript);
  console.log('‚úÖ Script de limpieza creado');
}

// Funci√≥n para crear archivo de configuraci√≥n de monitoreo
function createMonitoringConfig() {
  const configPath = path.join(__dirname, '../../src/config/monitoring.js');
  
  const configContent = `/**
 * Configuraci√≥n del Sistema de Monitoreo
 */

module.exports = {
  // Configuraci√≥n de m√©tricas
  metrics: {
    // Intervalo de recolecci√≥n de m√©tricas de sistema (ms)
    systemMetricsInterval: 30000, // 30 segundos
    
    // Intervalo de recolecci√≥n de m√©tricas de memoria (ms)
    memoryMetricsInterval: 10000, // 10 segundos
    
    // Intervalo de limpieza de m√©tricas antiguas (ms)
    cleanupInterval: 300000, // 5 minutos
    
    // Edad m√°xima de m√©tricas (ms)
    maxMetricsAge: 7 * 24 * 60 * 60 * 1000, // 7 d√≠as
    
    // Historial m√°ximo de memoria
    maxMemoryHistory: 100
  },

  // Configuraci√≥n de alertas
  alerts: {
    // Cooldown por defecto para alertas (ms)
    defaultCooldown: 300000, // 5 minutos
    
    // Edad m√°xima de alertas (ms)
    maxAlertAge: 30 * 24 * 60 * 60 * 1000, // 30 d√≠as
    
    // M√°ximo de alertas en historial
    maxAlertHistory: 1000
  },

  // Configuraci√≥n de email
  email: {
    enabled: process.env.EMAIL_USER && process.env.EMAIL_PASS,
    service: 'gmail',
    alertRecipients: process.env.ALERT_EMAIL ? [process.env.ALERT_EMAIL] : []
  },

  // Configuraci√≥n de webhook
  webhook: {
    enabled: !!process.env.WEBHOOK_URL,
    url: process.env.WEBHOOK_URL
  },

  // Umbrales de alertas
  thresholds: {
    // API lenta (ms)
    slowApiThreshold: 5000,
    
    // Query de DB lenta (ms)
    slowDatabaseThreshold: 2000,
    
    // Tasa de error alta (%)
    highErrorRateThreshold: 0.05, // 5%
    
    // Uso alto de memoria (%)
    highMemoryUsageThreshold: 0.8, // 80%
    
    // Muchas conexiones de DB
    highDatabaseConnectionsThreshold: 80
  }
};
`;

  fs.writeFileSync(configPath, configContent);
  console.log('‚úÖ Configuraci√≥n de monitoreo creada');
}

// Funci√≥n para crear documentaci√≥n
function createDocumentation() {
  const docPath = path.join(__dirname, '../../monitoring-documentation.md');
  
  const documentation = `# Sistema de Monitoreo y Analytics

## üìä Descripci√≥n

Sistema completo de monitoreo en tiempo real para Reserva Tu Cancha que incluye:

- **M√©tricas de Rendimiento**: APIs, base de datos, memoria, CPU
- **M√©tricas de Negocio**: Reservas, pagos, usuarios
- **Sistema de Alertas**: Email, webhook, logs
- **Dashboard en Tiempo Real**: Visualizaci√≥n de m√©tricas

## üöÄ Caracter√≠sticas

### üìà M√©tricas de Rendimiento
- Tiempo de respuesta de APIs
- Rendimiento de consultas de base de datos
- Uso de memoria y CPU
- Tasa de errores
- Tiempo de carga de p√°ginas

### üíº M√©tricas de Negocio
- Reservas por complejo y hora
- Ingresos y conversi√≥n
- M√©tricas de pagos
- Actividad de usuarios

### üö® Sistema de Alertas
- Alertas por rendimiento lento
- Alertas por errores cr√≠ticos
- Alertas de negocio
- Notificaciones por email/webhook

### üìä Dashboard
- M√©tricas en tiempo real
- Gr√°ficos interactivos
- Historial de alertas
- Estado del sistema

## üõ†Ô∏è Uso

### Acceder al Dashboard
\`\`\`
http://localhost:3000/monitoring
\`\`\`

### APIs de Monitoreo
\`\`\`
GET /api/monitoring/summary          # Resumen general
GET /api/monitoring/performance      # M√©tricas de rendimiento
GET /api/monitoring/business         # M√©tricas de negocio
GET /api/monitoring/system           # M√©tricas de sistema
GET /api/monitoring/apis             # Estad√≠sticas de APIs
GET /api/monitoring/database         # Estad√≠sticas de DB
GET /api/monitoring/reservations     # Estad√≠sticas de reservas
GET /api/monitoring/payments         # Estad√≠sticas de pagos
GET /api/monitoring/alerts           # Historial de alertas
GET /api/monitoring/health           # Health check
\`\`\`

### Scripts Disponibles
\`\`\`
npm run monitoring:setup              # Configurar sistema
npm run monitoring:dashboard          # Ver URL del dashboard
npm run monitoring:metrics            # Ver m√©tricas resumidas
npm run monitoring:alerts             # Ver alertas recientes
npm run monitoring:health             # Health check
npm run monitoring:cleanup            # Limpiar m√©tricas antiguas
\`\`\`

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno
\`\`\`
# Email para alertas
EMAIL_USER=tu-email@gmail.com
EMAIL_PASS=tu-password

# Email de destino para alertas
ALERT_EMAIL=admin@tudominio.com

# Webhook para alertas (opcional)
WEBHOOK_URL=https://hooks.slack.com/services/...
\`\`\`

### Configuraci√≥n de Alertas
Las alertas se configuran autom√°ticamente con umbrales sensatos:

- **API lenta**: > 5 segundos
- **Query DB lenta**: > 2 segundos
- **Tasa de error alta**: > 5%
- **Uso alto de memoria**: > 80%

## üìä M√©tricas Disponibles

### Rendimiento
- Tiempo de respuesta de APIs
- Rendimiento de consultas DB
- Uso de memoria/CPU
- Tasa de errores

### Negocio
- Total de reservas
- Ingresos totales
- Tasa de √©xito de pagos
- Reservas por complejo/hora

### Sistema
- Tiempo activo
- Uso de memoria
- Conexiones de DB
- Requests activos

## üö® Tipos de Alertas

### Cr√≠ticas
- Errores de servidor (5xx)
- Errores de base de datos
- Errores de pagos
- Tasa alta de fallos en pagos

### Advertencias
- APIs lentas
- Queries DB lentas
- Uso alto de memoria
- Ca√≠da en reservas

### Informaci√≥n
- Servidor inactivo
- M√©tricas de uso

## üîß Mantenimiento

### Limpieza Autom√°tica
- M√©tricas antiguas: 7 d√≠as
- Alertas antiguas: 30 d√≠as
- Historial de memoria: 100 entradas

### Limpieza Manual
\`\`\`
npm run monitoring:cleanup
\`\`\`

## üìà Interpretaci√≥n de M√©tricas

### Tiempo de Respuesta
- **< 100ms**: Excelente
- **100-500ms**: Bueno
- **500-1000ms**: Aceptable
- **> 1000ms**: Requiere atenci√≥n

### Uso de Memoria
- **< 50%**: Normal
- **50-80%**: Monitorear
- **> 80%**: Cr√≠tico

### Tasa de Error
- **< 1%**: Excelente
- **1-5%**: Aceptable
- **> 5%**: Requiere atenci√≥n

## üéØ Mejores Pr√°cticas

1. **Monitorear regularmente** el dashboard
2. **Configurar alertas** por email/webhook
3. **Revisar m√©tricas** semanalmente
4. **Limpiar m√©tricas** antiguas mensualmente
5. **Optimizar** bas√°ndose en m√©tricas

## üÜò Soluci√≥n de Problemas

### Dashboard no carga
- Verificar que el servidor est√© corriendo
- Verificar rutas de monitoreo
- Revisar logs del servidor

### Alertas no llegan
- Verificar configuraci√≥n de email
- Verificar variables de entorno
- Revisar logs de alertas

### M√©tricas no se actualizan
- Verificar middleware de m√©tricas
- Revisar conexi√≥n a base de datos
- Verificar logs de m√©tricas
`;

  fs.writeFileSync(docPath, documentation);
  console.log('‚úÖ Documentaci√≥n de monitoreo creada');
}

// Funci√≥n principal
async function main() {
  try {
    console.log('üìÅ Verificando estructura de directorios...');
    ensureDirectoryExists(path.join(__dirname, '../../src/utils'));
    ensureDirectoryExists(path.join(__dirname, '../../src/routes'));
    ensureDirectoryExists(path.join(__dirname, '../../src/middleware'));
    ensureDirectoryExists(path.join(__dirname, '../../src/config'));
    ensureDirectoryExists(path.join(__dirname, '../../public'));
    ensureDirectoryExists(path.join(__dirname));

    console.log('\nüîß Integrando sistema de monitoreo en server.js...');
    if (!integrateMonitoringInServer()) {
      console.error('‚ùå Error integrando monitoreo en server.js');
      return;
    }

    console.log('\nüì¶ Actualizando package.json...');
    if (!updatePackageJson()) {
      console.error('‚ùå Error actualizando package.json');
      return;
    }

    console.log('\nüßπ Creando script de limpieza...');
    createCleanupScript();

    console.log('\n‚öôÔ∏è Creando configuraci√≥n de monitoreo...');
    createMonitoringConfig();

    console.log('\nüìö Creando documentaci√≥n...');
    createDocumentation();

    console.log('\nüéâ ¬°Sistema de Monitoreo y Analytics implementado exitosamente!');
    console.log('\nüìä Dashboard disponible en: http://localhost:3000/monitoring');
    console.log('üìñ Documentaci√≥n disponible en: monitoring-documentation.md');
    console.log('\nüöÄ Para activar el sistema:');
    console.log('   1. Reinicia el servidor');
    console.log('   2. Visita http://localhost:3000/monitoring');
    console.log('   3. Configura variables de entorno para alertas (opcional)');

  } catch (error) {
    console.error('‚ùå Error durante la implementaci√≥n:', error);
  }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  main();
}

module.exports = { main };
