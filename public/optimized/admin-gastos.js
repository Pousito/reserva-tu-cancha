const API_BASE=window.API_BASE||window.URL_CONFIG?.API_URL||"/api";let userData=null,categorias=[],movimientos=[],modal=null,gastosChart=null,evolucionChart=null;async function checkAuth(){try{const e=localStorage.getItem("adminToken"),t=localStorage.getItem("adminUser");if(!e||!t)return void(window.location.href="/admin-login.html");if(userData=JSON.parse(t),!["owner","super_admin"].includes(userData.rol))return userData.rol,void Swal.fire({icon:"error",title:"Acceso Denegado",text:"No tienes permisos para acceder a esta sección. Solo owners y super admins pueden ver Control Financiero.",confirmButtonText:"Volver"}).then(()=>{window.location.href="/admin-reservations.html"});const o=document.getElementById("userInfo");o&&(o.textContent=`${userData.nombre} (${getRoleDisplayName(userData.rol)})`),userData.nombre,userData.rol}catch(e){console.error("❌ Error de autenticación:",e),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="/admin-login.html"}}function getRoleDisplayName(e){return{super_admin:"Super Administrador",owner:"Dueño de Complejo",manager:"Administrador de Complejo"}[e]||e}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="/admin-login.html"}async function authenticatedFetch(e,t={}){const o=localStorage.getItem("adminToken");if(!o)throw console.error("❌ No hay token de autenticación"),window.location.href="/admin-login.html",new Error("No hay token de autenticación");const a={Authorization:`Bearer ${o}`,"Content-Type":"application/json"},n={...t,headers:{...a,...t.headers}};try{const t=await fetch(e,n);if(401===t.status)throw console.error("❌ Token inválido o expirado"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="/admin-login.html",new Error("Token inválido o expirado");return t}catch(e){throw console.error("❌ Error en petición autenticada:",e),e}}async function cargarCategorias(){try{showLoading(!0);const e=localStorage.getItem("adminToken"),t=await fetch(`${API_BASE}/gastos/categorias`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Error al cargar categorías");categorias=await t.json();const o=document.getElementById("filterCategoria");o.innerHTML='<option value="">Todas</option>',categorias.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.nombre,o.appendChild(t)}),categorias.length}catch(e){console.error("❌ Error al cargar categorías:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudieron cargar las categorías"})}finally{showLoading(!1)}}async function cargarMovimientos(){try{showLoading(!0);const e=localStorage.getItem("adminToken"),t=new URLSearchParams,o=document.getElementById("filterTipo").value,a=document.getElementById("filterCategoria").value,n=document.getElementById("filterFechaDesde").value,r=document.getElementById("filterFechaHasta").value;o&&t.append("tipo",o),a&&t.append("categoria_id",a),n&&t.append("fecha_desde",n),r&&t.append("fecha_hasta",r);const i=await fetch(`${API_BASE}/gastos/movimientos?${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!i.ok)throw new Error("Error al cargar movimientos");const l=await i.text();try{movimientos=JSON.parse(l)}catch(e){throw console.error("❌ Error parseando JSON:",e),console.error("❌ Texto que causó el error:",l),new Error("Error parseando respuesta del servidor")}window.movimientosFiltrados=[...movimientos],renderizarTabla(),actualizarEstadisticas(),actualizarGraficos(),movimientos.length}catch(e){console.error("❌ Error al cargar movimientos:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudieron cargar los movimientos"})}finally{showLoading(!1)}}function renderizarTabla(){const e=document.getElementById("movimientosTableBody");0!==movimientos.length?e.innerHTML=movimientos.map(e=>`\n        <tr>\n            <td>${formatDate(e.fecha)}</td>\n            <td>\n                <span class="badge-modern badge-${e.tipo}">\n                    <i class="fas fa-${"ingreso"===e.tipo?"arrow-up":"arrow-down"}"></i>\n                    ${"ingreso"===e.tipo?"Ingreso":"Egreso"}\n                </span>\n            </td>\n            <td>\n                <span class="category-badge" style="background: ${e.categoria_color}20; color: ${e.categoria_color};">\n                    <i class="fas ${e.categoria_icono}"></i>\n                    ${e.categoria_nombre}\n                </span>\n            </td>\n            <td>${e.descripcion||'<span class="text-muted">Sin descripción</span>'}</td>\n            <td><strong>$${Number(e.monto).toLocaleString("es-CL")}</strong></td>\n            <td>\n                <button class="btn btn-sm btn-outline-primary" onclick="editarMovimiento(${e.id})">\n                    <i class="fas fa-edit"></i>\n                </button>\n                <button class="btn btn-sm btn-outline-danger" onclick="eliminarMovimiento(${e.id})">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='\n            <tr>\n                <td colspan="6" class="text-center text-muted py-5">\n                    <i class="fas fa-inbox fa-3x mb-3 d-block" style="opacity: 0.3;"></i>\n                    No hay movimientos registrados\n                </td>\n            </tr>\n        '}function actualizarEstadisticas(){const e=movimientos.filter(e=>"ingreso"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),t=movimientos.filter(e=>"gasto"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),o=e-t;document.getElementById("totalIngresos").textContent=`$${e.toLocaleString("es-CL")}`,document.getElementById("totalEgresos").textContent=`$${t.toLocaleString("es-CL")}`,document.getElementById("balance").textContent=`$${o.toLocaleString("es-CL")}`;const a=document.getElementById("changeBalance");o>0?(a.className="stat-card-change positive",a.innerHTML='<i class="fas fa-arrow-up"></i> Balance positivo'):o<0?(a.className="stat-card-change negative",a.innerHTML='<i class="fas fa-arrow-down"></i> Balance negativo'):(a.className="stat-card-change",a.innerHTML="Balance neutro")}function actualizarGraficos(){actualizarGraficoEgresos(),actualizarGraficoEvolucion()}function actualizarGraficoEgresos(){const e=document.getElementById("gastosChart"),t=document.getElementById("filterTipo").value;movimientos.length;let o="Distribución de Ingresos y Egresos";o="ingreso"===t?"Distribución de Ingresos":"gasto"===t?"Distribución de Egresos":"Distribución de Ingresos y Egresos";const a=document.getElementById("gastosChartTitle");a&&(a.textContent=o);const n={};let r=window.movimientosFiltrados||movimientos;"ingreso"===t||"gasto"===t?(r=r.filter(e=>e.tipo===t),r.length):r.length,r.forEach(e=>{n[e.categoria_nombre]||(n[e.categoria_nombre]={monto:0,color:e.categoria_color}),n[e.categoria_nombre].monto+=Number(e.monto)});const i=Object.keys(n),l=i.map(e=>n[e].monto),s=i.map(e=>n[e].color);gastosChart&&gastosChart.destroy(),0!==i.length?gastosChart=new Chart(e,{type:"doughnut",data:{labels:i,datasets:[{data:l,backgroundColor:s,borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{title:{display:!0,text:o,font:{size:16,weight:"bold"},color:"#374151",padding:20},legend:{position:"bottom",labels:{padding:15,font:{size:12}}},tooltip:{callbacks:{label:function(e){return`${e.label||""}: $${(e.parsed||0).toLocaleString("es-CL")}`}}}}}}):e.innerHTML=`\n            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280;">\n                <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>\n                <p style="margin: 0; font-size: 1.1rem;">No hay datos para mostrar</p>\n                <p style="margin: 0; font-size: 0.9rem; opacity: 0.7;">${o}</p>\n            </div>\n        `}function actualizarGraficoEvolucion(){const e=document.getElementById("evolucionChart"),t={};movimientos.forEach(e=>{const o=e.fecha.substring(0,7);t[o]||(t[o]={ingresos:0,egresos:0}),"ingreso"===e.tipo?t[o].ingresos+=Number(e.monto):t[o].egresos+=Number(e.monto)});const o=Object.keys(t).sort(),a=o.map(e=>t[e].ingresos),n=o.map(e=>t[e].egresos);evolucionChart&&evolucionChart.destroy();const r=e.getContext("2d"),i=r.createLinearGradient(0,0,0,400);i.addColorStop(0,"rgba(16, 185, 129, 0.4)"),i.addColorStop(.5,"rgba(16, 185, 129, 0.2)"),i.addColorStop(1,"rgba(16, 185, 129, 0.0)");const l=r.createLinearGradient(0,0,0,400);l.addColorStop(0,"rgba(239, 68, 68, 0.4)"),l.addColorStop(.5,"rgba(239, 68, 68, 0.2)"),l.addColorStop(1,"rgba(239, 68, 68, 0.0)"),evolucionChart=new Chart(e,{type:"line",data:{labels:o.map(e=>{const[t,o]=e.split("-");return new Date(t,o-1).toLocaleDateString("es-CL",{month:"short",year:"numeric"})}),datasets:[{label:"Ingresos",data:a,borderColor:"#10b981",backgroundColor:i,borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#10b981",pointBorderColor:"#ffffff",pointBorderWidth:3,pointRadius:6,pointHoverRadius:10,pointHoverBackgroundColor:"#10b981",pointHoverBorderColor:"#ffffff",pointHoverBorderWidth:4},{label:"Egresos",data:n,borderColor:"#ef4444",backgroundColor:l,borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#ef4444",pointBorderColor:"#ffffff",pointBorderWidth:3,pointRadius:6,pointHoverRadius:10,pointHoverBackgroundColor:"#ef4444",pointHoverBorderColor:"#ffffff",pointHoverBorderWidth:4}]},options:{responsive:!0,maintainAspectRatio:!0,interaction:{intersect:!1,mode:"index"},plugins:{legend:{position:"bottom",labels:{padding:20,font:{size:13,weight:"600"},color:"#ffffff",usePointStyle:!0,pointStyle:"circle"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",titleColor:"#ffffff",bodyColor:"#ffffff",borderColor:"rgba(255, 255, 255, 0.3)",borderWidth:1,cornerRadius:10,padding:12,displayColors:!0,callbacks:{label:function(e){return`${e.dataset.label||""}: $${(e.parsed.y||0).toLocaleString("es-CL")}`},footer:function(e){let t=0,o=0;e.forEach(e=>{"Ingresos"===e.dataset.label?t=e.parsed.y:"Egresos"===e.dataset.label&&(o=e.parsed.y)});const a=t-o;return a>=0?`Balance: +$${a.toLocaleString("es-CL")}`:`Balance: -$${Math.abs(a).toLocaleString("es-CL")}`}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("es-CL")}}}}}})}function openModal(e){document.getElementById("movimientoForm").reset(),document.getElementById("movimientoId").value="",document.getElementById("movimientoTipo").value=e,document.getElementById("movimientoFecha").valueAsDate=new Date;const t=document.getElementById("movimientoModalTitle");"ingreso"===e?(t.innerHTML='<i class="fas fa-plus-circle me-2"></i>Registrar Ingreso',t.closest(".modal-header").style.background="linear-gradient(135deg, #10b981 0%, #059669 100%)"):(t.innerHTML='<i class="fas fa-minus-circle me-2"></i>Registrar Egreso',t.closest(".modal-header").style.background="linear-gradient(135deg, #ef4444 0%, #dc2626 100%)");const o=document.getElementById("movimientoCategoria");o.innerHTML='<option value="">Seleccionar categoría...</option>',categorias.filter(t=>t.tipo===e).forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.nombre,o.appendChild(t)}),modal.show()}async function editarMovimiento(e){const t=movimientos.find(t=>t.id===e);if(!t)return;document.getElementById("movimientoId").value=t.id,document.getElementById("movimientoTipo").value=t.tipo,document.getElementById("movimientoCategoria").value=t.categoria_id,document.getElementById("movimientoMonto").value=t.monto,document.getElementById("movimientoFecha").value=t.fecha,document.getElementById("movimientoDescripcion").value=t.descripcion||"",document.getElementById("movimientoMetodo").value=t.metodo_pago||"",document.getElementById("movimientoDocumento").value=t.numero_documento||"";document.getElementById("movimientoModalTitle").innerHTML='<i class="fas fa-edit me-2"></i>Editar Movimiento';const o=document.getElementById("movimientoCategoria");o.innerHTML='<option value="">Seleccionar categoría...</option>',categorias.filter(e=>e.tipo===t.tipo).forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.nombre,e.id===t.categoria_id&&(a.selected=!0),o.appendChild(a)}),modal.show()}async function guardarMovimiento(){try{const e=document.getElementById("movimientoForm");if(!e.checkValidity())return void e.reportValidity();showLoading(!0);const t=localStorage.getItem("adminToken"),o=document.getElementById("movimientoId").value,a=document.getElementById("movimientoTipo").value,n=document.getElementById("movimientoCategoria").value,r=document.getElementById("movimientoMonto").value,i=document.getElementById("movimientoFecha").value,l=document.getElementById("movimientoDescripcion").value,s=document.getElementById("movimientoMetodo").value,c=document.getElementById("movimientoDocumento").value,d={tipo:a,categoria_id:parseInt(n),monto:parseFloat(r),fecha:i,descripcion:l,metodo_pago:s,numero_documento:c},m=o?`${API_BASE}/gastos/movimientos/${o}`:`${API_BASE}/gastos/movimientos`,g=o?"PUT":"POST",u=await fetch(m,{method:g,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(d)});if(!u.ok){const e=await u.json();throw new Error(e.message||"Error al guardar")}await Swal.fire({icon:"success",title:"¡Guardado!",text:o?"Movimiento actualizado correctamente":"Movimiento registrado correctamente",timer:2e3,showConfirmButton:!1}),modal.hide(),await cargarMovimientos()}catch(e){console.error("❌ Error al guardar movimiento:",e),Swal.fire({icon:"error",title:"Error",text:e.message||"No se pudo guardar el movimiento"})}finally{showLoading(!1)}}async function eliminarMovimiento(e){if((await Swal.fire({title:"¿Eliminar movimiento?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{showLoading(!0);const t=localStorage.getItem("adminToken");if(!(await fetch(`${API_BASE}/gastos/movimientos/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).ok)throw new Error("Error al eliminar");await Swal.fire({icon:"success",title:"¡Eliminado!",text:"Movimiento eliminado correctamente",timer:2e3,showConfirmButton:!1}),await cargarMovimientos()}catch(e){console.error("❌ Error al eliminar movimiento:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo eliminar el movimiento"})}finally{showLoading(!1)}}function updateCategoriasFilter(){const e=document.getElementById("filterTipo").value,t=document.getElementById("filterCategoria");t.innerHTML='<option value="">Todas</option>';let o=categorias;e&&(o=categorias.filter(t=>t.tipo===e)),o.forEach(e=>{const o=document.createElement("option");o.value=e.id,o.textContent=e.nombre,t.appendChild(o)}),applyFilters()}function applyFilters(){filtrarMovimientosLocalmente(),actualizarGraficos()}function filtrarMovimientosLocalmente(){const e=document.getElementById("filterTipo").value,t=document.getElementById("filterCategoria").value,o=document.getElementById("filterFechaDesde").value,a=document.getElementById("filterFechaHasta").value;let n=[...movimientos];e&&(n=n.filter(t=>t.tipo===e),n.length),t&&(n=n.filter(e=>e.categoria_id==t),n.length),o&&(n=n.filter(e=>e.fecha>=o),n.length),a&&(n=n.filter(e=>e.fecha<=a),n.length),window.movimientosFiltrados=n,renderizarTablaConDatos(n),actualizarEstadisticasConDatos(n),n.length}function renderizarTablaConDatos(e){const t=document.getElementById("movimientosTableBody");0!==e.length?t.innerHTML=e.map(e=>`\n        <tr>\n            <td>${formatDate(e.fecha)}</td>\n            <td>\n                <span class="badge-modern badge-${e.tipo}">\n                    <i class="fas fa-${"ingreso"===e.tipo?"arrow-up":"arrow-down"}"></i>\n                    ${"ingreso"===e.tipo?"Ingreso":"Egreso"}\n                </span>\n            </td>\n            <td>\n                <div class="category-badge" style="color: ${e.categoria_color}">\n                    <i class="${e.categoria_icono}"></i>\n                    ${e.categoria_nombre}\n                </div>\n            </td>\n            <td class="fw-bold">$${Number(e.monto).toLocaleString("es-CL")}</td>\n            <td>${e.descripcion||"-"}</td>\n            <td>\n                <button class="btn btn-sm btn-outline-primary" onclick="editarMovimiento(${e.id})">\n                    <i class="fas fa-edit"></i>\n                </button>\n                <button class="btn btn-sm btn-outline-danger" onclick="eliminarMovimiento(${e.id})">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </td>\n        </tr>\n    `).join(""):t.innerHTML='\n            <tr>\n                <td colspan="6" class="text-center text-muted py-5">\n                    <i class="fas fa-inbox fa-3x mb-3 d-block" style="opacity: 0.3;"></i>\n                    No hay movimientos que coincidan con los filtros\n                </td>\n            </tr>\n        '}function actualizarEstadisticasConDatos(e){const t=e.filter(e=>"ingreso"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),o=e.filter(e=>"gasto"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),a=t-o;document.getElementById("totalIngresos").textContent=`$${t.toLocaleString("es-CL")}`,document.getElementById("totalGastos").textContent=`$${o.toLocaleString("es-CL")}`,document.getElementById("balance").textContent=`$${a.toLocaleString("es-CL")}`;const n=document.getElementById("changeBalance");a>0?(n.className="stat-card-change positive",n.innerHTML='<i class="fas fa-arrow-up"></i> Balance positivo'):a<0?(n.className="stat-card-change negative",n.innerHTML='<i class="fas fa-arrow-down"></i> Balance negativo'):(n.className="stat-card-change",n.innerHTML="Balance neutro")}function exportToExcel(){if(0===movimientos.length)return void Swal.fire({icon:"warning",title:"Sin datos",text:"No hay movimientos para exportar"});const e=movimientos.filter(e=>"ingreso"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),t=movimientos.filter(e=>"gasto"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),o=e-t,a=formatDate(document.getElementById("filterFechaDesde").value),n=formatDate(document.getElementById("filterFechaHasta").value),r=[];r.push(["CONTROL FINANCIERO"]),r.push([]),r.push(["Complejo:",userData.complejo_nombre||"Todos"]),r.push(["Período:",`${a} - ${n}`]),r.push([]),r.push(["RESUMEN"]),r.push(["Total Ingresos:",e]),r.push(["Total Egresos:",t]),r.push(["Balance:",o]),r.push([]),r.push(["DETALLE DE MOVIMIENTOS"]),r.push(["Fecha","Tipo","Categoría","Descripción","Monto","Método de Pago","Documento"]),movimientos.forEach(e=>{r.push([formatDate(e.fecha),"ingreso"===e.tipo?"Ingreso":"Egreso",e.categoria_nombre,e.descripcion||"",Number(e.monto),e.metodo_pago||"",e.numero_documento||""])});const i=XLSX.utils.aoa_to_sheet(r);i["!cols"]=[{wch:18},{wch:12},{wch:30},{wch:45},{wch:15},{wch:18},{wch:20}],i.A1={v:"💰 CONTROL FINANCIERO",t:"s",s:{font:{bold:!0,sz:18,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"8E44AD"}},alignment:{horizontal:"center",vertical:"center"}}},i.A3&&(i.A3.s={font:{bold:!0,color:{rgb:"8E44AD"}},fill:{fgColor:{rgb:"F4ECF7"}},alignment:{horizontal:"left",vertical:"center"}}),i.B3&&(i.B3.s={font:{sz:11},fill:{fgColor:{rgb:"F4ECF7"}},alignment:{horizontal:"left",vertical:"center"}}),i.A4&&(i.A4.s={font:{bold:!0,color:{rgb:"8E44AD"}},fill:{fgColor:{rgb:"F4ECF7"}},alignment:{horizontal:"left",vertical:"center"}}),i.B4&&(i.B4.s={font:{sz:11},fill:{fgColor:{rgb:"F4ECF7"}},alignment:{horizontal:"left",vertical:"center"}}),i.A6={v:"📊 RESUMEN FINANCIERO",t:"s",s:{font:{bold:!0,sz:13,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"27AE60"}},alignment:{horizontal:"center",vertical:"center"}}};const l={7:{label:"16A085",value:"D5F4E6",textValue:"117A65"},8:{label:"C0392B",value:"FADBD8",textValue:"922B21"},9:{label:"F39C12",value:"FCF3CF",textValue:"B9770E"}};[7,8,9].forEach(e=>{const t=l[e],o=XLSX.utils.encode_cell({r:e-1,c:0}),a=XLSX.utils.encode_cell({r:e-1,c:1});i[o]&&(i[o].s={font:{bold:!0,sz:11,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:t.label}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"medium",color:{rgb:t.label}},bottom:{style:"medium",color:{rgb:t.label}},left:{style:"medium",color:{rgb:t.label}},right:{style:"thin",color:{rgb:t.label}}}}),i[a]&&(i[a].s={font:{bold:!0,sz:12,color:{rgb:t.textValue}},fill:{fgColor:{rgb:t.value}},alignment:{horizontal:"right",vertical:"center"},border:{top:{style:"medium",color:{rgb:t.label}},bottom:{style:"medium",color:{rgb:t.label}},left:{style:"thin",color:{rgb:t.label}},right:{style:"medium",color:{rgb:t.label}}}})}),i.A11={v:"📋 DETALLE DE MOVIMIENTOS",t:"s",s:{font:{bold:!0,sz:13,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"3498DB"}},alignment:{horizontal:"center",vertical:"center"}}};const s={font:{bold:!0,sz:11,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"2980B9"}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:{top:{style:"medium",color:{rgb:"1A5276"}},bottom:{style:"medium",color:{rgb:"1A5276"}},left:{style:"thin",color:{rgb:"1A5276"}},right:{style:"thin",color:{rgb:"1A5276"}}}};["A12","B12","C12","D12","E12","F12","G12"].forEach(e=>{i[e]&&(i[e].s=s)});const c=XLSX.utils.decode_range(i["!ref"]);for(let e=12;e<=c.e.r;++e){const t=(e-12)%2==0,o=r[e],a=o&&o[1]?o[1].toLowerCase():"";let n=t?"FFFFFF":"F8F9FA";"ingreso"===a?n=t?"E8F8F5":"D1F2EB":"gasto"===a&&(n=t?"FADBD8":"F5B7B1");for(let t=0;t<7;++t){const o=XLSX.utils.encode_cell({r:e,c:t});i[o]&&(i[o].s||(i[o].s={}),i[o].s.fill={fgColor:{rgb:n}},i[o].s.border={top:{style:"thin",color:{rgb:"D5DBDB"}},bottom:{style:"thin",color:{rgb:"D5DBDB"}},left:{style:"thin",color:{rgb:"D5DBDB"}},right:{style:"thin",color:{rgb:"D5DBDB"}}},4===t?(i[o].s.alignment={horizontal:"right",vertical:"center"},i[o].v&&(i[o].s.font={bold:!0})):0===t?i[o].s.alignment={horizontal:"center",vertical:"center"}:1===t?(i[o].s.alignment={horizontal:"center",vertical:"center"},"ingreso"===a?i[o].s.font={bold:!0,color:{rgb:"117A65"}}:"gasto"===a&&(i[o].s.font={bold:!0,color:{rgb:"922B21"}})):i[o].s.alignment={horizontal:"left",vertical:"center"})}}i["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}},{s:{r:5,c:0},e:{r:5,c:6}},{s:{r:10,c:0},e:{r:10,c:6}}],i["!rows"]=[],i["!rows"][0]={hpt:28},i["!rows"][2]={hpt:20},i["!rows"][3]={hpt:20},i["!rows"][5]={hpt:24},i["!rows"][6]={hpt:22},i["!rows"][7]={hpt:22},i["!rows"][8]={hpt:22},i["!rows"][10]={hpt:24},i["!rows"][11]={hpt:22};for(let e=12;e<=c.e.r;e++)i["!rows"][e]={hpt:20};const d=XLSX.utils.book_new();XLSX.utils.book_append_sheet(d,i,"Movimientos");const m=`Control_Financiero_${a.replace(/\//g,"-")}_${n.replace(/\//g,"-")}.xlsx`;XLSX.writeFile(d,m),Swal.fire({icon:"success",title:"¡Exportado!",text:"Archivo Excel descargado correctamente",timer:2e3,showConfirmButton:!1})}async function exportToPDF(){if(0===movimientos.length)return void Swal.fire({icon:"warning",title:"Sin datos",text:"No hay movimientos para exportar"});const{jsPDF:e}=window.jspdf,t=new e,o=movimientos.filter(e=>"ingreso"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),a=movimientos.filter(e=>"gasto"===e.tipo).reduce((e,t)=>e+Number(t.monto),0),n=o-a,r=formatDate(document.getElementById("filterFechaDesde").value),i=formatDate(document.getElementById("filterFechaHasta").value);if(t.setFillColor(102,126,234),t.rect(0,0,210,35,"F"),userData.complejo_id)try{let e=null;if(userData.complejo_nombre&&userData.complejo_nombre.toLowerCase().includes("demo 3"))e="/images/logos/demo3-new-life-galilea.png",userData.complejo_nombre;else{e={1:"/images/logos/borde-rio.png",2:"/images/logos/borde-rio.png",7:"/images/logos/borde-rio.png",8:"/images/logos/demo3-new-life-galilea.png"}[userData.complejo_id],userData.complejo_id,userData.complejo_nombre}if(e){const o=await fetch(e);if(o.ok){const e=await o.blob(),a=new FileReader;await new Promise(o=>{a.onloadend=()=>{try{t.addImage(a.result,"PNG",175,7,20,20)}catch(e){e.message}o()},a.onerror=()=>o(),a.readAsDataURL(e)})}}}catch(e){e.message}t.setTextColor(255,255,255),t.setFontSize(20),t.setFont(void 0,"bold"),t.text("Control Financiero",105,15,{align:"center"}),t.setFontSize(11),t.setFont(void 0,"normal"),t.text(`${userData.complejo_nombre||"Todos los complejos"}`,105,23,{align:"center"}),t.text(`Período: ${r} - ${i}`,105,30,{align:"center"});const l=45;t.setFillColor(16,185,129),t.roundedRect(14,l,55,18,3,3,"F"),t.setTextColor(255,255,255),t.setFontSize(9),t.text("Total Ingresos",41.5,51,{align:"center"}),t.setFontSize(12),t.setFont(void 0,"bold"),t.text(`$${o.toLocaleString("es-CL")}`,41.5,59,{align:"center"}),t.setFillColor(239,68,68),t.roundedRect(74,l,55,18,3,3,"F"),t.setTextColor(255,255,255),t.setFontSize(9),t.setFont(void 0,"normal"),t.text("Total Egresos",101.5,51,{align:"center"}),t.setFontSize(12),t.setFont(void 0,"bold"),t.text(`$${a.toLocaleString("es-CL")}`,101.5,59,{align:"center"});const s=n>=0?[59,130,246]:[239,68,68];t.setFillColor(...s),t.roundedRect(134,l,55,18,3,3,"F"),t.setTextColor(255,255,255),t.setFontSize(9),t.setFont(void 0,"normal"),t.text("Balance",161.5,51,{align:"center"}),t.setFontSize(12),t.setFont(void 0,"bold");const c=n>=0?`+$${n.toLocaleString("es-CL")}`:`-$${Math.abs(n).toLocaleString("es-CL")}`;t.text(c,161.5,59,{align:"center"}),t.setTextColor(40,40,40),t.setFontSize(13),t.setFont(void 0,"bold"),t.text("Detalle de Movimientos",14,73);const d=movimientos.map(e=>[formatDate(e.fecha),"ingreso"===e.tipo?"Ingreso":"Egreso",e.categoria_nombre,e.descripcion||"-",`$${Number(e.monto).toLocaleString("es-CL")}`]);t.autoTable({startY:78,head:[["Fecha","Tipo","Categoría","Descripción","Monto"]],body:d,theme:"grid",margin:{left:14,right:14},tableWidth:"auto",headStyles:{fillColor:[102,126,234],textColor:[255,255,255],fontSize:9,fontStyle:"bold",halign:"center",cellPadding:2},styles:{fontSize:7,cellPadding:2,lineColor:[220,220,220],lineWidth:.1,overflow:"linebreak",cellWidth:"wrap"},columnStyles:{0:{cellWidth:"auto",halign:"center",minCellWidth:18},1:{cellWidth:"auto",halign:"center",minCellWidth:15},2:{cellWidth:"auto",minCellWidth:25},3:{cellWidth:"auto",overflow:"linebreak",minCellWidth:40},4:{cellWidth:"auto",halign:"right",fontStyle:"bold",minCellWidth:20}},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:function(e){1===e.column.index&&"body"===e.section&&("Ingreso"===e.cell.raw?(e.cell.styles.textColor=[16,185,129],e.cell.styles.fontStyle="bold"):"Egreso"===e.cell.raw&&(e.cell.styles.textColor=[239,68,68],e.cell.styles.fontStyle="bold"))}});const m=t.internal.getNumberOfPages();for(let e=1;e<=m;e++)t.setPage(e),t.setFontSize(9),t.setTextColor(150,150,150),t.setFont(void 0,"normal"),t.text(`Página ${e} de ${m}`,105,285,{align:"center"}),t.text(`Generado el ${(new Date).toLocaleDateString("es-CL")} a las ${(new Date).toLocaleTimeString("es-CL")}`,105,290,{align:"center"});const g=`Control_Financiero_${r.replace(/\//g,"-")}_${i.replace(/\//g,"-")}.pdf`;t.save(g),Swal.fire({icon:"success",title:"¡Exportado!",text:"Archivo PDF descargado correctamente",timer:2e3,showConfirmButton:!1})}function formatDate(e){if(!e)return"";return new Date(e+"T00:00:00").toLocaleDateString("es-CL",{day:"2-digit",month:"2-digit",year:"numeric"})}function showLoading(e){document.getElementById("loadingOverlay").style.display=e?"flex":"none"}document.addEventListener("DOMContentLoaded",async()=>{await checkAuth();const e=document.getElementById("movimientoModal");modal=new bootstrap.Modal(e),document.getElementById("movimientoFecha").valueAsDate=new Date;const t=new Date,o=new Date(t.getFullYear(),t.getMonth(),1);document.getElementById("filterFechaDesde").valueAsDate=o,document.getElementById("filterFechaHasta").valueAsDate=t,await cargarCategorias(),await cargarMovimientos(),await actualizarEstadisticas()});let categoriaModal=null;function toggleGestionCategorias(){const e=document.getElementById("gestionCategorias");"none"!==e.style.display?e.style.display="none":(e.style.display="block",cargarListaCategorias())}async function cargarListaCategorias(){try{localStorage.getItem("adminToken");const e=await authenticatedFetch(`${API_BASE}/gastos/categorias`);if(e.status,e.statusText,!e.ok){const t=await e.text();throw console.error("❌ Error del servidor:",t),new Error("Error al cargar categorías")}const t=await e.json();t[0],Object.keys(t[0]||{}),t[0],t[0];const o=t.filter(e=>"gasto"===e.tipo),a=t.filter(e=>"ingreso"===e.tipo);o.length,a.length,o[0],a[0],o.length,a.length,renderizarTablaCategorias("listaCategoriasEgresos",o),renderizarTablaCategorias("listaCategoriasIngresos",a)}catch(e){console.error("❌ Error al cargar lista de categorías:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo cargar la lista de categorías"})}}function renderizarTablaCategorias(e,t){t.length;const o=document.getElementById(e);o?0!==t.length?o.innerHTML=t.map(e=>{e.nombre,e.descripcion;const t=`\n            <button class="btn btn-sm btn-primary" onclick="abrirModalCategoria(${e.id}, '${e.tipo}')" title="Editar">\n                <i class="fas fa-edit"></i>\n            </button>\n            <button class="btn btn-sm btn-danger ms-1" onclick="eliminarCategoria(${e.id})" title="Eliminar">\n                <i class="fas fa-trash"></i>\n            </button>\n        `,o=e.nombre||"Sin nombre",a=e.descripcion||"Sin descripción",n=e.icono||"fas fa-circle",r=e.color||"#6c757d";return`\n            <tr style="color: white;">\n                <td style="text-align: center;"><i class="${n}" style="color: ${r}; font-size: 1.5rem;"></i></td>\n                <td style="font-weight: 600; font-size: 1rem; color: white;">${o}</td>\n                <td style="font-style: italic; opacity: 0.9; font-size: 0.9rem; color: rgba(255,255,255,0.8);">${a}</td>\n                <td>\n                    <span class="badge" style="background-color: ${r}; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.875rem;">${r}</span>\n                </td>\n                <td style="text-align: right;">${t}</td>\n            </tr>\n        `}).join(""):o.innerHTML='\n            <tr>\n                <td colspan="5" class="text-center" style="color: rgba(255,255,255,0.7); padding: 2rem;">\n                    <i class="fas fa-inbox fa-2x mb-2 d-block" style="opacity: 0.5;"></i>\n                    No hay categorías de este tipo\n                </td>\n            </tr>\n        ':console.error(`❌ No se encontró el elemento con ID: ${e}`)}async function abrirModalCategoria(e,t){try{if(document.getElementById("categoriaForm").reset(),document.getElementById("categoriaId").value="",document.getElementById("categoriaTipo").value=t,e){const o=await authenticatedFetch(`${API_BASE}/gastos/categorias`);if(!o.ok)throw new Error("Error al cargar categorías");const a=(await o.json()).find(t=>t.id===e);if(!a)throw new Error("Categoría no encontrada");document.getElementById("categoriaId").value=a.id,document.getElementById("categoriaTipo").value=a.tipo,document.getElementById("categoriaNombre").value=a.nombre,document.getElementById("categoriaDescripcion").value=a.descripcion||"",document.getElementById("categoriaIcono").value=a.icono,document.getElementById("categoriaColor").value=a.color,document.getElementById("categoriaModalTitle").innerHTML='<i class="fas fa-edit me-2"></i>Editar Categoría de '+("gasto"===t?"Egreso":"Ingreso")}else document.getElementById("categoriaColor").value="gasto"===t?"#e74c3c":"#27ae60",document.getElementById("categoriaModalTitle").innerHTML='<i class="fas fa-plus me-2"></i>Nueva Categoría de '+("gasto"===t?"Egreso":"Ingreso");categoriaModal.show()}catch(e){console.error("❌ Error al abrir modal de categoría:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo abrir el formulario de categoría"})}}async function guardarCategoria(){try{const e=document.getElementById("categoriaId").value,t=document.getElementById("categoriaTipo").value,o=document.getElementById("categoriaNombre").value.trim(),a=document.getElementById("categoriaDescripcion").value.trim(),n=document.getElementById("categoriaIcono").value,r=document.getElementById("categoriaColor").value;if(!o)return void Swal.fire({icon:"warning",title:"Campos Incompletos",text:"El nombre de la categoría es obligatorio"});const i={nombre:o,descripcion:a,icono:n,color:r,tipo:t};let l;if(l=e?await authenticatedFetch(`${API_BASE}/gastos/categorias/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}):await authenticatedFetch(`${API_BASE}/gastos/categorias`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),!l.ok){const e=await l.json();throw new Error(e.error||"Error al guardar categoría")}await l.json();categoriaModal.hide(),await cargarCategorias(),await cargarListaCategorias(),Swal.fire({icon:"success",title:"¡Guardado!",text:`Categoría ${e?"actualizada":"creada"} correctamente`,timer:2e3,showConfirmButton:!1})}catch(e){console.error("❌ Error al guardar categoría:",e),Swal.fire({icon:"error",title:"Error",text:e.message||"No se pudo guardar la categoría"})}}async function eliminarCategoria(e){try{if(!(await Swal.fire({icon:"warning",title:"¿Estás seguro?",text:"Esta acción no se puede deshacer. La categoría será eliminada permanentemente.",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#6c757d",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return;const t=await authenticatedFetch(`${API_BASE}/gastos/categorias/${e}`,{method:"DELETE"});if(!t.ok){const e=await t.json();throw new Error(e.error||"Error al eliminar categoría")}await cargarCategorias(),await cargarListaCategorias(),Swal.fire({icon:"success",title:"¡Eliminada!",text:"La categoría ha sido eliminada correctamente",timer:2e3,showConfirmButton:!1})}catch(e){console.error("❌ Error al eliminar categoría:",e),Swal.fire({icon:"error",title:"No se puede eliminar",text:e.message||"Esta categoría no se puede eliminar porque tiene movimientos asociados o es una categoría del sistema"})}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("categoriaModal");e&&(categoriaModal=new bootstrap.Modal(e))});