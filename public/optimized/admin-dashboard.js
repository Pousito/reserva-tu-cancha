let reservationsChart,currentPeriod="7d";function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}function formatearHora(e){if(!e)return"";if(e.includes(":")){const t=e.split(":");return`${t[0]}:${t[1]}`}return e}function formatearRangoHoras(e,t){return`${formatearHora(e)} - ${formatearHora(t)}`}function mostrarInfoUsuario(){const e=AdminUtils.getCurrentUser();if(e){const t=document.getElementById("adminWelcome");t&&(t.textContent=`Bienvenido, ${e.nombre||e.email}`);const a=document.querySelector('[data-user="name"]'),r=document.querySelector('[data-user="role"]'),o=document.querySelector('[data-user="complex"]');a&&(a.textContent=e.nombre||"Admin"),r&&(r.textContent=AdminUtils.getRoleDisplayName(e.rol)),o&&(o.textContent=e.complejo_nombre||"Todos los complejos"),e.nombre||e.email,e.rol,e.complejo_nombre}}function asegurarVisibilidadReportes(){const e=AdminUtils.getCurrentUser();if(e&&("owner"===e.rol||"super_admin"===e.rol)){const t=document.querySelectorAll('a[href="admin-reports.html"]');t.length,e.rol,t.forEach((t,a)=>{t.classList.add("owner-visible"),t.classList.remove("hide-for-owner"),t.style.display="block",t.style.visibility="visible",e.rol});const a=document.querySelectorAll('a[href="admin-gastos.html"]');a.length,e.rol,a.forEach((t,a)=>{t.classList.add("owner-visible"),t.classList.remove("hide-for-owner"),t.style.display="block",t.style.visibility="visible",e.rol})}}function aplicarPermisosPorRol(){const e=AdminUtils.getCurrentUser();if(!e)return void setTimeout(aplicarPermisosPorRol,500);const t=e.rol;if(e.email,"manager"===t){const e=document.querySelectorAll(".hide-for-manager");e.length,e.forEach(e=>{e.style.display="none"})}else if("owner"===t){const e=document.querySelectorAll(".hide-for-owner");e.length,e.forEach(e=>{e.style.display="none"});const t=document.querySelectorAll('a[href="admin-reports.html"]');t.length,t.forEach((e,t)=>{e.style.display,e.style.visibility,e.className,window.getComputedStyle(e).display,window.getComputedStyle(e).visibility,e.classList.remove("hide-for-manager"),e.style.display="block",e.style.visibility="visible",e.style.display,e.style.visibility,window.getComputedStyle(e).display,window.getComputedStyle(e).visibility}),t.length;const a=document.querySelectorAll('a[href="admin-gastos.html"]');a.length,a.forEach((e,t)=>{e.classList.remove("hide-for-manager"),e.style.display="block",e.style.visibility="visible",e.style.display,e.style.visibility,e.className,window.getComputedStyle(e).display,window.getComputedStyle(e).visibility}),a.length,asegurarVisibilidadReportes()}else if("super_admin"===t){const e=document.querySelectorAll(".hide-for-manager, .hide-for-owner");e.length,e.forEach((e,t)=>{e.classList.remove("hide-for-manager"),e.classList.remove("hide-for-owner"),e.style.display="",e.style.visibility=""}),asegurarVisibilidadReportes()}else if("manager"===t){const e=document.querySelectorAll(".hide-for-manager");e.length,e.forEach((e,t)=>{})}}function actualizarHoraActual(){const e=(new Date).toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=document.getElementById("currentTime");if(t)t.textContent=e;else{const t=document.getElementById("adminWelcome");if(t){const a=AdminUtils.getCurrentUser(),r=a?a.nombre||a.email:"Admin";t.textContent=`Bienvenido, ${r} - ${e}`}}}async function cargarEstadisticas(){try{const e=new URL(`${API_BASE}/admin/estadisticas`),t=new Date;let a,r;switch(currentPeriod){case"7d":default:a=new Date(t.getTime()-6048e5);break;case"30d":a=new Date(t.getTime()-2592e6);break;case"month":a=new Date(t.getFullYear(),t.getMonth(),1);case"all":}a&&e.searchParams.append("dateFrom",a.toISOString().split("T")[0]),r&&e.searchParams.append("dateTo",r.toISOString().split("T")[0]),e.toString();const o=await AdminUtils.authenticatedFetch(e.toString());if(o&&o.ok){const e=await o.json(),t=document.getElementById("totalReservas"),a=document.getElementById("totalCanchas"),r=document.getElementById("totalComplejos"),n=document.getElementById("ingresosTotales");t?(t.textContent=e.totalReservas||"0",e.totalReservas):console.error("❌ Elemento totalReservas no encontrado"),a?(a.textContent=e.totalCanchas||"0",e.totalCanchas):console.error("❌ Elemento totalCanchas no encontrado"),r?(r.textContent=e.totalComplejos||"0",e.totalComplejos):console.error("❌ Elemento totalComplejos no encontrado"),n?(n.textContent=`$${formatCurrencyChile(e.ingresosTotales)||"0"}`,e.ingresosTotales):console.error("❌ Elemento ingresosTotales no encontrado"),e.reservasPorDia&&e.reservasPorDia.length>0&&actualizarGraficoReservas(e.reservasPorDia)}else console.error("Error cargando estadísticas:",o?.status)}catch(e){console.error("Error cargando estadísticas:",e)}}async function cargarReservasRecientes(){try{const e=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/reservas-recientes`);if(e&&e.ok){const t=await e.json();(()=>{let e=document.getElementById("recentReservationsList");e||(e=document.querySelector('[data-test="recent-reservations-container"]')),e||(e=document.querySelector(".reservations-content")),e?(mostrarReservasRecientes(t),t.length):console.error("❌ No se pudo encontrar el elemento para reservas recientes")})()}else console.error("Error cargando reservas recientes:",e?.status)}catch(e){console.error("Error cargando reservas recientes:",e)}}async function cargarReservasHoy(){try{const e=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/reservas-hoy`);if(e&&e.ok){const t=await e.json();mostrarReservasHoy(t),t.length}else console.error("Error cargando reservas de hoy:",e?.status)}catch(e){console.error("Error cargando reservas de hoy:",e)}}function mostrarReservasRecientes(e){let t=document.getElementById("recentReservationsList");if(!t)if(t=document.querySelector('[data-test="recent-reservations-container"]'),t);else{const e=document.querySelectorAll(".reservations-content");if(e.length,e.length>0)t=e[0];else{const e=Array.from(document.querySelectorAll("*")).filter(e=>e.textContent&&e.textContent.includes("Cargando reservas"));if(e.length,e.length>0){let a=e[0].parentElement;for(;a&&!a.classList.contains("reservations-content");)a=a.parentElement;a&&(t=a)}}}if(!t){const e=document.querySelector(".recent-reservations");if(!e)return void console.error("❌ No se pudo crear el elemento - contenedor padre no encontrado");t=document.createElement("div"),t.id="recentReservations",t.className="reservations-content",e.appendChild(t)}if(!e||0===e.length)return void(t.innerHTML='\n            <div class="text-center text-muted">\n                <i class="fas fa-calendar-times fa-2x mb-3"></i>\n                <p>No hay reservas recientes</p>\n            </div>\n        ');const a=e.slice(0,10);t.innerHTML=a.map((e,t)=>`\n        <div class="reservation-item">\n            <div class="d-flex justify-content-between align-items-start">\n                <div class="flex-grow-1">\n                    <div class="d-flex align-items-center mb-2">\n                        <span class="badge bg-primary me-2" style="font-size: 0.75rem;">#${t+1}</span>\n                        <h6 class="mb-0 text-dark">${e.nombre_cliente||"Sin nombre"}</h6>\n                    </div>\n                    <div class="mb-1">\n                        <small class="text-muted">\n                            <i class="fas fa-building me-1"></i>${e.complejo_nombre||"Sin complejo"}\n                        </small>\n                    </div>\n                    <div class="mb-1">\n                        <small class="text-muted">\n                            <i class="fas fa-calendar me-1"></i>${formatearFechaCorta(e.fecha)}\n                        </small>\n                    </div>\n                    <div>\n                        <small class="text-muted">\n                            <i class="fas fa-clock me-1"></i>${formatearHora(e.hora_inicio)}\n                        </small>\n                    </div>\n                </div>\n                <div class="text-end">\n                    ${e.precio_total?`<span class="badge bg-success mb-1">$${e.precio_total}</span><br>`:""}\n                    <small class="text-muted" style="font-size: 0.7rem;">${e.codigo_reserva||"Sin código"}</small>\n                </div>\n            </div>\n        </div>\n    `).join("")}function mostrarReservasHoy(e){const t=document.getElementById("todayReservations");t?e&&0!==e.length?t.innerHTML=e.map(e=>`\n        <div class="reservation-item">\n            <div class="d-flex justify-content-between align-items-start">\n                <div class="flex-grow-1">\n                    <div class="d-flex align-items-center mb-1">\n                        <span class="badge bg-success me-2">HOY</span>\n                        <h6 class="mb-0">${e.nombre_cliente||"Sin nombre"}</h6>\n                    </div>\n                    <p class="text-muted mb-1 small">\n                        <i class="fas fa-building me-1"></i>${e.complejo_nombre||"Sin complejo"}\n                    </p>\n                    <p class="text-muted mb-1 small">\n                        <i class="fas fa-futbol me-1"></i>${e.cancha_nombre||"Cancha N/A"}\n                    </p>\n                    <p class="text-muted mb-0 small">\n                        <i class="fas fa-clock me-1"></i>${formatearRangoHoras(e.hora_inicio,e.hora_fin)}\n                    </p>\n                </div>\n                <div class="text-end">\n                    ${e.precio_total?`<span class="badge bg-success fs-6">$${e.precio_total}</span><br>`:""}\n                    <small class="text-muted">${e.codigo_reserva||"Sin código"}</small>\n                </div>\n            </div>\n        </div>\n    `).join(""):t.innerHTML='\n            <div class="text-center text-muted">\n                <i class="fas fa-calendar-day fa-2x mb-3"></i>\n                <p>No hay reservas programadas para hoy</p>\n            </div>\n        ':console.error("❌ Elemento todayReservations no encontrado")}function inicializarGraficos(){inicializarGraficoReservas()}function inicializarGraficoReservas(){const e=document.getElementById("reservationsChart"),t=(document.getElementById("chartLoading"),e.getContext("2d"));reservationsChart=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"Reservas",data:[],borderColor:"#667eea",backgroundColor:"rgba(102, 126, 234, 0.1)",borderWidth:3,fill:!0,tension:.4,pointBackgroundColor:"#667eea",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:6,pointHoverRadius:8,pointHoverBackgroundColor:"#667eea",pointHoverBorderColor:"#ffffff",pointHoverBorderWidth:3}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.9)",titleColor:"#ffffff",bodyColor:"#ffffff",borderColor:"#667eea",borderWidth:1,cornerRadius:8,displayColors:!1,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:12,callbacks:{title:function(e){return`📅 ${e[0].label}`},label:function(e){return`📊 ${e.parsed.y} reserva${1!==e.parsed.y?"s":""}`}}}},scales:{x:{grid:{display:!0,color:"rgba(0, 0, 0, 0.05)",drawBorder:!1},ticks:{color:"#6b7280",font:{size:12}}},y:{beginAtZero:!0,grid:{color:"rgba(102, 126, 234, 0.1)",drawBorder:!1},ticks:{color:"#6b7280",stepSize:1,font:{size:12},callback:function(e){return Number.isInteger(e)?e:null}}}},animation:{duration:1200,easing:"easeInOutQuart"},elements:{line:{borderJoinStyle:"round",borderCapStyle:"round"}}}})}function actualizarGraficoReservas(e){if(!reservationsChart)return;if(!e||0===e.length)return reservationsChart.data.labels=["Sin datos"],reservationsChart.data.datasets[0].data=[0],void reservationsChart.update();const t=e.map(e=>formatearFechaCorta(e.dia)),a=e.map(e=>parseInt(e.cantidad));reservationsChart.data.labels=t,reservationsChart.data.datasets[0].data=a,reservationsChart.update(),e.length}function actualizarGrafico(){const e=document.getElementById("reservationsChart"),t=document.getElementById("chartLoading"),a=event.target.closest("button").querySelector("i");a.classList.add("fa-spin"),t.classList.add("show"),e.style.display="none",cargarEstadisticas().then(()=>{a.classList.remove("fa-spin"),t.classList.remove("show"),e.style.display="block"}).catch(r=>{console.error("❌ Error actualizando gráfico:",r),a.classList.remove("fa-spin"),t.classList.remove("show"),e.style.display="block"})}function cambiarPeriodo(e){currentPeriod=e;document.getElementById("periodText").textContent={"7d":"Últimos 7 días","30d":"Últimos 30 días",month:"Este mes",all:"Todos los tiempos"}[e];document.querySelector(".chart-header h5").querySelector("i").className=`fas ${{"7d":"fa-calendar-week","30d":"fa-calendar-alt",month:"fa-calendar",all:"fa-infinity"}[e]} me-2 text-primary`;const t=document.getElementById("reservationsChart"),a=document.getElementById("chartLoading");a.classList.add("show"),t.style.display="none",cargarEstadisticas().then(()=>{a.classList.remove("show"),t.style.display="block"}).catch(e=>{console.error("❌ Error actualizando gráfico:",e),a.classList.remove("show"),t.style.display="block"})}function formatearFechaCorta(e){if(!e)return"Sin fecha";try{let t=e;if("string"==typeof e&&e.includes("T")&&(t=e.split("T")[0]),"string"==typeof t&&/^\d{4}-\d{2}-\d{2}$/.test(t)){const[e,a,r]=t.split("-").map(Number);return new Date(e,a-1,r,12,0,0).toLocaleDateString("es-CL",{month:"short",day:"numeric"})}return new Date(t).toLocaleDateString("es-CL",{month:"short",day:"numeric"})}catch(t){return console.error("Error formateando fecha corta:",t,"Fecha original:",e),"Fecha inválida"}}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="../../admin-login.html"}function forzarVisibilidadElementos(){const e=AdminUtils.getCurrentUser();if(e&&("owner"===e.rol||"super_admin"===e.rol)){['a[href="admin-reports.html"]','a[href="admin-gastos.html"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.classList.add("owner-visible"),e.classList.remove("hide-for-owner"),e.style.display="block",e.style.visibility="visible",e.style.opacity="1"})})}}document.addEventListener("DOMContentLoaded",function(){if("undefined"==typeof AdminUtils)return void console.error("❌ AdminUtils no está cargado");if("undefined"==typeof Chart)return void console.error("❌ Chart.js no está cargado");if(void 0===formatearHora)return void console.error("❌ formatearHora no está definida");if(void 0===formatearRangoHoras)return void console.error("❌ formatearRangoHoras no está definida");API_BASE;localStorage.getItem("adminToken"),localStorage.getItem("adminUser");if(AdminUtils.isAuthenticated(),!AdminUtils.isAuthenticated())return void(window.location.href="../../admin-login.html");inicializarGraficoReservas(),mostrarInfoUsuario(),aplicarPermisosPorRol(),AdminUtils.hideElementsByRole(),asegurarVisibilidadReportes(),AdminUtils.setupLogout(),actualizarHoraActual(),setInterval(actualizarHoraActual,1e3);const e=document.getElementById("recentReservationsList"),t=document.getElementById("todayReservations");e||console.error("❌ Elemento recentReservationsList no encontrado en el DOM"),t||console.error("❌ Elemento todayReservations no encontrado en el DOM"),cargarEstadisticas(),cargarReservasRecientes(),cargarReservasHoy(),document.addEventListener("visibilitychange",function(){document.hidden||(cargarEstadisticas(),cargarReservasRecientes(),cargarReservasHoy())}),window.addEventListener("pageshow",function(e){e.persisted&&(cargarEstadisticas(),cargarReservasRecientes(),cargarReservasHoy())}),document.addEventListener("click",function(e){(e.target.closest('a[href="admin-dashboard.html"]')||e.target.closest(".nav-link")||e.target.closest(".sidebar"))&&setTimeout(()=>{asegurarVisibilidadReportes(),cargarEstadisticas()},100)})}),setInterval(forzarVisibilidadElementos,2e3);