let ciudades=[],complejos=[],canchas=[],complejoSeleccionado=null,tipoCanchaSeleccionado=null,canchaSeleccionada=null,bloqueoTemporal=null,sessionId=null;function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}function esHoraDisponibleParaReserva(e,o){const n=new Date,t=new Date(o+"T"+e+":00"),a=new Date(n.getTime()+36e5);return t.toDateString()===n.toDateString()?t>=a:t>n}function obtenerHoraMinimaDisponible(){const e=new Date,o=new Date(e.getTime()+36e5);o.getHours().toString().padStart(2,"0"),o.getMinutes().toString().padStart(2,"0");return(Math.ceil(o.getHours())+(o.getMinutes()>0?1:0)).toString().padStart(2,"0")+":00"}function timeToMinutes(e){const[o,n]=e.split(":");return 60*parseInt(o)+parseInt(n)}function crearLogVisible(){const e=document.createElement("div");return e.id="debug-logs",e.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        width: 300px;\n        max-height: 400px;\n        background: rgba(0,0,0,0.8);\n        color: white;\n        padding: 10px;\n        border-radius: 5px;\n        font-size: 12px;\n        z-index: 9999;\n        overflow-y: auto;\n        font-family: monospace;\n        display: none;\n    ",document.body.appendChild(e),e}function logVisible(e){const o=document.getElementById("debug-logs")||crearLogVisible(),n=(new Date).toLocaleTimeString(),t=document.createElement("div");t.style.cssText="margin: 2px 0; padding: 2px; border-bottom: 1px solid #333;",t.textContent=`[${n}] ${e}`,o.appendChild(t),o.scrollTop=o.scrollHeight,o.style.display="block";const a=o.children;a.length>20&&o.removeChild(a[0])}function crearBotonLogs(){const e=document.createElement("button");e.id="debug-toggle",e.textContent="DEBUG",e.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        background: #007bff;\n        color: white;\n        border: none;\n        padding: 5px 10px;\n        border-radius: 3px;\n        font-size: 12px;\n        z-index: 10000;\n        cursor: pointer;\n    ",e.addEventListener("click",()=>{const e=document.getElementById("debug-logs");e&&(e.style.display="none"===e.style.display?"block":"none")}),document.body.appendChild(e)}function leerParametrosURL(){let e=null,o=null;navigator.userAgent,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),window.location.href,window.location.search,window.location.hostname,window.location.hostname;try{if(window.URLSearchParams){const n=new URLSearchParams(window.location.search);if(e=n.get("ciudad"),o=n.get("complejo"),e){e=decodeURIComponent(e)}if(o){o=decodeURIComponent(o)}}if(!e&&!o){const n=window.location.search.substring(1),t=n.split("&");for(let n=0;n<t.length;n++){const a=t[n].split("=");if(2===a.length){const n=decodeURIComponent(a[0]),t=decodeURIComponent(a[1]);"ciudad"===n&&(e=t),"complejo"===n&&(o=t)}}}if(!e&&!o){const n=window.location.href,t=n.match(/[?&]ciudad=([^&]+)/),a=n.match(/[?&]complejo=([^&]+)/);t&&(e=decodeURIComponent(t[1])),a&&(o=decodeURIComponent(a[1]))}}catch(e){console.error("‚ùå Error leyendo par√°metros URL:",e)}return{ciudad:e,complejo:o}}function preRellenarMovil(e,o){window.location.hostname,window.location.hostname;const n=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(navigator.userAgent,n){if(e){const o=ciudades.find(o=>o.nombre===e);if(o){const e=document.getElementById("ciudadSelect");if(e){for(let n=0;n<5;n++)setTimeout(()=>{e.value=o.id,e.setAttribute("value",o.id),e.value,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0})),e.style.backgroundColor="#e8f5e8",e.style.border="2px solid #28a745",setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},1e3),"localhost"!==window.location.hostname&&(e.style.display="none",setTimeout(()=>{e.style.display="",e.value=o.id,e.dispatchEvent(new Event("change",{bubbles:!0}))},50))},200*n);setTimeout(()=>{"function"==typeof cargarComplejos&&cargarComplejos(o.id)},1e3)}}}o&&setTimeout(()=>{const n=complejos.find(e=>e.nombre===o);if(n){const e=document.getElementById("complejoSelect");if(e)for(let o=0;o<5;o++)setTimeout(()=>{e.value=n.id,e.setAttribute("value",n.id),e.value,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0})),e.style.backgroundColor="#e8f5e8",e.style.border="2px solid #28a745",setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},1e3),"localhost"!==window.location.hostname&&(e.style.display="none",setTimeout(()=>{e.style.display="",e.value=n.id,e.dispatchEvent(new Event("change",{bubbles:!0}))},50)),setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},1e3)},200*o)}else setTimeout(()=>{preRellenarMovil(e,o)},2e3)},1500),"localhost"!==window.location.hostname&&setTimeout(()=>{const n=document.getElementById("ciudadSelect"),t=document.getElementById("complejoSelect");if(e&&n){const o=ciudades.find(o=>o.nombre===e);o&&(n.value=o.id,n.selectedIndex=Array.from(n.options).findIndex(e=>e.value==o.id),n.dispatchEvent(new Event("change",{bubbles:!0})))}if(o&&t){const e=complejos.find(e=>e.nombre===o);e&&(t.value=e.id,t.selectedIndex=Array.from(t.options).findIndex(o=>o.value==e.id),t.dispatchEvent(new Event("change",{bubbles:!0})))}},3e3)}}function preRellenarPC(e,o){if(e){const o=ciudades.find(o=>o.nombre===e);if(o){const e=document.getElementById("ciudadSelect");e&&(e.value=o.id,e.setAttribute("value",o.id),e.value,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.style.backgroundColor="#e8f5e8",e.style.border="2px solid #28a745",setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},2e3),setTimeout(()=>{"function"==typeof cargarComplejos&&cargarComplejos(o.id)},500),o.id)}}o&&setTimeout(()=>{const n=complejos.find(e=>e.nombre===o);if(complejos.length,n){const e=document.getElementById("complejoSelect");e&&(e.value=n.id,e.setAttribute("value",n.id),e.value,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.style.backgroundColor="#e8f5e8",e.style.border="2px solid #28a745",setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},2e3),n.id)}else setTimeout(()=>{preRellenarPC(e,o)},3e3)},2e3)}function detectarEstadoDatos(){const e={ciudadesCargadas:ciudades&&ciudades.length>0,complejosCargados:complejos&&complejos.length>0,ciudadSelectDisponible:!!document.getElementById("ciudadSelect"),complejoSelectDisponible:!!document.getElementById("complejoSelect"),timestamp:Date.now()};return e}function preRellenarInteligente(e,o){const n=detectarEstadoDatos();if(n.ciudadesCargadas&&n.ciudadSelectDisponible)return void preRellenarInmediato(e,o);let t=0;const a=()=>{t++;const n=detectarEstadoDatos();n.ciudadesCargadas&&n.ciudadSelectDisponible?preRellenarInmediato(e,o):t<20?setTimeout(a,500):preRellenarForzado(e,o)};a()}function preRellenarInmediato(e,o){if(e){const n=ciudades.find(o=>o.nombre===e);if(n){const e=document.getElementById("ciudadSelect");e&&(n.id,e.value=n.id,e.selectedIndex=Array.from(e.options).findIndex(e=>e.value==n.id),e.style.display="none",e.offsetHeight,e.style.display="",["change","input","blur"].forEach(o=>{e.dispatchEvent(new Event(o,{bubbles:!0}))}),e.value,!o||complejos&&0!==complejos.length||cargarComplejos(n.id),setTimeout(()=>{if(o){const e=complejos.find(e=>e.nombre===o);if(e){const o=document.getElementById("complejoSelect");o&&(e.id,o.value=e.id,o.selectedIndex=Array.from(o.options).findIndex(o=>o.value==e.id),o.style.display="none",o.offsetHeight,o.style.display="",["change","input","blur"].forEach(e=>{o.dispatchEvent(new Event(e,{bubbles:!0}))}),o.value)}}},100))}}}function preRellenarForzado(e,o){"function"==typeof cargarCiudades&&cargarCiudades(),setTimeout(()=>{preRellenarInmediato(e,o)},1e3)}function preRellenarMovilAgresivo(e,o){if(e){const n=ciudades.find(o=>o.nombre===e);if(n){const e=document.getElementById("ciudadSelect");e&&(n.id,e.value=n.id,e.selectedIndex=Array.from(e.options).findIndex(e=>e.value==n.id),e.style.display="none",setTimeout(()=>{e.style.display="",e.value=n.id,e.selectedIndex=Array.from(e.options).findIndex(e=>e.value==n.id)},10),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0})),e.value,setTimeout(()=>{if(o){const e=complejos.find(e=>e.nombre===o);if(e){const o=document.getElementById("complejoSelect");o&&(e.id,o.value=e.id,o.selectedIndex=Array.from(o.options).findIndex(o=>o.value==e.id),o.style.display="none",setTimeout(()=>{o.style.display="",o.value=e.id,o.selectedIndex=Array.from(o.options).findIndex(o=>o.value==e.id)},10),o.dispatchEvent(new Event("change",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("blur",{bubbles:!0})),o.value)}}},200))}}}function preRellenarSimple(e,o){const n=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=n?300:1e3;if(e){const n=ciudades.find(o=>o.nombre===e);if(n){const e=document.getElementById("ciudadSelect");e&&(e.value=n.id,e.dispatchEvent(new Event("change",{bubbles:!0})),n.id,setTimeout(()=>{if(o){const e=complejos.find(e=>e.nombre===o);if(e){const o=document.getElementById("complejoSelect");o&&(o.value=e.id,o.dispatchEvent(new Event("change",{bubbles:!0})),e.id)}}},t))}}}function preRellenarUltraAgresivo(e,o){const n=document.getElementById("ciudadSelect"),t=document.getElementById("complejoSelect");if(e&&n){const o=ciudades.find(o=>o.nombre===e);o&&(n.style.display="none",setTimeout(()=>{n.style.display="",n.value=o.id,n.selectedIndex=Array.from(n.options).findIndex(e=>e.value==o.id),n.dispatchEvent(new Event("change",{bubbles:!0})),o.id},100))}if(o&&t){const e=complejos.find(e=>e.nombre===o);e&&(t.style.display="none",setTimeout(()=>{t.style.display="",t.value=e.id,t.selectedIndex=Array.from(t.options).findIndex(o=>o.value==e.id),t.dispatchEvent(new Event("change",{bubbles:!0})),e.id},100))}}let preRellenadoEjecutado=!1;async function preRellenarDesdeURL(){if(preRellenadoEjecutado)return;const{ciudad:e,complejo:o}=leerParametrosURL();(e||o)&&(preRellenadoEjecutado=!0,await preRellenarDesdeURLMejorado())}async function mantenerComplejoSeleccionado(){const e=document.getElementById("complejoSelect");if(!e||!e.value)return;const o=e.value;let n=0;const t=setInterval(()=>{n++,n>=20?clearInterval(t):""===e.value&&""!==o&&(e.value=o,e.style.backgroundColor="#fff3cd",e.style.border="2px solid #ffc107",setTimeout(()=>{e.style.backgroundColor="",e.style.border=""},1e3))},500)}function preRellenarDesdeURLLegacy_DESACTIVADO(){const{ciudad:e,complejo:o}=leerParametrosURL()}async function preRellenarDesdeURLMejorado(){const{ciudad:e,complejo:o}=leerParametrosURL();if(e||o)try{if(e){const n=ciudades.find(o=>o.nombre===e);if(n){const e=document.getElementById("ciudadSelect");if(e){if(e.value=n.id,e.dispatchEvent(new Event("change",{bubbles:!0})),n.id,o){await cargarComplejos(n.id);const e=complejos.find(e=>e.nombre===o);if(e){const o=document.getElementById("complejoSelect");if(o){if(o.value=e.id,complejoSeleccionado=e,o.dispatchEvent(new Event("change",{bubbles:!0})),o.style.backgroundColor="#e8f5e8",o.style.border="2px solid #28a745",setTimeout(()=>{o.style.backgroundColor="",o.style.border=""},2e3),e.id,mantenerComplejoSeleccionado(),"Complejo En Desarrollo"===e.nombre||"Fundaci√≥n Gunnen"===e.nombre||"Espacio Deportivo Borde R√≠o"===e.nombre||"Complejo Demo 1"===e.nombre){e.nombre;const o=document.getElementById("futbol");if(o){o.checked=!0,tipoCanchaSeleccionado="futbol";const e=document.getElementById("padel");e&&(e.parentElement.style.display="none"),document.getElementById("futbol").parentElement.style.display="block";const n=document.getElementById("step3").querySelector(".card-body");n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.textAlign="center";const t=document.querySelector('label[for="futbol"]');t&&(t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="flex-start",t.style.gap="15px",t.style.margin="0 auto",t.style.width="fit-content"),mostrarPaso(3),o.dispatchEvent(new Event("change",{bubbles:!0}))}}else mostrarPaso(3);setTimeout(()=>{const e=document.getElementById("disponibilidad");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},500)}else console.error("‚ùå Elemento complejoSelect no encontrado")}else console.error("‚ùå Complejo no encontrado:",o),complejos.map(e=>e.nombre)}}else console.error("‚ùå Elemento ciudadSelect no encontrado")}else console.error("‚ùå Ciudad no encontrada:",e),ciudades.map(e=>e.nombre)}}catch(e){console.error("‚ùå Error en preRellenarDesdeURLMejorado:",e)}}async function testConnectivity(){try{const e=await fetch(`${API_BASE}/ciudades`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},mode:"cors",cache:"no-cache"});if(e.ok){await e.json();return!0}return console.error("‚ùå Test de conectividad fall√≥ - HTTP:",e.status),!1}catch(e){return console.error("‚ùå Test de conectividad fall√≥:",e),console.error("üîç Detalles del error:",{name:e.name,message:e.message,stack:e.stack}),mostrarNotificacion(`Error de conexi√≥n: ${e.message}`,"warning"),!1}}async function verificarDisponibilidadCancha(e,o,n){try{const t=Date.now(),a=await fetch(`${API_BASE}/disponibilidad-completa/${e}/${o}?t=${t}`),i=await a.json(),c=i.reservas||[],s=i.bloqueos||[],r=n,l=calcularHoraFin(n);for(const e of c)if(haySuperposicionHorarios(r,l,e.hora_inicio,e.hora_fin))return e.hora_inicio,e.hora_fin,{disponible:!1,tipo:"reserva_existente",conflicto:e};for(const e of s)if(haySuperposicionHorarios(r,l,e.hora_inicio,e.hora_fin))return e.hora_inicio,e.hora_fin,e.session_id,{disponible:!1,tipo:"bloqueo_temporal",conflicto:e};return{disponible:!0}}catch(e){return console.error("Error verificando disponibilidad:",e),{disponible:!1,error:e.message}}}function haySuperposicionHorarios(e,o,n,t){const a=timeToMinutes(e),i=timeToMinutes(o),c=timeToMinutes(n);return a<timeToMinutes(t)&&(0===i?1440:i)>c}async function bloquearReservaTemporal(e,o,n,t){try{const a=await fetch(`${API_BASE}/reservas/bloquear`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cancha_id:e,fecha:o,hora_inicio:n,hora_fin:t,session_id:sessionId})}),i=await a.json();return a.ok&&i.success?(bloqueoTemporal={id:i.bloqueoId,cancha_id:e,fecha:o,hora_inicio:n,hora_fin:t,expira_en:i.expiraEn},configurarLimpiezaBloqueo(),{success:!0,bloqueo:bloqueoTemporal}):(console.error("‚ùå Error bloqueando reserva:",i.error),{success:!1,error:i.error,conflicto:i.conflicto})}catch(e){return console.error("‚ùå Error en bloqueo temporal:",e),{success:!1,error:e.message}}}async function liberarBloqueoTemporal(){if(bloqueoTemporal)try{bloqueoTemporal.id;(await fetch(`${API_BASE}/reservas/bloquear/${bloqueoTemporal.id}`,{method:"DELETE"})).ok||console.error("‚ö†Ô∏è Error liberando bloqueo temporal")}catch(e){console.error("‚ùå Error liberando bloqueo temporal:",e)}finally{bloqueoTemporal=null}}function configurarLimpiezaBloqueo(){bloqueoTemporal&&(window.addEventListener("beforeunload",liberarBloqueoTemporal),setTimeout(()=>{bloqueoTemporal&&liberarBloqueoTemporal()},18e4))}function tieneBloqueoActivo(){return null!==bloqueoTemporal}function mostrarError(e){let o=document.getElementById("error-message");o||(o=document.createElement("div"),o.id="error-message",o.className="alert alert-danger alert-dismissible fade show",o.style.position="fixed",o.style.top="20px",o.style.right="20px",o.style.zIndex="9999",o.style.maxWidth="400px",document.body.appendChild(o)),o.innerHTML=`\n        <strong>Error:</strong> ${e}\n        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n    `,setTimeout(()=>{o&&o.parentNode&&o.remove()},5e3),console.error("‚ùå Error mostrado al usuario:",e)}function actualizarEstadoCancha(e,o){const n=document.querySelector(`[data-cancha-id="${e}"]`);if(n)if(o){n.classList.remove("ocupada"),n.classList.add("disponible"),n.style.pointerEvents="auto",n.style.opacity="1";const e=n.querySelector(".estado-disponibilidad .badge");e&&(e.className="badge bg-success",e.textContent="Disponible")}else{n.classList.remove("disponible"),n.classList.add("ocupada"),n.style.pointerEvents="none",n.style.opacity="0.6";const e=n.querySelector(".estado-disponibilidad .badge");e&&(e.className="badge bg-danger",e.textContent="Ocupada")}}async function verificarDisponibilidadTiempoReal(){const e=document.getElementById("fechaSelect").value,o=document.getElementById("horaSelect").value;if(!e||!canchas.length)return;const n=canchas[0]?.complejo_id;if(n)try{const t=await verificarDisponibilidadCompleta(n,e);if(o)for(const e of canchas){const n=verificarDisponibilidadCanchaOptimizada(e.id,o,t);actualizarEstadoCancha(e.id,n)}await actualizarHorariosConDisponibilidad()}catch(e){console.error("Error verificando disponibilidad en tiempo real:",e)}else console.error("No se pudo obtener el ID del complejo")}async function verificarTodasCanchasOcupadas(e,o){if(!canchas.length)return!1;canchas.length;let n=!0;for(const e of canchas){const t=verificarDisponibilidadCanchaOptimizada(e.id,o,disponibilidadCompleta);if(e.id,e.nombre,t){n=!1;break}}return n}async function verificarDisponibilidadCompleta(e,o){try{if(API_BASE,!API_BASE)throw console.error("‚ùå API_BASE no est√° definido en verificarDisponibilidadCompleta!"),new Error("API_BASE no est√° definido");const n=Date.now(),t=`${API_BASE}/disponibilidad-completa/${e}/${o}?t=${n}`,a=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},mode:"cors",cache:"no-cache"});if(a.status,!a.ok)throw new Error(`HTTP error! status: ${a.status}, statusText: ${a.statusText}`);const i=await a.json();return Object.keys(i).length,JSON.stringify(i,null,2),i}catch(n){return console.error("‚ùå Error verificando disponibilidad completa:",n),await verificarDisponibilidadFallback(e,o)}}async function verificarDisponibilidadFallback(e,o){const n={};for(const e of canchas)try{const t=await fetch(`${API_BASE}/disponibilidad/${e.id}/${o}`),a=await t.json();n[e.id]={cancha_id:e.id,cancha_nombre:e.nombre,cancha_tipo:e.tipo,reservas:a}}catch(o){console.error(`Error verificando cancha ${e.id}:`,o),n[e.id]={cancha_id:e.id,cancha_nombre:e.nombre,cancha_tipo:e.tipo,reservas:[]}}return n}function verificarDisponibilidadCanchaOptimizada(e,o,n){if(Object.keys(n),!n[e])return!0;const t=n[e],a=o,i=calcularHoraFin(o);for(const e of t.reservas||[])if(haySuperposicionHorarios(a,i,e.hora_inicio,e.hora_fin))return e.hora_inicio,e.hora_fin,!1;for(const e of t.bloqueos||[])if(haySuperposicionHorarios(a,i,e.hora_inicio,e.hora_fin))return e.hora_inicio,e.hora_fin,e.session_id,!1;return!0}function validarRUT(e){if((e=e.replace(/[^0-9kK]/g,"")).length<8)return!1;const o=e.slice(0,-1),n=e.slice(-1).toUpperCase();if(!/^\d+$/.test(o))return!1;if(!/^[0-9kK]$/.test(n))return!1;let t=0,a=2;for(let e=o.length-1;e>=0;e--)t+=parseInt(o[e])*a,a=7===a?2:a+1;const i=t%11;return n===(0===i?"0":1===i?"K":(11-i).toString())}function validarNombre(e){if(!e||"string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;if(e.length<2)return!1;if(!e.includes(" "))return!1;return/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]+$/.test(e)}function validarEmail(e){if(!e||"string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function validarTelefono(e){if(!e||"string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;return[/^\+569\d{8}$/,/^569\d{8}$/,/^9\d{8}$/,/^2\d{8}$/,/^3\d{8}$/].some(o=>o.test(e))}function formatearRUT(e){if((e=e.replace(/[^0-9kK]/g,"")).length<2)return e;if(e.length<8)return e.replace(/\B(?=(\d{3})+(?!\d))/g,".");const o=e.slice(0,-1),n=e.slice(-1).toUpperCase();return`${o.replace(/\B(?=(\d{3})+(?!\d))/g,".")}-${n}`}function configurarFechaMinima(){const e=document.getElementById("fechaSelect");if(!e)return void console.error("‚ùå No se encontr√≥ el elemento fechaSelect");const o=(new Date).toLocaleDateString("en-CA",{timeZone:"America/Santiago"});e.min=o,e.setAttribute("min",o),e.value||(e.value=o),e.addEventListener("change",function(){const e=this.value;if(e&&e<o){console.warn("‚ö†Ô∏è Fecha pasada seleccionada:",e,"Corrigiendo a:",o),this.value=o;const n=document.createElement("div");n.className="alert alert-warning alert-dismissible fade show",n.innerHTML='\n                <i class="fas fa-exclamation-triangle me-2"></i>\n                <strong>Fecha no v√°lida:</strong> No puedes seleccionar fechas pasadas. Se ha establecido la fecha de hoy.\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            ';const t=this.closest(".date-time-selector");t&&(t.appendChild(n),setTimeout(()=>{n.parentNode&&n.remove()},5e3))}}),e.addEventListener("input",function(){this.value&&this.value<o?this.classList.add("fecha-invalida"):this.classList.remove("fecha-invalida")}),e.value}function asegurarValoresVisibles(){const e=document.getElementById("fechaSelect"),o=document.getElementById("horaSelect");e&&e.value&&(e.style.color="#155724",e.style.fontWeight="700",e.style.fontSize="1.4rem",e.style.backgroundColor="#e8f5e8",e.style.borderColor="#28a745",e.style.opacity="1",e.style.visibility="visible"),o&&o.value&&(o.style.color="#155724",o.style.fontWeight="700",o.style.fontSize="1.4rem",o.style.backgroundColor="#e8f5e8",o.style.borderColor="#28a745",o.style.opacity="1",o.style.visibility="visible")}function configurarEventListeners(){const e=document.getElementById("reservarAhoraBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),scrollToReservar()});document.getElementById("fechaSelect"),document.getElementById("horaSelect");const o=document.getElementById("hoyBtn");o&&o.addEventListener("click",function(){const e=document.getElementById("fechaSelect"),o=(new Date).toLocaleDateString("en-CA",{timeZone:"America/Santiago"});e.value=o,e.dispatchEvent(new Event("change")),this.innerHTML='<i class="fas fa-check"></i>',this.classList.add("btn-success"),this.classList.remove("btn-outline-primary"),setTimeout(()=>{this.innerHTML='<i class="fas fa-calendar-check"></i>',this.classList.remove("btn-success"),this.classList.add("btn-outline-primary")},1500)}),document.getElementById("ciudadSelect").addEventListener("change",function(){const e=this.value;if(e){cargarComplejos(e),mostrarPaso(2),document.getElementById("padel").parentElement.style.display="block",document.getElementById("futbol").parentElement.style.display="block";const o=document.getElementById("step3").querySelector(".card-body");o.style.display="",o.style.justifyContent="",o.style.alignItems="",o.style.textAlign="";const n=document.querySelector('label[for="futbol"]');n&&(n.style.display="",n.style.alignItems="",n.style.justifyContent="",n.style.gap="",n.style.margin="",n.style.width=""),document.querySelectorAll('input[name="tipoCancha"]').forEach(e=>{e.checked=!1}),tipoCanchaSeleccionado=null}else ocultarPaso(2),ocultarPaso(3),ocultarPaso(4)}),document.getElementById("complejoSelect").addEventListener("change",async function(){const e=this.value;if(e)if(complejoSeleccionado=complejos.find(o=>o.id==e),await cargarHorariosComplejo(complejoSeleccionado),complejoSeleccionado.nombre,"Complejo En Desarrollo"===complejoSeleccionado.nombre||"Fundaci√≥n Gunnen"===complejoSeleccionado.nombre||"Espacio Deportivo Borde R√≠o"===complejoSeleccionado.nombre||"Complejo Demo 1"===complejoSeleccionado.nombre){complejoSeleccionado.nombre;const e=document.getElementById("futbol");e.checked=!0,tipoCanchaSeleccionado="futbol",document.getElementById("padel").parentElement.style.display="none",document.getElementById("futbol").parentElement.style.display="block";const o=document.getElementById("step3").querySelector(".card-body");o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.textAlign="center";const n=document.querySelector('label[for="futbol"]');n&&(n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="flex-start",n.style.gap="15px",n.style.margin="0 auto",n.style.width="fit-content"),complejoSeleccionado.nombre,setTimeout(async()=>{complejoSeleccionado.nombre,await cargarCanchas(complejoSeleccionado.id,tipoCanchaSeleccionado,!1);document.getElementById("fechaSelect").value&&await actualizarHorariosConDisponibilidad()},200),e.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(()=>{const e=document.getElementById("step4");e.style.display,"none"===e.style.display&&mostrarPaso(4)},100),await validarHorariosSegunFecha()}else{document.getElementById("padel").parentElement.style.display="block",document.getElementById("futbol").parentElement.style.display="block";const e=document.getElementById("step3").querySelector(".card-body");e.style.display="",e.style.justifyContent="",e.style.alignItems="",e.style.textAlign="";const o=document.querySelector('label[for="futbol"]');o&&(o.style.display="",o.style.alignItems="",o.style.justifyContent="",o.style.gap="",o.style.margin="",o.style.width=""),document.querySelectorAll('input[name="tipoCancha"]').forEach(e=>{e.checked=!1}),tipoCanchaSeleccionado=null,mostrarPaso(3)}else ocultarPaso(3),ocultarPaso(4)}),document.querySelectorAll('input[name="tipoCancha"]').forEach(e=>{e.addEventListener("change",function(){this.value,!complejoSeleccionado||"Complejo En Desarrollo"!==complejoSeleccionado.nombre&&"Complejo Demo 1"!==complejoSeleccionado.nombre||"futbol"===this.value?(tipoCanchaSeleccionado=this.value,mostrarPaso(4),complejoSeleccionado&&tipoCanchaSeleccionado&&setTimeout(async()=>{await cargarCanchas(complejoSeleccionado.id,tipoCanchaSeleccionado,!1);document.getElementById("fechaSelect").value&&await actualizarHorariosConDisponibilidad()},100),setTimeout(()=>{document.getElementById("step4").style.display},50)):complejoSeleccionado.nombre})});const n=document.getElementById("verDisponibilidad");n&&(n.style.display,n.offsetParent),n.addEventListener("click",async function(){complejoSeleccionado&&tipoCanchaSeleccionado&&(await mostrarSeccionDisponibilidad(),await cargarHorariosBasicos())}),document.getElementById("fechaSelect").addEventListener("change",async function(){if(this.value){this.classList.add("fecha-seleccionada"),this.style.color="#155724",this.style.fontWeight="700",this.style.backgroundColor="#e8f5e8",this.style.borderColor="#28a745";const e=this.closest(".date-time-selector");e&&e.style.setProperty("--icon-bg","#28a745")}else{this.classList.remove("fecha-seleccionada"),this.style.color="",this.style.fontWeight="",this.style.backgroundColor="",this.style.borderColor="";const e=this.closest(".date-time-selector");e&&e.style.setProperty("--icon-bg","#667eea")}verificarDisponibilidadTiempoReal(),await validarHorariosSegunFecha(),complejoSeleccionado&&tipoCanchaSeleccionado?setTimeout(async()=>{await cargarCanchas(complejoSeleccionado.id,tipoCanchaSeleccionado,!1),await actualizarHorariosConDisponibilidad()},200):canchas.length>0&&await renderizarCanchasConDisponibilidad(),setTimeout(()=>{this.blur()},100)}),document.getElementById("horaSelect").addEventListener("change",async function(){const e=this.value;if(this.value){this.classList.add("hora-seleccionada"),this.style.color="#155724",this.style.fontWeight="700",this.style.backgroundColor="#e8f5e8",this.style.borderColor="#28a745";const e=this.closest(".date-time-selector");e&&e.style.setProperty("--icon-bg","#28a745")}else{this.classList.remove("hora-seleccionada"),this.style.color="",this.style.fontWeight="",this.style.backgroundColor="",this.style.borderColor="";const e=this.closest(".date-time-selector");e&&e.style.setProperty("--icon-bg","#667eea")}if(verificarDisponibilidadTiempoReal(),complejoSeleccionado&&tipoCanchaSeleccionado&&this.value){const o=document.getElementById("fechaSelect").value;if(o)try{let n;n="Complejo Demo 3"===complejoSeleccionado.nombre?`${API_BASE}/canchas/${complejoSeleccionado.id}?fecha=${o}&hora=${e}`:`${API_BASE}/canchas/${complejoSeleccionado.id}/${tipoCanchaSeleccionado}?fecha=${o}&hora=${e}`;const t=await fetch(n);canchas=await t.json()}catch(e){console.error("Error recargando canchas con promociones:",e)}}canchas.length>0?await renderizarCanchasConDisponibilidad():complejoSeleccionado&&tipoCanchaSeleccionado&&this.value&&await cargarCanchas(complejoSeleccionado.id,tipoCanchaSeleccionado,!0)}),document.getElementById("buscarReserva").addEventListener("click",buscarReserva),document.getElementById("confirmarReserva").addEventListener("click",confirmarReserva);const t=document.getElementById("pagarMitad");t&&t.addEventListener("change",function(){actualizarResumenPrecio()});const a=document.getElementById("rutCliente");a&&(window.rutUsuarioHaInteractuado=!1,a.addEventListener("input",function(){window.rutUsuarioHaInteractuado=!0;const e=this.value,o=formatearRUT(e);if(o!==e&&(this.value=o),window.rutUsuarioHaInteractuado&&e.length>0)if(e.length>=8){if(validarRUT(e)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}else if(0===e.length){this.classList.remove("is-valid","is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.add("d-none")}}),a.addEventListener("blur",function(){if(!window.rutUsuarioHaInteractuado)return;const e=this.value;if(e.length>=8){if(!validarRUT(e)){this.classList.add("is-invalid"),this.classList.remove("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}else if(e.length>0){this.classList.add("is-invalid"),this.classList.remove("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}else{this.classList.remove("is-valid","is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.add("d-none")}}),a.addEventListener("focus",function(){0===this.value.length&&this.classList.remove("is-valid","is-invalid")}));const i=document.getElementById("emailCliente");i&&(window.emailUsuarioHaInteractuado=!1,i.addEventListener("input",function(){window.emailUsuarioHaInteractuado=!0;const e=this.value;if(window.emailUsuarioHaInteractuado&&e.length>0){if(validarEmail(e)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}else if(0===e.length){this.classList.remove("is-valid","is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.add("d-none")}}),i.addEventListener("blur",function(){if(!window.emailUsuarioHaInteractuado)return;const e=this.value;if(e.length>0){if(!validarEmail(e)){this.classList.add("is-invalid"),this.classList.remove("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}else{this.classList.remove("is-valid","is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.add("d-none")}}),i.addEventListener("focus",function(){0===this.value.length&&this.classList.remove("is-valid","is-invalid")}));const c=document.getElementById("nombreCliente");c&&(window.nombreUsuarioHaInteractuado=!1,c.addEventListener("input",function(){window.nombreUsuarioHaInteractuado=!0;const e=this.value;if(window.nombreUsuarioHaInteractuado){if(validarNombre(e)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}}),c.addEventListener("blur",function(){if(!window.nombreUsuarioHaInteractuado)return;if(validarNombre(this.value)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.add("is-invalid"),this.classList.remove("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}),c.addEventListener("focus",function(){0===this.value.length&&this.classList.remove("is-valid","is-invalid")}));const s=document.getElementById("telefonoCliente");s&&(window.telefonoUsuarioHaInteractuado=!1,s.addEventListener("input",function(){window.telefonoUsuarioHaInteractuado=!0;const e=this.value;if(window.telefonoUsuarioHaInteractuado){if(validarTelefono(e)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}}),s.addEventListener("blur",function(){if(!window.telefonoUsuarioHaInteractuado)return;if(validarTelefono(this.value)){this.classList.remove("is-invalid"),this.classList.add("is-valid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.remove("d-none"),o&&o.classList.add("d-none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const e=this.parentNode.querySelector(".valid-feedback"),o=this.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none"),o&&o.classList.remove("d-none")}}),s.addEventListener("focus",function(){0===this.value.length&&this.classList.remove("is-valid","is-invalid")}))}function mostrarPaso(e){const o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);for(let n=1;n<=4;n++){const t=document.getElementById(`step${n}`);n<=e?(t.style.display="block",o?(t.style.opacity="1",t.style.transition="none"):t.classList.add("fade-in")):t.style.display="none"}document.getElementById(`step${e}`).style.display}function ocultarPaso(e){for(let o=e;o<=4;o++){document.getElementById(`step${o}`).style.display="none"}}async function mostrarSeccionDisponibilidad(){if(document.getElementById("disponibilidad").style.display="block",complejoSeleccionado&&tipoCanchaSeleccionado){complejoSeleccionado.nombre;try{const e=document.getElementById("fechaSelect").value,o=document.getElementById("horaSelect").value;let n=`${API_BASE}/canchas/${complejoSeleccionado.id}/${tipoCanchaSeleccionado}`;e&&o&&(n+=`?fecha=${e}&hora=${o}`);const t=await fetch(n);canchas=await t.json(),canchas.length,canchas.map(e=>e.nombre),await actualizarHorariosConDisponibilidad()}catch(e){console.error("‚ùå Error validando disponibilidad:",e)}}document.getElementById("disponibilidad").scrollIntoView({behavior:"smooth"})}async function cargarCiudades(){let e=0;for(;e<3;)try{e++,API_BASE;const o=await fetch(`${API_BASE}/ciudades`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(o.status,o.headers,!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();if(!Array.isArray(n))throw new Error("Los datos recibidos no son un array de ciudades");ciudades=n;const t=document.getElementById("ciudadSelect");if(!t)throw new Error("No se encontr√≥ el elemento select de ciudades");return t.innerHTML='<option value="">Selecciona una ciudad...</option>',ciudades.forEach(e=>{const o=document.createElement("option");o.value=e.id,o.textContent=e.nombre,t.appendChild(o)}),ciudades.length,ciudades}catch(o){if(console.error(`‚ùå Error en intento ${e}/3 cargando ciudades:`,o),console.error("üîó URL intentada:",`${API_BASE}/ciudades`),console.error("üåç Hostname actual:",window.location.hostname),console.error("üîó API_BASE configurado:",API_BASE),!(e<3)){let e="Error al cargar las ciudades";return"TypeError"===o.name&&o.message.includes("fetch")?e="Error de conexi√≥n: No se pudo conectar al servidor":o.message.includes("HTTP error")&&(e=`Error del servidor: ${o.message}`),mostrarNotificacion(e,"danger"),[]}await new Promise(e=>setTimeout(e,2e3))}}async function cargarComplejos(e){let o=0;for(;o<3;)try{o++;const n=await fetch(`${API_BASE}/complejos/${e}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(n.status,!n.ok)throw new Error(`HTTP error! status: ${n.status}`);if(complejos=await n.json(),!Array.isArray(complejos))throw new Error("Los datos recibidos no son un array de complejos");const t=document.getElementById("complejoSelect");if(!t)throw new Error("No se encontr√≥ el elemento select de complejos");t.innerHTML='<option value="">Selecciona un complejo...</option>',complejos.forEach(e=>{const o=document.createElement("option");o.value=e.id,o.textContent=e.nombre,t.appendChild(o)}),complejos.length,complejos.map(e=>`${e.nombre} (ID: ${e.id})`);const a=new CustomEvent("complejosCargados",{detail:{ciudadId:e,complejos:complejos}});return document.dispatchEvent(a),complejos}catch(n){if(console.error(`‚ùå Error en intento ${o}/3 cargando complejos:`,n),console.error("üîó URL intentada:",`${API_BASE}/complejos/${e}`),console.error("üåç Hostname actual:",window.location.hostname),console.error("üîó API_BASE configurado:",API_BASE),!(o<3)){let e="Error al cargar los complejos";return"TypeError"===n.name&&n.message.includes("fetch")?e="Error de conexi√≥n: No se pudo conectar al servidor":n.message.includes("HTTP error")&&(e=`Error del servidor: ${n.message}`),mostrarNotificacion(e,"danger"),[]}await new Promise(e=>setTimeout(e,2e3))}}async function cargarCanchas(e,o,n=!0){if(API_BASE,!API_BASE)return console.error("‚ùå API_BASE no est√° definido!"),void mostrarNotificacion("Error de configuraci√≥n: API_BASE no est√° definido","danger");try{let t;t=complejoSeleccionado&&"Complejo Demo 3"===complejoSeleccionado.nombre?`${API_BASE}/canchas/${e}`:`${API_BASE}/canchas/${e}/${o}`;const a=document.getElementById("fechaSelect")?.value,i=document.getElementById("horaSelect")?.value;a&&(t+=`?fecha=${a}`,i&&(t+=`&hora=${i}`));const c=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},mode:"cors",cache:"no-cache"});if(c.status,c.headers.entries(),!c.ok)throw new Error(`HTTP error! status: ${c.status}, statusText: ${c.statusText}`);canchas=await c.json();const s=canchas.filter(e=>e.tiene_promocion);s.length>0&&s.map(e=>({cancha:e.nombre,precioOriginal:e.precio_original,precioPromocional:e.precio_actual,descuento:e.promocion_info?.porcentaje_descuento+"%"})),n&&await renderizarCanchasConDisponibilidad();document.getElementById("fechaSelect").value&&complejoSeleccionado&&await actualizarHorariosConDisponibilidad()}catch(e){console.error("‚ùå Error en cargarCanchas:",e),mostrarNotificacion("Error al cargar las canchas","danger")}}async function actualizarHorariosConDisponibilidad(){if(!complejoSeleccionado||!canchas.length)return;const e=document.getElementById("horaSelect");let o=document.getElementById("fechaSelect").value;if(!o){const e=(new Date).toLocaleDateString("en-CA",{timeZone:"America/Santiago"});o=e}const n=Array.from(e.options);n.length;const t=await verificarDisponibilidadCompleta(complejoSeleccionado.id,o);window.disponibilidadCompleta=t;for(const e of n)if(e.value&&""!==e.value){e.value;let o=!0;for(const n of canchas){const a=verificarDisponibilidadCanchaOptimizada(n.id,e.value,t);if(n.id,n.nombre,a){o=!1;break}}e.value,o?(e.textContent=`${e.value} (Todas ocupadas)`,e.classList.add("hora-todas-ocupadas"),e.style.textDecoration="line-through",e.style.color="#dc3545",e.value):(e.textContent=e.value,e.classList.remove("hora-todas-ocupadas"),e.style.textDecoration="",e.style.color="",e.value)}}async function cargarHorariosComplejo(e){const o=document.getElementById("horaSelect");o.innerHTML='<option value="">Selecciona una hora...</option>';let n=[];if("Complejo En Desarrollo"===e.nombre){const e=document.getElementById("fechaSelect").value;if(e){const[o,t,a]=e.split("-").map(Number),i=new Date(o,t-1,a).getDay();n=0===i||6===i?["12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]}else n=["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]}else if("Fundaci√≥n Gunnen"===e.nombre){const e=document.getElementById("fechaSelect").value;if(e){const[o,t,a]=e.split("-").map(Number),i=new Date(o,t-1,a).getDay();n=0===i||6===i?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:["14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]}else n=["14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]}else n="Espacio Deportivo Borde R√≠o"===e.nombre?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:"Complejo Demo 1"===e.nombre?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:"Complejo Demo 3"===e.nombre?["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];const t=document.getElementById("fechaSelect").value;if(t)try{const a=await verificarDisponibilidadCompleta(e.id,t);Object.keys(a).length;for(const e of n){const n=document.createElement("option");n.value=e;let t=!0,i=0;if(canchas.length>0)for(const o of canchas){const n=verificarDisponibilidadCanchaOptimizada(o.id,e,a);if(i++,n){t=!1;break}}else for(const o in a){const n=verificarDisponibilidadCanchaOptimizada(parseInt(o),e,a);if(i++,n){t=!1;break}}t&&i>0?(n.textContent=`${e} (Todas ocupadas)`,n.classList.add("hora-todas-ocupadas"),n.style.textDecoration="line-through",n.style.color="#dc3545"):n.textContent=e,o.appendChild(n)}}catch(e){console.error("‚ùå Error obteniendo disponibilidad, cargando horarios b√°sicos:",e),n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,o.appendChild(n)})}else n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,o.appendChild(n)});if(t){const e=Array.from(o.options),n=e.filter(e=>{if(!e.value||""===e.value)return!0;const o=esHoraDisponibleParaReserva(e.value,t);return o||e.value,o});n.length!==e.length&&(o.innerHTML="",n.forEach(e=>{o.appendChild(e)}))}}async function cargarHorariosBasicos(){if(!complejoSeleccionado)return;const e=document.getElementById("horaSelect");if(!e)return;complejoSeleccionado.nombre;let o=[];const n=document.getElementById("fechaSelect").value;if("Complejo En Desarrollo"===complejoSeleccionado.nombre)if(n){const[e,t,a]=n.split("-").map(Number),i=new Date(e,t-1,a).getDay();o=0===i||6===i?["12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]}else o=["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];else if("Fundaci√≥n Gunnen"===complejoSeleccionado.nombre)if(n){const[e,t,a]=n.split("-").map(Number),i=new Date(e,t-1,a).getDay();o=0===i||6===i?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:["14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]}else o=["14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"];else o="Complejo Demo 1"===complejoSeleccionado.nombre?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:"Complejo Demo 3"===complejoSeleccionado.nombre?["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];if(n){const t=o.filter(e=>{const o=esHoraDisponibleParaReserva(e,n);return o});if(o=t,0===o.length)return void(e.innerHTML='<option value="">No hay horarios disponibles para hoy</option>')}e.innerHTML='<option value="">Selecciona una hora...</option>',o.forEach(o=>{const n=document.createElement("option");n.value=o,n.textContent=o,e.appendChild(n)}),n&&setTimeout(async()=>{await actualizarHorariosConDisponibilidad()},100)}async function cargarHorariosConDisponibilidadInmediata(){if(!complejoSeleccionado)return;const e=document.getElementById("fechaSelect").value;if(!e)return;const o=document.getElementById("horaSelect");if(!o)return;complejoSeleccionado.nombre;const[n,t,a]=e.split("-").map(Number),i=new Date(n,t-1,a).getDay();let c=[];c="Complejo En Desarrollo"===complejoSeleccionado.nombre?0===i||6===i?["12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:"Fundaci√≥n Gunnen"===complejoSeleccionado.nombre?0===i||6===i?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:["14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:"Complejo Demo 1"===complejoSeleccionado.nombre?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:"Complejo Demo 3"===complejoSeleccionado.nombre?["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];try{const n=await verificarDisponibilidadCompleta(complejoSeleccionado.id,e);Object.keys(n).length,window.disponibilidadCompleta=n,o.innerHTML='<option value="">Selecciona una hora...</option>';for(const e of c){const t=document.createElement("option");t.value=e;let a=!0,i=0;for(const o in n){const t=verificarDisponibilidadCanchaOptimizada(parseInt(o),e,n);if(i++,t){a=!1;break}}a&&i>0?(t.textContent=`${e} (Todas ocupadas)`,t.classList.add("hora-todas-ocupadas"),t.style.textDecoration="line-through",t.style.color="#dc3545"):(t.textContent=e,t.classList.remove("hora-todas-ocupadas"),t.style.textDecoration="",t.style.color=""),o.appendChild(t)}}catch(n){console.error("‚ùå cargarHorariosConDisponibilidadInmediata - Error:",n),console.error("‚ùå cargarHorariosConDisponibilidadInmediata - Error details:",n.message),o.innerHTML='<option value="">Selecciona una hora...</option>';c.filter(o=>{const n=esHoraDisponibleParaReserva(o,e);return n}).forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,o.appendChild(n)})}}async function validarHorariosSegunFecha(){if(!complejoSeleccionado)return;const e=document.getElementById("fechaSelect").value;if(!e)return;const[o,n,t]=e.split("-").map(Number),a=new Date(o,n-1,t).getDay(),i=document.getElementById("horaSelect"),c=i.value;if(c){let e=[];e="Complejo En Desarrollo"===complejoSeleccionado.nombre?0===a||6===a?["12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:"Complejo Demo 1"===complejoSeleccionado.nombre?["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"]:"Complejo Demo 3"===complejoSeleccionado.nombre?["16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"]:["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],e.includes(c)||(i.value="",mostrarNotificacion("El horario seleccionado no est√° disponible para esta fecha","warning"))}"Complejo En Desarrollo"===complejoSeleccionado.nombre?await cargarHorariosBasicos():cargarHorariosComplejo(complejoSeleccionado)}async function renderizarCanchasConDisponibilidad(){const e=document.getElementById("canchasGrid");if(!e)return void console.error("‚ùå No se encontr√≥ el elemento canchasGrid");e.innerHTML="";const o=document.getElementById("fechaSelect").value,n=document.getElementById("horaSelect").value;if(!complejoSeleccionado||"Complejo En Desarrollo"!==complejoSeleccionado.nombre&&"Fundaci√≥n Gunnen"!==complejoSeleccionado.nombre&&"Espacio Deportivo Borde R√≠o"!==complejoSeleccionado.nombre&&"Complejo Demo 1"!==complejoSeleccionado.nombre&&"Complejo Demo 3"!==complejoSeleccionado.nombre)for(const a of canchas){const i=document.createElement("div");i.dataset.canchaId=a.id,i.dataset.precio=a.precio_actual||a.precio_hora;const c="futbol"===a.tipo?"fa-futbol":"fa-table-tennis";let s=!0,r='<span class="badge bg-success">Disponible</span>',l="cancha-card disponible";if(o&&n){const u=document.getElementById("horaSelect"),m=u.options[u.selectedIndex];if(m&&m.textContent.includes("(Todas ocupadas)"))l="cancha-card ocupada",r='<span class="badge bg-danger">Ocupada</span>',a.nombre;else try{const p=Date.now(),h=await fetch(`${API_BASE}/disponibilidad/${a.id}/${o}?t=${p}`);s=!(await h.json()).reservas.some(e=>{const o=calcularHoraFin(n),t=timeToMinutes(e.hora_inicio),a=timeToMinutes(e.hora_fin),i=timeToMinutes(n);return t<timeToMinutes(o)&&a>i}),s?(l="cancha-card disponible",r='<span class="badge bg-success">Disponible</span>'):(l="cancha-card ocupada",r='<span class="badge bg-danger">Ocupada</span>')}catch(f){console.error("Error verificando disponibilidad de cancha:",a.id,f)}}i.className=l;let d="";d=a.tiene_promocion&&a.precio_actual<a.precio_original?`\n                    <p class="mb-1">\n                        <span class="text-decoration-line-through text-muted small">$${formatCurrencyChile(a.precio_original)}</span>\n                        <span class="text-success fw-bold ms-2">$${formatCurrencyChile(a.precio_actual)}</span>\n                        <span class="badge bg-success ms-1">${a.promocion_info?.porcentaje_descuento}% OFF</span>\n                    </p>\n                    <p class="text-muted small mb-0">por hora</p>\n                `:`<p class="text-muted">$${formatCurrencyChile(a.precio_actual||a.precio_hora)} por hora</p>`,i.innerHTML=`\n                <div class="cancha-icon">\n                    <i class="fas ${c}"></i>\n                </div>\n                <h5>${a.nombre}</h5>\n                ${d}\n                <div class="estado-disponibilidad">\n                    ${r}\n                </div>\n            `,i.addEventListener("click",()=>seleccionarCancha(a)),e.appendChild(i)}else{complejoSeleccionado.nombre,canchas.length;const v="Complejo En Desarrollo"===complejoSeleccionado.nombre,b="Complejo En Desarrollo"===complejoSeleccionado.nombre?"MONTE PERDIDO":"Fundaci√≥n Gunnen"===complejoSeleccionado.nombre?"DON VICTOR":"Complejo Demo 1"===complejoSeleccionado.nombre?"CALLE DEMO":"Complejo Demo 3"===complejoSeleccionado.nombre?"AV. RICARDO VICU√ëA":"RUTA Q-575",y=document.createElement("div");y.className=v?"galpon-container":"complejo-abierto-container",v||y.setAttribute("data-complejo",`COMPLEJO ${complejoSeleccionado.nombre.toUpperCase()}`);const g=document.createElement("div");g.className="calle-complejo",g.setAttribute("data-calle",b);const E=document.createElement("div");E.className="canchas-horizontales";let C=[...canchas];if("Complejo En Desarrollo"===complejoSeleccionado.nombre||"Fundaci√≥n Gunnen"===complejoSeleccionado.nombre||"Complejo Demo 1"===complejoSeleccionado.nombre?C=C.sort((e,o)=>parseInt(e.nombre.match(/\d+/)[0])-parseInt(o.nombre.match(/\d+/)[0])):"Complejo Demo 3"===complejoSeleccionado.nombre&&(C=C.sort((e,o)=>{if(e.tipo!==o.tipo)return"futbol"===e.tipo?-1:1;return parseInt(e.nombre.match(/\d+/)[0])-parseInt(o.nombre.match(/\d+/)[0])})),"Complejo Demo 3"===complejoSeleccionado.nombre){C.length;const S=document.createElement("div");S.className="demo3-container";document.createElement("div").className="demo3-layout-1";document.createElement("div").className="demo3-layout-2";for(const L of C){L.nombre,L.id,L.tipo,L.id,8===L.id||L.id;const j=await t(L,o,n);L.nombre;"futbol"===tipoCanchaSeleccionado&&"futbol"===L.tipo||"padel"===tipoCanchaSeleccionado&&"padel"===L.tipo||(j.classList.add("no-seleccionada"),j.style.pointerEvents="none",L.nombre),6===L.id||11===L.id?(j.classList.add("cancha-futbol"),futbolIzquierda.appendChild(j),L.nombre):7===L.id||12===L.id?(j.classList.add("cancha-futbol"),futbolDerecha.appendChild(j),L.nombre):8===L.id||13===L.id?(j.classList.add("demo3-cancha-horizontal"),cancha3Horizontal=j):9===L.id||14===L.id?(j.classList.add("cancha-padel"),padelSuperior.appendChild(j),L.nombre):10===L.id||15===L.id?(L.nombre,L.id):console.warn(`‚ö†Ô∏è Cancha ${L.nombre} (ID: ${L.id}) no fue asignada a ning√∫n contenedor`)}const w=document.createElement("div");w.className="demo3-futbol-superiores",w.appendChild(futbolIzquierda),w.appendChild(futbolDerecha),demo3ContainerInner.appendChild(w),demo3ContainerInner.appendChild(padelSuperior);let I=null;cancha3Horizontal?(I=document.createElement("div"),I.className="demo3-contenedor-cancha3",I.appendChild(cancha3Horizontal),demo3ContainerInner.appendChild(I)):console.warn("‚ö†Ô∏è Cancha 3 no fue encontrada"),demo3ContainerInner,w.children.length,demo3ContainerInner.children.length,window.innerWidth>768&&(demo3ContainerInner.style.display="grid",demo3ContainerInner.style.gridTemplateAreas='"futbol-sup padel" "cancha3 padel"',demo3ContainerInner.style.gridTemplateColumns="2fr 1fr",demo3ContainerInner.style.gridTemplateRows="auto auto",demo3ContainerInner.style.gap="20px",demo3ContainerInner.style.width="100%",demo3ContainerInner.style.maxWidth="100%",demo3ContainerInner.style.minHeight="500px",demo3ContainerInner.style.padding="20px",w.style.gridArea="futbol-sup",I&&(I.style.gridArea="cancha3"),padelSuperior.style.gridArea="padel"),E.style.display="flex",E.style.justifyContent="center",E.style.alignItems="center",E.style.width="100%",S.appendChild(demo3ContainerInner),E.appendChild(S),setTimeout(()=>{demo3ContainerInner.style.display="grid",demo3ContainerInner.style.gridTemplateAreas='"futbol-sup padel" "cancha3 padel"',demo3ContainerInner.style.gridTemplateColumns="2fr 1fr",demo3ContainerInner.style.gridTemplateRows="auto auto",demo3ContainerInner.style.gap="20px",demo3ContainerInner.style.maxWidth="100%",demo3ContainerInner.style.width="100%",demo3ContainerInner.style.margin="0 auto",demo3ContainerInner.style.padding="20px",demo3ContainerInner.style.boxSizing="border-box",E.style.display="flex",E.style.justifyContent="center",E.style.alignItems="center",E.style.width="100%",E.style.maxWidth="none",E.style.overflow="visible";const e=E.closest(".canchas-grid-expanded");e&&(e.style.maxWidth="none",e.style.width="100%",e.style.overflow="visible")},100)}else for(const T of C){const x=await t(T,o,n);E.appendChild(x)}async function t(e,o,n){const t=document.createElement("div");t.dataset.canchaId=e.id,t.dataset.precio=e.precio_actual||e.precio_hora;const a="futbol"===e.tipo?"fa-futbol":"fa-table-tennis";let i=!0,c='<span class="badge bg-success">Disponible</span>',s="cancha-card disponible";if(o&&n){const t=document.getElementById("horaSelect"),a=t.options[t.selectedIndex];if(a&&a.textContent.includes("(Todas ocupadas)"))s="cancha-card ocupada",c='<span class="badge bg-danger">Ocupada</span>',e.nombre;else{try{const t=Date.now(),a=await fetch(`${API_BASE}/disponibilidad/${e.id}/${o}?t=${t}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);i=!(await a.json()).reservas.some(e=>{const o=calcularHoraFin(n),t=timeToMinutes(e.hora_inicio),a=timeToMinutes(e.hora_fin),i=timeToMinutes(n);return t<timeToMinutes(o)&&a>i})}catch(o){console.error("‚ùå Error verificando disponibilidad de cancha:",e.id,o),i=!0}i?(s="cancha-card disponible",c='<span class="badge bg-success">Disponible</span>'):(s="cancha-card ocupada",c='<span class="badge bg-danger">Ocupada</span>')}}t.className=s;const r="Espacio Deportivo Borde R√≠o"===complejoSeleccionado.nombre?"5 jugadores por equipo":"Complejo Demo 3"===complejoSeleccionado.nombre&&"futbol"===e.tipo&&"Cancha 3"===e.nombre||"Complejo Demo 3"===complejoSeleccionado.nombre&&"futbol"===e.tipo?"7 jugadores por equipo":"Complejo Demo 3"===complejoSeleccionado.nombre&&"padel"===e.tipo?"2 jugadores<br>por equipo":"7 jugadores por equipo";let l="";l=e.tiene_promocion&&e.precio_actual<e.precio_original?`\n                    <p class="mb-1">\n                        <span class="text-decoration-line-through text-muted small">$${formatCurrencyChile(e.precio_original)}</span>\n                        <span class="text-success fw-bold ms-2">$${formatCurrencyChile(e.precio_actual)}</span>\n                        <span class="badge bg-success ms-1">${e.promocion_info?.porcentaje_descuento}% OFF</span>\n                    </p>\n                    <p class="text-muted small mb-0">por hora</p>\n                `:`<p class="text-muted">$${formatCurrencyChile(e.precio_actual||e.precio_hora)} por hora</p>`;const d="Complejo Demo 3"===complejoSeleccionado.nombre?`<div class="tipo-indicator">${"futbol"===e.tipo?"F√öTBOL":"PADEL"}</div>`:"";return complejoSeleccionado.nombre,e.nombre,"Complejo Demo 3"===complejoSeleccionado.nombre&&"Cancha 3"===e.nombre?(t.innerHTML='\n                    \x3c!-- Secci√≥n izquierda: Badge + √çcono --\x3e\n                    <div class="cancha-izquierda">\n                        <div class="cancha-badge">F√öTBOL</div>\n                        <div class="cancha-icono-grande">‚öΩ</div>\n                    </div>\n                    \n                    \x3c!-- Secci√≥n central: Info --\x3e\n                    <div class="cancha-centro">\n                        <h3 class="cancha-nombre">Cancha 3</h3>\n                        <p class="cancha-precio">$15.000 por hora</p>\n                        <div class="cancha-jugadores">\n                            <i class="fas fa-users me-1"></i>\n                            <span>7 jugadores por equipo</span>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Secci√≥n derecha: Bot√≥n --\x3e\n                    <div class="cancha-derecha">\n                        <button class="cancha-boton">Disponible</button>\n                    </div>\n                ',t.classList.add("demo3-cancha-horizontal"),t.innerHTML):t.innerHTML=`\n                    ${d}\n                    <div class="cancha-icon">\n                        <i class="fas ${a}"></i>\n                    </div>\n                    <h5>${e.nombre.replace("Cancha Techada","Cancha").replace("Cancha 1","padel"===e.tipo?"Cancha P√°del":"Cancha 1").replace("Cancha 2","Cancha 2").replace("Cancha 3","Cancha 3")}</h5>\n                    ${l}\n                    ${v?'<p class="text-info small"><i class="fas fa-home me-1"></i>Techada</p>':""}\n                    <p class="text-info small"><i class="fas fa-users me-1"></i>${r}</p>\n                    <div class="estado-disponibilidad">\n                        ${c}\n                    </div>\n                `,t.addEventListener("click",()=>{t.classList.contains("no-seleccionada")||seleccionarCancha(e)}),t}if("Fundaci√≥n Gunnen"===complejoSeleccionado.nombre){const B=document.createElement("div");B.className="estacionamientos",B.innerHTML='\n                <div class="estacionamiento-icon">\n                    E\n                </div>\n                <div class="estacionamiento-info-icon" onclick="mostrarModalEstacionamiento()">\n                    <i class="fas fa-info-circle"></i>\n                </div>\n            ',E.appendChild(B)}y.appendChild(E),e.appendChild(y),e.appendChild(g)}e.children.length}function renderizarCanchas(){const e=document.getElementById("canchasGrid");if(e.innerHTML="",!complejoSeleccionado||"Complejo En Desarrollo"!==complejoSeleccionado.nombre&&"Complejo Demo 1"!==complejoSeleccionado.nombre)e.parentElement.classList.remove("complejo-desarrollo"),canchas.forEach(o=>{const n=document.createElement("div");n.className="cancha-card disponible",n.dataset.canchaId=o.id,n.dataset.precio=o.precio_actual||o.precio_hora;const t="futbol"===o.tipo?"fa-futbol":"fa-table-tennis";n.innerHTML=`\n                 <div class="cancha-icon">\n                     <i class="fas ${t}"></i>\n                 </div>\n                 <h5>${o.nombre}</h5>\n                 <p class="text-muted">$${formatCurrencyChile(o.precio_hora)} por hora</p>\n                 <div class="estado-disponibilidad">\n                     <span class="badge bg-success">Disponible</span>\n                 </div>\n             `,n.addEventListener("click",()=>seleccionarCancha(o)),e.appendChild(n)});else{const o=document.createElement("div");o.className="galpon-container";const n=document.createElement("div");n.className="calle-monte-perdido",o.appendChild(n);const t=document.createElement("div");t.className="canchas-horizontales";[...canchas].sort((e,o)=>parseInt(e.nombre.match(/\d+/)[0])-parseInt(o.nombre.match(/\d+/)[0])).forEach(e=>{const o=document.createElement("div");o.className="cancha-card disponible",o.dataset.canchaId=e.id,o.dataset.precio=e.precio_actual||e.precio_hora;const n="futbol"===e.tipo?"fa-futbol":"fa-table-tennis";o.innerHTML=`\n                 <div class="cancha-icon">\n                     <i class="fas ${n}"></i>\n                 </div>\n                 <h5>${e.nombre.replace("Cancha Techada","Cancha")}</h5>\n                 <p class="text-muted">$${formatCurrencyChile(e.precio_hora)} por hora</p>\n                 <p class="text-info small"><i class="fas fa-info-circle me-1"></i>Techada</p>\n                 <p class="text-info small"><i class="fas fa-users me-1"></i>7 jugadores por equipo</p>\n                 <div class="estado-disponibilidad">\n                     <span class="badge bg-success">Disponible</span>\n                 </div>\n             `,o.addEventListener("click",()=>seleccionarCancha(e)),t.appendChild(o)}),o.appendChild(t),e.appendChild(o),e.parentElement.classList.add("complejo-desarrollo")}}async function seleccionarCancha(e){const o=document.getElementById("fechaSelect").value,n=document.getElementById("horaSelect").value;if(!o||!n)return void mostrarNotificacion("Por favor selecciona fecha y hora antes de elegir una cancha","warning");if(!await verificarDisponibilidadCancha(e.id,o,n))return mostrarNotificacion("Esta cancha ya no est√° disponible para la fecha y hora seleccionada","danger"),void actualizarEstadoCancha(e.id,!1);canchaSeleccionada=e,mostrarModalReserva()}function mostrarModalReserva(){limpiarFormularioReserva();const e=new bootstrap.Modal(document.getElementById("reservaModal")),o=document.getElementById("resumenReserva"),n=document.getElementById("fechaSelect").value,t=document.getElementById("horaSelect").value;o.innerHTML=`\n         <div class="row">\n             <div class="col-6"><strong>Complejo:</strong></div>\n             <div class="col-6">${complejoSeleccionado.nombre}</div>\n         </div>\n         <div class="row">\n             <div class="col-6"><strong>Direcci√≥n:</strong></div>\n             <div class="col-6">${complejoSeleccionado.direccion}</div>\n         </div>\n         <div class="row">\n             <div class="col-6"><strong>Cancha:</strong></div>\n             <div class="col-6">${canchaSeleccionada.nombre}</div>\n         </div>\n         <div class="row">\n             <div class="col-6"><strong>Fecha:</strong></div>\n             <div class="col-6">${formatearFecha(n)}</div>\n         </div>\n         <div class="row">\n             <div class="col-6"><strong>Hora:</strong></div>\n             <div class="col-6">${t}</div>\n         </div>\n         <div class="row">\n             <div class="col-6"><strong>Precio:</strong></div>\n             <div class="col-6" id="precioOriginal">$${formatCurrencyChile(canchaSeleccionada.precio_hora)}</div>\n         </div>\n     `,e.show(),setTimeout(()=>{limpiarDescuento()},100)}function actualizarResumenPrecio(){if(!canchaSeleccionada)return;const e=document.getElementById("pagarMitad").checked,o=canchaSeleccionada.precio_hora,n=e?Math.round(o/2):o,t=document.getElementById("precioOriginal");t&&(e?t.innerHTML=`\n                <div>\n                    <span style="text-decoration: line-through; color: #999;">$${formatCurrencyChile(o)}</span>\n                    <br>\n                    <strong class="text-primary">$${formatCurrencyChile(n)} (50%)</strong>\n                    <br>\n                    <small class="text-muted">Resto en el complejo</small>\n                </div>\n            `:t.textContent=`$${formatCurrencyChile(o)}`);const a=window.descuentoActual;a&&aplicarDescuentoAlPrecio(a,n)}function limpiarFormularioReserva(){const e=document.getElementById("nombreCliente");e.value="",e.classList.remove("is-valid","is-invalid");const o=document.getElementById("rutCliente");o.value="",o.classList.remove("is-valid","is-invalid");const n=document.getElementById("emailCliente");n.value="",n.classList.remove("is-valid","is-invalid");const t=document.getElementById("telefonoCliente");t.value="",t.classList.remove("is-valid","is-invalid");const a=document.getElementById("aceptarPoliticas");a&&(a.checked=!1,a.classList.remove("is-valid","is-invalid"));const i=document.getElementById("pagarMitad");i&&(i.checked=!1);const c=document.querySelectorAll(".invalid-feedback"),s=document.querySelectorAll(".valid-feedback");c.forEach(e=>{e.classList.add("d-none")}),s.forEach(e=>{e.classList.add("d-none")}),void 0!==window.nombreUsuarioHaInteractuado&&(window.nombreUsuarioHaInteractuado=!1),void 0!==window.rutUsuarioHaInteractuado&&(window.rutUsuarioHaInteractuado=!1),void 0!==window.emailUsuarioHaInteractuado&&(window.emailUsuarioHaInteractuado=!1)}function mostrarModalEstacionamiento(){let e=document.getElementById("estacionamientoModal");e||(e=document.createElement("div"),e.id="estacionamientoModal",e.className="estacionamiento-modal",e.innerHTML='\n            <div class="estacionamiento-modal-content">\n                <div class="estacionamiento-modal-header">\n                    <h3 class="estacionamiento-modal-title">\n                        <i class="fas fa-parking"></i>\n                        Estacionamiento\n                    </h3>\n                    <span class="estacionamiento-modal-close" onclick="cerrarModalEstacionamiento()">&times;</span>\n                </div>\n                <div class="estacionamiento-modal-body">\n                    <p>El <span class="highlight">Complejo Fundaci√≥n Gunnen</span> cuenta con un amplio estacionamiento para tu comodidad.</p>\n                    <p>Disponemos de <span class="highlight">aproximadamente 30 espacios</span> para veh√≠culos menores, garantizando que encuentres un lugar para estacionar tu auto o moto.</p>\n                    <p><i class="fas fa-shield-alt" style="color: #28a745; margin-right: 8px;"></i>Estacionamiento <strong>gratuito</strong> y <strong>seguro</strong> para todos nuestros clientes.</p>\n                </div>\n            </div>\n        ',document.body.appendChild(e)),e.style.display="block",document.body.style.overflow="hidden",e.addEventListener("click",function(o){o.target===e&&cerrarModalEstacionamiento()}),document.addEventListener("keydown",function(o){"Escape"===o.key&&"block"===e.style.display&&cerrarModalEstacionamiento()})}function cerrarModalEstacionamiento(){const e=document.getElementById("estacionamientoModal");e&&(e.style.display="none",document.body.style.overflow="auto")}async function confirmarReserva(){const e=document.getElementById("nombreCliente"),o=document.getElementById("rutCliente"),n=document.getElementById("emailCliente"),t=document.getElementById("telefonoCliente"),a=e.value.trim(),i=o.value.trim(),c=n.value.trim(),s=t.value.trim();if(!a){e.classList.add("is-invalid"),e.classList.remove("is-valid");const o=e.parentNode.querySelector(".valid-feedback"),n=e.parentNode.querySelector(".invalid-feedback");return o&&o.classList.add("d-none"),n&&n.classList.remove("d-none"),mostrarNotificacion('Por favor completa el campo "Nombre completo"',"danger"),void e.focus()}if(!i){o.classList.add("is-invalid"),o.classList.remove("is-valid");const e=o.parentNode.querySelector(".valid-feedback"),n=o.parentNode.querySelector(".invalid-feedback");return e&&e.classList.add("d-none"),n&&n.classList.remove("d-none"),mostrarNotificacion('Por favor completa el campo "RUT"',"danger"),void o.focus()}if(!c){n.classList.add("is-invalid"),n.classList.remove("is-valid");const e=n.parentNode.querySelector(".valid-feedback"),o=n.parentNode.querySelector(".invalid-feedback");return e&&e.classList.add("d-none"),o&&o.classList.remove("d-none"),mostrarNotificacion('Por favor completa el campo "Email"',"danger"),void n.focus()}if(!s){t.classList.add("is-invalid"),t.classList.remove("is-valid");const e=t.parentNode.querySelector(".valid-feedback"),o=t.parentNode.querySelector(".invalid-feedback");return e&&e.classList.add("d-none"),o&&o.classList.remove("d-none"),mostrarNotificacion('Por favor completa el campo "Tel√©fono"',"danger"),void t.focus()}if(!validarNombre(a))return e.classList.add("is-invalid"),mostrarNotificacion('Por favor completa el campo "Nombre completo"',"danger"),void e.focus();if(!validarRUT(i))return o.classList.add("is-invalid"),mostrarNotificacion("Por favor ingresa un RUT v√°lido","danger"),void o.focus();if(!validarEmail(c))return n.classList.add("is-invalid"),mostrarNotificacion("Por favor ingresa un email v√°lido","danger"),void n.focus();if(!validarTelefono(s))return t.classList.add("is-invalid"),mostrarNotificacion("Por favor ingresa un tel√©fono v√°lido","danger"),void t.focus();const r=document.getElementById("aceptarPoliticas");if(!r.checked){r.classList.add("is-invalid");const e=r.parentNode.querySelector(".invalid-feedback");return e&&e.classList.remove("d-none"),mostrarNotificacion("Debes aceptar los t√©rminos y condiciones para continuar","danger"),void r.focus()}{r.classList.remove("is-invalid");const e=r.parentNode.querySelector(".invalid-feedback");e&&e.classList.add("d-none")}const l=document.getElementById("fechaSelect").value,d=document.getElementById("horaSelect").value;if(!await verificarDisponibilidadCancha(canchaSeleccionada.id,l,d)){mostrarNotificacion("Lo sentimos, esta cancha ya no est√° disponible. Por favor selecciona otra opci√≥n.","danger");const e=bootstrap.Modal.getInstance(document.getElementById("reservaModal"));return e&&e.hide(),void actualizarEstadoCancha(canchaSeleccionada.id,!1)}const u=document.getElementById("pagarMitad").checked,m=u?50:100,p=canchaSeleccionada.precio_hora,h=u?Math.round(p/2):p,f={cancha_id:canchaSeleccionada.id,fecha:document.getElementById("fechaSelect").value,hora_inicio:document.getElementById("horaSelect").value,hora_fin:calcularHoraFin(document.getElementById("horaSelect").value),nombre_cliente:document.getElementById("nombreCliente").value,rut_cliente:document.getElementById("rutCliente").value,email_cliente:document.getElementById("emailCliente").value,telefono_cliente:document.getElementById("telefonoCliente").value,precio_total:descuentoAplicado?descuentoAplicado.monto_final:p,codigo_descuento:descuentoAplicado?descuentoAplicado.codigo:null,porcentaje_pagado:m,monto_pagado:descuentoAplicado?Math.round(descuentoAplicado.monto_final*(m/100)):h},v=document.getElementById("confirmarReserva"),b=v.innerHTML;v.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Procesando pago...',v.disabled=!0;try{complejoSeleccionado.nombre,canchaSeleccionada.nombre;const e=await fetch(`${API_BASE}/reservas/bloquear-y-pagar`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...f,session_id:sessionId})}),o=await e.json();if(!e.ok)throw new Error(o.error||"Error al crear el bloqueo temporal");{const e=bootstrap.Modal.getInstance(document.getElementById("reservaModal"));e&&e.hide(),window.location.href=`/payment.html?code=${sessionId}`}}catch(e){await liberarBloqueoTemporal(),mostrarNotificacion(e.message,"danger")}finally{v.innerHTML=b,v.disabled=!1}}function mostrarConfirmacionReserva(e,o){const n=document.createElement("div");n.className="alert alert-success alert-dismissible fade show",n.innerHTML=`\n        <h4><i class="fas fa-check-circle me-2"></i>¬°Reserva Confirmada!</h4>\n        <p>Tu c√≥digo de reserva es: <strong>${e}</strong></p>\n        <p>ID de transacci√≥n: <strong>${o}</strong></p>\n        <p>El ticket de pago se ha descargado autom√°ticamente.</p>\n        <p>Te hemos enviado un email con los detalles de tu reserva.</p>\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.querySelector(".container").insertBefore(n,document.querySelector(".container").firstChild)}async function buscarReserva(){const e=document.getElementById("codigoReserva").value.trim();if(e)try{const o=await fetch(`${API_BASE}/reservas/${e}`),n=await o.json();o.ok?mostrarResultadoReserva(n):mostrarNotificacion("Reserva no encontrada","danger")}catch(e){mostrarNotificacion("Error al buscar la reserva","danger")}else mostrarNotificacion("Por favor ingresa tu c√≥digo de reserva o nombre completo","warning")}function mostrarResultadoReserva(e){const o=document.getElementById("resultadoReserva"),n=e.complejo_nombre||e.nombre_complejo||"No especificado",t=e.cancha_nombre||e.nombre_cancha||"No especificada",a="futbol"===e.tipo?"F√∫tbol":e.tipo||"No especificado",i=formatearFecha(e.fecha),c=formatearRangoHoras(e.hora_inicio,e.hora_fin),s=e.estado||"No especificado",r=e.precio_total?formatCurrencyChile(e.precio_total):"No especificado";o.innerHTML=`\n        <div class="card bg-light">\n            <div class="card-body">\n                <h5 class="card-title">\n                    <i class="fas fa-ticket-alt me-2"></i>\n                    Reserva #${e.codigo_reserva}\n                </h5>\n                <div class="row">\n                    <div class="col-md-6">\n                        <p><strong>Complejo:</strong> ${n}</p>\n                        <p><strong>Cancha:</strong> ${t}</p>\n                        <p><strong>Tipo:</strong> ${a}</p>\n                    </div>\n                    <div class="col-md-6">\n                        <p><strong>Fecha:</strong> ${i}</p>\n                        <p><strong>Hora:</strong> ${c}</p>\n                        <p><strong>Estado:</strong> \n                            <span class="badge bg-${"confirmada"===s?"success":"warning"}">\n                                ${s}\n                            </span>\n                        </p>\n                    </div>\n                </div>\n                <div class="mt-3">\n                    <p><strong>Cliente:</strong> ${e.nombre_cliente||"No especificado"}</p>\n                    <p><strong>Precio:</strong> $${r}</p>\n                </div>\n            </div>\n        </div>\n    `,o.style.display="block"}async function actualizarDisponibilidad(){if(!canchas.length)return;const e=document.getElementById("fechaSelect").value,o=document.getElementById("horaSelect").value;if(e&&o)for(const n of canchas)try{const t=await fetch(`${API_BASE}/disponibilidad/${n.id}/${e}`),a=await t.json(),i=document.querySelector(`[data-cancha-id="${n.id}"]`);!a.reservas.some(e=>{const n=calcularHoraFin(o),t=timeToMinutes(e.hora_inicio),a=timeToMinutes(e.hora_fin),i=timeToMinutes(o);return t<timeToMinutes(n)&&a>i})?(i.className="cancha-card disponible",i.querySelector(".estado-disponibilidad").innerHTML='<span class="badge bg-success">Disponible</span>'):(i.className="cancha-card ocupada",i.querySelector(".estado-disponibilidad").innerHTML='<span class="badge bg-danger">Ocupada</span>')}catch(e){console.error("Error al verificar disponibilidad:",e)}}function calcularHoraFin(e){const[o,n]=e.split(":"),t=new Date;return t.setHours(parseInt(o)+1,parseInt(n),0),t.toTimeString().slice(0,5)}function formatearFecha(e){if(!e)return"No especificada";try{let o=e;e.includes("T")&&(o=e.split("T")[0]);const[n,t,a]=o.split("-").map(Number);if(isNaN(n)||isNaN(t)||isNaN(a))return console.error("Componentes de fecha inv√°lidos:",{"a√±o":n,mes:t,dia:a,fechaOriginal:e}),"Fecha inv√°lida";const i=new Date(n,t-1,a);if(i.getFullYear()!==n||i.getMonth()!==t-1||i.getDate()!==a)return console.error("Fecha construida inv√°lida:",{fechaOriginal:e,fechaString:o,"a√±o":n,mes:t,dia:a}),"Fecha inv√°lida";const c={weekday:"long",year:"numeric",month:"long",day:"numeric"};let s=i.toLocaleDateString("es-CL",c);return s=s.charAt(0).toUpperCase()+s.slice(1),s}catch(o){return console.error("Error formateando fecha:",o,"Fecha original:",e),"Fecha inv√°lida"}}function formatearRangoHoras(e,o){if(!e||!o)return"No especificado";return`${e.toString().substring(0,5)} - ${o.toString().substring(0,5)}`}function mostrarNotificacion(e,o){const n=document.createElement("div");n.className=`alert alert-${o} alert-dismissible fade show`,n.innerHTML=`\n        ${e}\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.querySelector(".container").insertBefore(n,document.querySelector(".container").firstChild),setTimeout(()=>{n.parentNode&&n.remove()},5e3)}function scrollSuave(e){const o=e.offsetTop,n=window.pageYOffset,t=o-n;let a=null;requestAnimationFrame(function e(o){null===a&&(a=o);const i=o-a,c=(s=i,r=n,l=t,(s/=1e3/2)<1?l/2*s*s+r:(s--,-l/2*(s*(s-2)-1)+r));var s,r,l;window.scrollTo(0,c),i<1e3&&requestAnimationFrame(e)})}function scrollToStep4(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),o=()=>{const o=document.getElementById("reservar");return!!o&&(e?o.scrollIntoView({behavior:"auto",block:"start"}):o.scrollIntoView({behavior:"smooth",block:"start"}),!0)};o()||setTimeout(()=>{o()||setTimeout(o,500)},100)}function scrollToReservar(){scrollToStep4()}document.addEventListener("DOMContentLoaded",async function(){if((new Date).toISOString(),window.location.hostname,window.URL_CONFIG,API_BASE,!API_BASE||"undefined"===API_BASE){if(console.error("‚ùå CR√çTICO: API_BASE no est√° configurado correctamente!"),console.error("üîß Intentando recargar configuraci√≥n..."),void 0===window.URL_CONFIG)return console.error("‚ùå URL_CONFIG tampoco est√° disponible!"),void mostrarNotificacion("Error cr√≠tico: Configuraci√≥n de URLs no disponible","danger");window.API_BASE=window.URL_CONFIG.API_URL,window.API_BASE}await testConnectivity(),sessionId=Math.random().toString(36).substr(2,6).toUpperCase();try{await cargarCiudades(),configurarEventListeners(),configurarFechaMinima();const e=new URLSearchParams(window.location.search),o=e.get("ciudad"),n=e.get("complejo"),t=e.get("payment"),a=e.get("code");if("success"===t&&a){mostrarConfirmacionReserva(a,"Transbank");const e=window.location.pathname;return window.history.replaceState({},document.title,e),void window.scrollTo({top:0,behavior:"smooth"})}if((o||n)&&(window.location.href,window.location.search,await preRellenarDesdeURLMejorado()),o||n){mostrarPaso(4);const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?1200:800;setTimeout(()=>{scrollToStep4()},e)}}catch(e){console.error("‚ùå Error en inicializaci√≥n:",e)}"function"==typeof scrollToReservar||console.error("‚ùå Funci√≥n scrollToReservar NO est√° disponible");const e=document.querySelector("#reservarAhoraBtn");if(e)e.outerHTML,e.onclick,e.getAttribute("onclick"),e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),scrollToReservar()}),e.style.pointerEvents,e.style.cursor;else{console.error("‚ùå Bot√≥n RESERVAR AHORA NO encontrado en el DOM");const e=document.querySelectorAll("button");e.length,e.forEach((e,o)=>{e.textContent.trim(),e.id,e.className})}});let descuentoAplicado=null,precioOriginal=0,precioConDescuento=0;function limpiarDescuento(){descuentoAplicado=null,precioConDescuento=0;const e=document.getElementById("resumenDescuento");e&&e.classList.add("d-none");const o=document.getElementById("mensajeDescuento");o&&(o.classList.add("d-none"),o.textContent="");const n=document.getElementById("codigoDescuento");n&&(n.value="")}async function validarCodigoDescuento(){const e=document.getElementById("codigoDescuento"),o=(document.getElementById("mensajeDescuento"),document.getElementById("aplicarDescuento"));if(!e||!e.value.trim())return void mostrarMensajeDescuento("Por favor ingresa un c√≥digo de descuento","error");const n=e.value.trim().toUpperCase(),t=document.getElementById("emailCliente").value;if(t)if(canchaSeleccionada&&canchaSeleccionada.precio_hora){o.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Validando...',o.disabled=!0;try{canchaSeleccionada.precio_hora;const e=await fetch("/api/discounts/validar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({codigo:n,email_cliente:t,monto_original:canchaSeleccionada.precio_hora})});e.status,e.statusText;const o=await e.json();if(e.ok&&o.valido){descuentoAplicado=o,precioOriginal=o.monto_original,precioConDescuento=o.monto_final,mostrarResumenDescuento(o),mostrarMensajeDescuento(`¬°Descuento aplicado! ${o.porcentaje_descuento}% de descuento`,"success");const e=document.getElementById("precioOriginal");e&&(e.innerHTML=`\n                    <span class="text-decoration-line-through text-muted">$${formatCurrencyChile(o.monto_original)}</span>\n                    <span class="text-primary fw-bold ms-2">$${formatCurrencyChile(o.monto_final)}</span>\n                `)}else mostrarMensajeDescuento(o.error||"C√≥digo de descuento no v√°lido","error"),limpiarDescuento()}catch(e){console.error("Error validando c√≥digo de descuento:",e),mostrarMensajeDescuento("Error al validar el c√≥digo. Intenta nuevamente.","error")}finally{o.innerHTML='<i class="fas fa-check me-1"></i>Aplicar',o.disabled=!1}}else mostrarMensajeDescuento("Por favor selecciona una cancha primero","error");else mostrarMensajeDescuento("Por favor ingresa tu email primero","error")}function mostrarMensajeDescuento(e,o){const n=document.getElementById("mensajeDescuento");n&&(n.textContent=e,n.classList.remove("d-none","text-success","text-danger"),"success"===o?n.classList.add("text-success"):"error"===o&&n.classList.add("text-danger"))}function mostrarResumenDescuento(e){const o=document.getElementById("resumenDescuento"),n=document.getElementById("montoDescuento"),t=document.getElementById("totalFinal");o&&n&&t&&(n.textContent=`-$${formatCurrencyChile(e.monto_descuento)}`,t.textContent=`$${formatCurrencyChile(e.monto_final)}`,o.classList.remove("d-none"))}function inicializarZoomPanDemo3(e){if(!e)return void console.error("‚ùå No se encontr√≥ el contenedor para inicializar zoom y pan");let o=.8,n=0,t=0,a=!1,i=0,c=0,s=0,r=0;function l(){e.style.transform=`translate(${n}px, ${t}px) scale(${o})`}function d(){n=Math.max(-100,Math.min(100,n)),t=Math.max(-100,Math.min(100,t))}e.style.transformOrigin="center center",e.style.transition="transform 0.1s ease-out",e.style.cursor="grab",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.addEventListener("mousedown",function(o){0===o.button&&(a=!0,i=o.clientX,c=o.clientY,s=n,r=t,e.style.cursor="grabbing",o.preventDefault())}),document.addEventListener("mousemove",function(e){if(a){const o=e.clientX-i,a=e.clientY-c;n=s+o,t=r+a,d(),l()}}),document.addEventListener("mouseup",function(){a&&(a=!1,e.style.cursor="grab")}),e.addEventListener("touchstart",function(e){1===e.touches.length?(a=!0,i=e.touches[0].clientX,c=e.touches[0].clientY,s=n,r=t,e.preventDefault()):2===e.touches.length&&e.preventDefault()},{passive:!1}),e.addEventListener("touchmove",function(e){if(1===e.touches.length&&a){const o=e.touches[0].clientX-i,a=e.touches[0].clientY-c;n=s+o,t=r+a,d(),l(),e.preventDefault()}else 2===e.touches.length&&e.preventDefault()},{passive:!1}),e.addEventListener("touchend",function(e){0===e.touches.length&&(a=!1)}),e.addEventListener("wheel",function(e){e.preventDefault();const n=e.deltaY>0?-.1:.1;o=Math.max(.5,Math.min(1.5,o+n)),l()},{passive:!1}),crearControlesZoom(e,o,l),l()}function crearControlesZoom(e,o,n){if(window.innerWidth>768)return;const t=document.createElement("div");t.className="demo3-zoom-controls",t.style.cssText="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        z-index: 1000;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n    ";const a=document.createElement("button");a.innerHTML="+",a.style.cssText="\n        width: 50px;\n        height: 50px;\n        border-radius: 50%;\n        border: none;\n        background: #667eea;\n        color: white;\n        font-size: 24px;\n        font-weight: bold;\n        cursor: pointer;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        transition: all 0.2s ease;\n    ";const i=document.createElement("button");i.innerHTML="‚àí",i.style.cssText=a.style.cssText;const c=document.createElement("button");c.innerHTML="‚åÇ",c.style.cssText=a.style.cssText,c.style.fontSize="20px",a.addEventListener("click",function(){o=Math.min(1.5,o+.1),n()}),i.addEventListener("click",function(){o=Math.max(.5,o-.1),n()}),c.addEventListener("click",function(){o=.8,translateX=0,translateY=0,n()}),t.appendChild(a),t.appendChild(i),t.appendChild(c),document.body.appendChild(t);const s=new MutationObserver(function(e){e.forEach(function(e){if("childList"===e.type){document.querySelector(".demo3-container")||(t.remove(),s.disconnect())}})});s.observe(document.body,{childList:!0,subtree:!0})}function inicializarZoomPanDemo3(e){if(window.innerWidth>768)return;let o=.8,n=0,t=0,a=!1,i=0,c=0,s=0,r=0;function l(){e.style.transform=`translate(${n}px, ${t}px) scale(${o})`}function d(){const a=e.getBoundingClientRect(),i=a.width*o,c=a.height*o,s=window.innerWidth,r=window.innerHeight,l=Math.max(0,(i-s)/2),d=Math.max(0,(c-r)/2);n=Math.max(-l,Math.min(l,n)),t=Math.max(-d,Math.min(d,t))}e.style.transformOrigin="center center",e.style.transition="transform 0.1s ease-out",e.style.cursor="grab",e.style.userSelect="none",e.addEventListener("mousedown",o=>{window.innerWidth<=768||(a=!0,i=o.clientX-n,c=o.clientY-t,e.style.cursor="grabbing")}),document.addEventListener("mousemove",e=>{!a||window.innerWidth<=768||(n=e.clientX-i,t=e.clientY-c,d(),l())}),document.addEventListener("mouseup",()=>{window.innerWidth<=768||(a=!1,e.style.cursor="grab")}),e.addEventListener("touchstart",l=>{if(!(window.innerWidth>768))if(l.preventDefault(),1===l.touches.length)a=!0,i=l.touches[0].clientX-n,c=l.touches[0].clientY-t,s=n,r=t;else if(2===l.touches.length){a=!1;const n=l.touches[0],t=l.touches[1],i=Math.sqrt(Math.pow(t.clientX-n.clientX,2)+Math.pow(t.clientY-n.clientY,2));e.initialDistance=i,e.initialScale=o}}),e.addEventListener("touchmove",s=>{if(!(window.innerWidth>768))if(s.preventDefault(),1===s.touches.length&&a)n=s.touches[0].clientX-i,t=s.touches[0].clientY-c,d(),l();else if(2===s.touches.length){const n=s.touches[0],t=s.touches[1],a=Math.sqrt(Math.pow(t.clientX-n.clientX,2)+Math.pow(t.clientY-n.clientY,2));if(e.initialDistance){const n=a/e.initialDistance;o=Math.max(.5,Math.min(2,e.initialScale*n)),d(),l()}}}),e.addEventListener("touchend",o=>{window.innerWidth>768||(a=!1,e.initialDistance=null)}),e.addEventListener("wheel",e=>{if(window.innerWidth<=768)return;e.preventDefault();const n=e.deltaY>0?.9:1.1;o=Math.max(.5,Math.min(2,o*n)),d(),l()}),crearControlesZoom(e,o,l),l()}function crearControlesZoom(e,o,n){if(window.innerWidth>768)return;const t=document.createElement("button");t.innerHTML='<i class="fas fa-plus"></i>',t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        width: 50px;\n        height: 50px;\n        border-radius: 50%;\n        background: rgba(102, 126, 234, 0.9);\n        color: white;\n        border: none;\n        font-size: 18px;\n        cursor: pointer;\n        z-index: 1000;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        transition: all 0.3s ease;\n    ";const a=document.createElement("button");a.innerHTML='<i class="fas fa-minus"></i>',a.style.cssText="\n        position: fixed;\n        top: 80px;\n        right: 20px;\n        width: 50px;\n        height: 50px;\n        border-radius: 50%;\n        background: rgba(102, 126, 234, 0.9);\n        color: white;\n        border: none;\n        font-size: 18px;\n        cursor: pointer;\n        z-index: 1000;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        transition: all 0.3s ease;\n    ";const i=document.createElement("button");i.innerHTML='<i class="fas fa-home"></i>',i.style.cssText="\n        position: fixed;\n        top: 140px;\n        right: 20px;\n        width: 50px;\n        height: 50px;\n        border-radius: 50%;\n        background: rgba(156, 39, 176, 0.9);\n        color: white;\n        border: none;\n        font-size: 18px;\n        cursor: pointer;\n        z-index: 1000;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        transition: all 0.3s ease;\n    ",t.addEventListener("click",()=>{o=Math.min(2,1.2*o),n()}),a.addEventListener("click",()=>{o=Math.max(.5,.8*o),n()}),i.addEventListener("click",()=>{o=.8,translateX=0,translateY=0,n()}),document.body.appendChild(t),document.body.appendChild(a),document.body.appendChild(i);const c=new MutationObserver(function(e){e.forEach(function(e){if("childList"===e.type){document.querySelector(".demo3-container")||(t.remove(),a.remove(),i.remove(),c.disconnect())}})});c.observe(document.body,{childList:!0,subtree:!0})}function mostrarIndicadorZoom(){if(window.innerWidth>768)return;const e=document.createElement("div");e.className="demo3-zoom-indicator",e.innerHTML='\n        <div style="\n            position: fixed;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(102, 126, 234, 0.9);\n            color: white;\n            padding: 8px 16px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            font-weight: 600;\n            z-index: 1001;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            animation: slideInDown 0.5s ease-out;\n        ">\n            <i class="fas fa-search-plus" style="margin-right: 8px;"></i>\n            Toca y arrastra para navegar ‚Ä¢ Pellizca para hacer zoom\n        </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e&&e.parentNode&&(e.style.animation="slideOutUp 0.5s ease-out",setTimeout(()=>{e&&e.parentNode&&e.remove()},500))},4e3);const o=new MutationObserver(function(n){n.forEach(function(n){if("childList"===n.type){!document.querySelector(".demo3-container")&&e&&e.parentNode&&(e.remove(),o.disconnect())}})});o.observe(document.body,{childList:!0,subtree:!0})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("aplicarDescuento");e&&e.addEventListener("click",validarCodigoDescuento);const o=document.getElementById("codigoDescuento");o&&o.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),validarCodigoDescuento())})}),setTimeout(()=>{asegurarValoresVisibles()},2e3);