let currentUser=null,reportsData=null,complexes=[];function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}let revenueChart=null,typeChart=null,occupancyChart=null,hoursChart=null;function setupEventListeners(){const e=document.getElementById("dateFrom"),t=document.getElementById("dateTo"),o=document.getElementById("complexFilter");e&&e.addEventListener("change",function(){this.blur(),generateReports()}),t&&t.addEventListener("change",function(){this.blur(),generateReports()}),o&&o.addEventListener("change",function(){generateReports()})}async function verificarCanchasComplejo(e){try{const t=await AdminUtils.authenticatedFetch(`/admin/canchas?complejo_id=${e}`);if(!t||!t.ok)return console.error("❌ Error obteniendo canchas del complejo"),null;const o=(await t.json()).length;return o}catch(e){return console.error("❌ Error verificando canchas:",e),null}}async function aplicarPermisosPorRol(){const e=AdminUtils.getCurrentUser();if(!e)return;const t=e.rol,o=document.querySelector('a[href="admin-complexes.html"]'),r=document.querySelector('a[href="admin-gastos.html"]');if("manager"===t?(o&&(o.style.display="none"),r&&(r.style.display="none")):"owner"===t?(o&&(o.style.display="none"),r&&(r.style.display="block",r.classList.add("owner-visible"))):"super_admin"===t&&(o&&(o.style.display="block"),r&&(r.style.display="block")),"manager"===t){const e=document.querySelectorAll(".hide-for-manager");e.length,e.forEach(e=>{e.style.display="none"})}else if("owner"===t){const t=document.querySelectorAll(".hide-for-owner");t.length,t.forEach(e=>{e.style.display="none"});const o=document.getElementById("complexFilter"),r=o?o.closest(".filter-item"):null;r&&(r.style.display="none");const n=document.getElementById("downloadButtons");if(n&&(n.style.display="block",n.style.visibility="visible"),e.complejo_id){const t=await verificarCanchasComplejo(e.complejo_id),o=document.getElementById("topCourtsColumn");null!==t&&t<=1?o&&(o.style.display="none"):o&&(o.classList.remove("col-lg-6"),o.classList.add("col-lg-12"),o.style.display="")}}else if("super_admin"===t){const e=document.querySelectorAll(".hide-for-manager, .hide-for-owner");e.length,e.forEach((e,t)=>{e.classList.remove("hide-for-manager"),e.classList.remove("hide-for-owner"),e.style.display="",e.style.visibility=""});const t=document.getElementById("topCourtsColumn");t&&(t.classList.remove("col-lg-12"),t.classList.add("col-lg-6"))}}async function loadComplexes(){try{const e=await AdminUtils.authenticatedFetch("/admin/complejos");if(!e)return;e.ok?(complexes=await e.json(),populateComplexFilter()):console.error("Error cargando complejos:",e.statusText)}catch(e){console.error("Error:",e)}}function populateComplexFilter(){const e=document.getElementById("complexFilter");if(!e)return;const t=AdminUtils.getCurrentUser();t&&"owner"!==t.rol&&(e.innerHTML='<option value="">Todos los complejos</option>',complexes.forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.nombre,e.appendChild(o)}))}function setDefaultDates(){const e=new Date,t=new Date(2025,8,1),o=document.getElementById("dateFrom"),r=document.getElementById("dateTo");o&&(o.value=t.toISOString().split("T")[0]),r&&(r.value=e.toISOString().split("T")[0])}function getFilters(){const e=document.getElementById("dateFrom"),t=document.getElementById("dateTo"),o=document.getElementById("complexFilter"),r=AdminUtils.getCurrentUser();let n=null;return r&&"owner"===r.rol&&r.complejo_id?n=r.complejo_id:o&&(n=o.value||null),{dateFrom:e?e.value:"",dateTo:t?t.value:"",complexId:n,sport:null}}async function generateReports(){try{showLoadingState();const e=getFilters(),t=await AdminUtils.authenticatedFetch("/admin/reports",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t)return void console.error("❌ No se recibió respuesta");t.ok?(reportsData=await t.json(),updateMetrics(),updateCharts(),await updateTables(),showNotification("Reportes generados exitosamente","success")):(console.error("Error generando reportes:",t.statusText),showErrorState("Error generando reportes: "+t.statusText),showNotification("Error generando reportes: "+t.statusText,"error"))}catch(e){console.error("Error:",e),e.message&&!e.message.includes("Failed to fetch")&&(showErrorState("Error de conexión"),showNotification("Error de conexión: "+e.message,"error"))}}function showLoadingState(){const e=document.getElementById("totalRevenue"),t=document.getElementById("totalReservations"),o=document.getElementById("occupancyRate"),r=document.getElementById("uniqueCustomers");e&&(e.textContent="Cargando..."),t&&(t.textContent="Cargando..."),o&&(o.textContent="Cargando..."),r&&(r.textContent="Cargando...")}function showErrorState(e){const t=document.getElementById("totalRevenue"),o=document.getElementById("totalReservations"),r=document.getElementById("occupancyRate"),n=document.getElementById("uniqueCustomers");t&&(t.textContent="Error"),o&&(o.textContent="Error"),r&&(r.textContent="Error"),n&&(n.textContent="Error"),console.error("Error en reportes:",e)}function updateMetrics(){const e=reportsData.metrics,t=document.getElementById("totalRevenue"),o=document.getElementById("totalReservations"),r=document.getElementById("occupancyRate"),n=document.getElementById("uniqueCustomers");t&&(t.textContent=`$${formatCurrencyChile(e.ingresosTotales)}`),o&&(o.textContent=e.totalReservas),r&&(r.textContent=`${e.ocupacionPromedio||0}%`),n&&(n.textContent=e.clientes_unicos||0)}function destroyCharts(){revenueChart&&(revenueChart.destroy(),revenueChart=null),typeChart&&(typeChart.destroy(),typeChart=null),occupancyChart&&(occupancyChart.destroy(),occupancyChart=null),hoursChart&&(hoursChart.destroy(),hoursChart=null)}function updateCharts(){if(!reportsData||!reportsData.charts)return void console.error("❌ No hay datos de gráficos disponibles");const e=reportsData.charts;destroyCharts(),e.reservasPorDia,updateIncomeChart(e.reservasPorDia),e.reservasPorTipo,updateReservationsChart(e.reservasPorTipo),e.reservasPorComplejo,updateOccupancyChart(e.reservasPorComplejo),e.horariosPopulares,updateHoursChart(e.horariosPopulares)}function updateIncomeChart(e){const t=document.getElementById("revenueChart");if(!t||!e)return void console.error("❌ Canvas o datos no disponibles para gráfico de ingresos");if("undefined"==typeof Chart)return void console.error("❌ Chart.js no está disponible para crear gráfico de ingresos");const o=t.getContext("2d"),r=o.createLinearGradient(0,0,0,400);r.addColorStop(0,"rgba(34, 197, 94, 0.3)"),r.addColorStop(.5,"rgba(34, 197, 94, 0.1)"),r.addColorStop(1,"rgba(34, 197, 94, 0.02)"),revenueChart=new Chart(o,{type:"line",data:{labels:e.map(e=>{if(!e.fecha)return"Sin fecha";try{if("string"==typeof e.fecha&&e.fecha.match(/^\d{4}-\d{2}-\d{2}$/)){const[t,o,r]=e.fecha.split("-");return new Date(parseInt(t),parseInt(o)-1,parseInt(r)).toLocaleDateString("es-CL")}const t=new Date(e.fecha);return isNaN(t.getTime())?(console.error("Fecha inválida:",e.fecha),"Fecha inválida"):t.toLocaleDateString("es-CL")}catch(t){return console.error("Error procesando fecha:",t,"Fecha original:",e.fecha),"Error fecha"}}),datasets:[{label:"Ingresos",data:e.map(e=>parseInt(e.ingresos)),borderColor:"#22c55e",backgroundColor:r,borderWidth:4,fill:!0,tension:.4,pointBackgroundColor:"#ffffff",pointBorderColor:"#22c55e",pointBorderWidth:3,pointRadius:8,pointHoverRadius:12,pointHoverBackgroundColor:"#22c55e",pointHoverBorderColor:"#ffffff",pointHoverBorderWidth:3,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(34, 197, 94, 0.3)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:2e3,easing:"easeInOutQuart"},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#f1f5f9",borderColor:"#22c55e",borderWidth:2,cornerRadius:12,displayColors:!1,titleFont:{size:14,weight:"600"},bodyFont:{size:13},padding:12,caretSize:8,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(0, 0, 0, 0.2)",callbacks:{label:function(e){return`Ingresos: $${formatCurrencyChile(e.parsed.y)}`}}}},scales:{x:{grid:{display:!1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:8},border:{display:!1}},y:{beginAtZero:!0,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1,lineWidth:1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:12,callback:function(e){return"$"+formatCurrencyChile(e)}},border:{display:!1}}},interaction:{intersect:!1,mode:"index"},elements:{line:{shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(34, 197, 94, 0.2)"}}}})}function updateReservationsChart(e){const t=document.getElementById("typeChart");if(!t||!e)return;const o=t.getContext("2d");typeChart=new Chart(o,{type:"doughnut",data:{labels:e.map(e=>e.tipo),datasets:[{data:e.map(e=>parseInt(e.cantidad)),backgroundColor:["rgba(99, 102, 241, 0.9)","rgba(236, 72, 153, 0.9)","rgba(14, 165, 233, 0.9)","rgba(34, 197, 94, 0.9)","rgba(245, 158, 11, 0.9)","rgba(168, 85, 247, 0.9)","rgba(239, 68, 68, 0.9)","rgba(6, 182, 212, 0.9)"],borderColor:["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],borderWidth:3,hoverOffset:15,hoverBorderWidth:4,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(0, 0, 0, 0.15)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:2e3,easing:"easeInOutQuart",animateRotate:!0,animateScale:!0},plugins:{legend:{position:"bottom",labels:{padding:20,usePointStyle:!0,pointStyle:"circle",font:{size:13,weight:"500"},color:"#374151",generateLabels:function(e){const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((e,o)=>{const r=t.datasets[0],n=r.data[o],a=r.data.reduce((e,t)=>e+t,0);return{text:`${e} (${a>0?(n/a*100).toFixed(1):0}%)`,fillStyle:r.backgroundColor[o],strokeStyle:r.borderColor[o],lineWidth:r.borderWidth,pointStyle:"circle",hidden:!1,index:o}}):[]}}},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#f1f5f9",borderColor:"#6366f1",borderWidth:2,cornerRadius:12,displayColors:!0,titleFont:{size:14,weight:"600"},bodyFont:{size:13},padding:12,caretSize:8,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(0, 0, 0, 0.2)",callbacks:{label:function(e){const t=e.label||"",o=e.parsed,r=e.dataset.data.reduce((e,t)=>e+t,0);return`${t}: ${o} reservas (${r>0?(o/r*100).toFixed(1):0}%)`}}}},cutout:"65%",radius:"85%"}})}function updateOccupancyChart(e){const t=document.getElementById("occupancyChart");if(!t||!e)return;const o=t.getContext("2d"),r=o.createLinearGradient(0,0,0,400);r.addColorStop(0,"rgba(245, 158, 11, 0.9)"),r.addColorStop(.5,"rgba(245, 158, 11, 0.7)"),r.addColorStop(1,"rgba(245, 158, 11, 0.5)"),occupancyChart=new Chart(o,{type:"bar",data:{labels:e.map(e=>e.complejo),datasets:[{label:"Ocupación (%)",data:e.map(e=>Math.round(parseFloat(e.ocupacion_real))),backgroundColor:r,borderColor:"#f59e0b",borderWidth:2,borderRadius:{topLeft:12,topRight:12,bottomLeft:0,bottomRight:0},borderSkipped:!1,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(245, 158, 11, 0.3)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:2e3,easing:"easeOutBack"},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#f1f5f9",borderColor:"#f59e0b",borderWidth:2,cornerRadius:12,displayColors:!1,titleFont:{size:14,weight:"600"},bodyFont:{size:13},padding:12,caretSize:8,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(0, 0, 0, 0.2)",callbacks:{label:function(e){return`Ocupación: ${e.parsed.y}%`}}}},scales:{x:{grid:{display:!1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:8},border:{display:!1}},y:{beginAtZero:!0,max:100,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1,lineWidth:1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:12,callback:function(e){return e+"%"}},border:{display:!1}}},interaction:{intersect:!1,mode:"index"}}})}function updateHoursChart(e){const t=document.getElementById("hoursChart");if(!t||!e)return;const o=t.getContext("2d"),r=o.createLinearGradient(0,0,0,400);r.addColorStop(0,"rgba(236, 72, 153, 0.9)"),r.addColorStop(.5,"rgba(236, 72, 153, 0.7)"),r.addColorStop(1,"rgba(236, 72, 153, 0.5)"),hoursChart=new Chart(o,{type:"bar",data:{labels:e.map(e=>e.hora),datasets:[{label:"Reservas",data:e.map(e=>parseInt(e.cantidad)),backgroundColor:r,borderColor:"#ec4899",borderWidth:2,borderRadius:{topLeft:12,topRight:12,bottomLeft:0,bottomRight:0},borderSkipped:!1,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(236, 72, 153, 0.3)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:2e3,easing:"easeOutBack"},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#f1f5f9",borderColor:"#ec4899",borderWidth:2,cornerRadius:12,displayColors:!1,titleFont:{size:14,weight:"600"},bodyFont:{size:13},padding:12,caretSize:8,shadowOffsetX:0,shadowOffsetY:4,shadowBlur:12,shadowColor:"rgba(0, 0, 0, 0.2)",callbacks:{label:function(e){return`Reservas: ${e.parsed.y}`}}}},scales:{x:{grid:{display:!1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:8},border:{display:!1}},y:{beginAtZero:!0,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1,lineWidth:1},ticks:{color:"#64748b",font:{size:12,weight:"500"},padding:12,stepSize:1},border:{display:!1}}},interaction:{intersect:!1,mode:"index"}}})}async function updateTables(){try{await Promise.all([updateTopComplexesTable(),updateTopCourtsTable(),updateCustomersTable()])}catch(e){console.error("❌ Error en updateTables:",e)}}function verifyDownloadButtons(){const e=document.getElementById("downloadButtons"),t=AdminUtils.getCurrentUser();if(t&&t.rol,e){const t=window.getComputedStyle(e);t.display,t.visibility,t.opacity,"none"!==t.display&&"hidden"!==t.visibility||(e.style.display="block",e.style.visibility="visible",e.style.opacity="1")}else createDownloadButtons();document.querySelector("button[onclick*=\"downloadIncomeReport('pdf')\"]"),document.querySelector("button[onclick*=\"downloadIncomeReport('excel')\"]")}function createDownloadButtons(){try{const e=document.querySelector(".filter-group");if(!e)return;const t=document.createElement("div");t.className="filter-item",t.id="downloadButtons";const o=document.createElement("label");o.className="form-label",o.textContent="Reportes de Ingresos";const r=document.createElement("div");r.className="btn-group",r.setAttribute("role","group");const n=document.createElement("button");n.className="btn btn-success",n.innerHTML='<i class="fas fa-file-pdf me-2"></i>PDF',n.title="Descargar reporte de ingresos en PDF",n.onclick=()=>downloadIncomeReport("pdf");const a=document.createElement("button");a.className="btn btn-success",a.innerHTML='<i class="fas fa-file-excel me-2"></i>Excel',a.title="Descargar reporte de ingresos en Excel",a.onclick=()=>downloadIncomeReport("excel"),r.appendChild(n),r.appendChild(a),t.appendChild(o),t.appendChild(r);const s=document.querySelector('button[onclick="generateReports()"]');if(s){const o=s.closest(".filter-item");o&&o.nextSibling?o.parentNode.insertBefore(t,o.nextSibling):e.appendChild(t)}else e.appendChild(t)}catch(e){console.error("❌ Error creando botones de descarga:",e)}}async function downloadIncomeReport(e){try{e.toUpperCase();const t=document.getElementById("dateFrom")?.value,o=document.getElementById("dateTo")?.value;if(!t||!o)return void showNotification("Por favor selecciona las fechas de inicio y fin","error");const r=AdminUtils.getCurrentUser();let n=null;if(r&&"owner"===r.rol&&r.complejo_id)n=r.complejo_id;else{const e=document.getElementById("complexFilter");n=e?e.value:null}if(!n)return void showNotification("Por favor selecciona un complejo","error");showNotification(`Generando reporte ${e.toUpperCase()}...`,"info");const a=`${API_BASE}/admin/reports/income/${e}?dateFrom=${t}&dateTo=${o}&complexId=${n}`,s=document.createElement("a");s.href=a,s.download=`reporte_ingresos_${t}_${o}.${"excel"===e?"xlsx":"pdf"}`;const l=AdminUtils.getAuthToken();if(!l)throw new Error("No se encontró token de autorización");{const t=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!t.ok){const e=await t.json();throw new Error(e.error||"Error generando reporte")}const o=await t.blob(),r=window.URL.createObjectURL(o);s.href=r,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r),showNotification(`Reporte ${e.toUpperCase()} descargado exitosamente`,"success"),e.toUpperCase()}}catch(e){console.error("❌ Error descargando reporte:",e),showNotification(`Error descargando reporte: ${e.message}`,"error")}}async function updateTopComplexesTable(){try{const e=document.getElementById("dateFrom")?.value,t=document.getElementById("dateTo")?.value,o=AdminUtils.getCurrentUser();let r=null;if(o&&"owner"===o.rol&&o.complejo_id)r=o.complejo_id;else{const e=document.getElementById("complexFilter");r=e?e.value:null}if(!e||!t)return;const n="/admin/reports",a={dateFrom:e,dateTo:t};r&&"all"!==r&&(a.complexId=r);const s=await AdminUtils.authenticatedFetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const l=await s.json(),i=document.getElementById("topComplexesTable");if(!i)return;l.charts&&l.charts.reservasPorComplejo&&l.charts.reservasPorComplejo.length>0?i.innerHTML=l.charts.reservasPorComplejo.map(e=>`\n                <tr>\n                    <td><strong>${e.complejo}</strong></td>\n                    <td><span class="badge bg-primary">${e.cantidad||0}</span></td>\n                    <td><span class="text-success">$${formatCurrencyChile(parseInt(e.ingresos||0))}</span></td>\n                    <td><span class="badge bg-info">${Math.round(parseFloat(e.ocupacion_real||0))}%</span></td>\n                </tr>\n            `).join(""):i.innerHTML='\n                <tr>\n                    <td colspan="4" class="text-center text-muted">\n                        <i class="fas fa-info-circle me-2"></i>No hay datos disponibles\n                    </td>\n                </tr>\n            '}catch(e){console.error("❌ Error cargando Top Complejos:",e);const t=document.getElementById("topComplexesTable");t&&(t.innerHTML='\n                <tr>\n                    <td colspan="4" class="text-center text-danger">\n                        <i class="fas fa-exclamation-triangle me-2"></i>Error cargando datos\n                    </td>\n                </tr>\n            ')}}async function updateTopCourtsTable(){try{const e=document.getElementById("dateFrom")?.value,t=document.getElementById("dateTo")?.value,o=AdminUtils.getCurrentUser();let r=null;if(o&&"owner"===o.rol&&o.complejo_id)r=o.complejo_id;else{const e=document.getElementById("complexFilter");r=e?e.value:null}if(!e||!t)return;const n="/admin/reports",a={dateFrom:e,dateTo:t};r&&"all"!==r&&(a.complexId=r);const s=await AdminUtils.authenticatedFetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const l=await s.json(),i=document.getElementById("topCourtsTable");if(!i)return;l.tables&&l.tables.topCanchas&&l.tables.topCanchas.length>0?i.innerHTML=l.tables.topCanchas.map(e=>`\n                <tr>\n                    <td><strong>${e.cancha}</strong></td>\n                    <td>${e.complejo}</td>\n                    <td><span class="badge bg-primary">${e.reservas||0}</span></td>\n                    <td><span class="text-success">$${formatCurrencyChile(parseInt(e.ingresos||0))}</span></td>\n                </tr>\n            `).join(""):i.innerHTML='\n                <tr>\n                    <td colspan="4" class="text-center text-muted">\n                        <i class="fas fa-info-circle me-2"></i>No hay datos disponibles\n                    </td>\n                </tr>\n            '}catch(e){console.error("❌ Error cargando Top Canchas:",e);const t=document.getElementById("topCourtsTable");t&&(t.innerHTML='\n                <tr>\n                    <td colspan="4" class="text-center text-danger">\n                        <i class="fas fa-exclamation-triangle me-2"></i>Error cargando datos\n                    </td>\n                </tr>\n            ')}}async function updateCustomersTable(){try{const e=document.getElementById("dateFrom")?.value,t=document.getElementById("dateTo")?.value,o=AdminUtils.getCurrentUser();let r=null;if(o&&"owner"===o.rol&&o.complejo_id)r=o.complejo_id;else{const e=document.getElementById("complexFilter");r=e?e.value:null}if(!e||!t)return;let n="/admin/customers-analysis";const a=new URLSearchParams;a.append("dateFrom",e),a.append("dateTo",t),r&&a.append("complexId",r),a.toString()&&(n+="?"+a.toString());const s=await AdminUtils.authenticatedFetch(n);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const l=await s.json(),i=l.data?.clientesFrecuentes||[],c=document.querySelector("#customersTable");i.length,c&&(i.length>0?c.innerHTML=i.map(e=>`\n                <tr>\n                    <td>\n                        <div class="d-flex align-items-center">\n                            <div class="avatar me-3">\n                                <i class="fas fa-user-circle fa-2x text-primary"></i>\n                            </div>\n                            <div>\n                                <div class="fw-bold">${e.nombre_cliente}</div>\n                                <small class="text-muted">${e.email_cliente}</small>\n                                ${e.rut_cliente?`<br><small class="text-info"><i class="fas fa-id-card me-1"></i>${e.rut_cliente}</small>`:""}\n                                ${e.telefono_cliente?`<br><small class="text-success"><i class="fas fa-phone me-1"></i>${e.telefono_cliente}</small>`:""}\n                            </div>\n                        </div>\n                    </td>\n                    <td class="text-center">\n                        <span class="badge bg-primary">${e.total_reservas}</span>\n                    </td>\n                    <td class="text-center">\n                        <span class="badge bg-success">$${formatCurrencyChile(e.promedio_por_reserva)}</span>\n                    </td>\n                    <td class="text-center">\n                        <small class="text-muted">${new Date(e.ultima_reserva).toLocaleDateString()}</small>\n                    </td>\n                </tr>\n            `).join(""):c.innerHTML='\n                    <tr>\n                        <td colspan="4" class="text-center text-muted">\n                            <i class="fas fa-info-circle me-2"></i>No hay datos disponibles\n                        </td>\n                    </tr>\n                ')}catch(e){console.error("❌ Error cargando análisis de clientes:",e)}}function showNotification(e,t){const o="success"===t?"alert-success":"alert-danger",r="success"===t?"fa-check-circle":"fa-exclamation-triangle",n=document.createElement("div");n.className=`alert ${o} alert-dismissible fade show position-fixed`,n.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",n.innerHTML=`\n        <i class="fas ${r} me-2"></i>\n        ${e}\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}async function exportToPDF(e){try{showNotification(`Generando PDF de ${e}...`,"info");let t=[],o=[],r="",n="";switch(e){case"topComplexes":r="Top Complejos",n="Top_Complejos",o=["Complejo","Reservas","Ingresos","Ocupación"];document.querySelectorAll("#topComplexesTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=[o[0].textContent.trim(),o[1].textContent.trim(),o[2].textContent.trim(),o[3].textContent.trim()];t.push(e)}});break;case"topCourts":r="Top Canchas",n="Top_Canchas",o=["Cancha","Complejo","Reservas","Ingresos"];document.querySelectorAll("#topCourtsTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=[o[0].textContent.trim(),o[1].textContent.trim(),o[2].textContent.trim(),o[3].textContent.trim()];t.push(e)}});break;case"customers":r="Análisis de Clientes",n="Analisis_de_Clientes",o=["Cliente","Email","RUT","Teléfono","Reservas","Promedio","Última Reserva"];document.querySelectorAll("#customersTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=o[0].querySelector(".fw-bold")?.textContent.trim()||"",r=o[0].querySelector(".text-muted")?.textContent.trim()||"",n=o[0].querySelector(".text-info")?.textContent.replace(/.*fa-id-card.*?/,"").trim()||"",a=o[0].querySelector(".text-success")?.textContent.replace(/.*fa-phone.*?/,"").trim()||"",s=o[1].textContent.trim(),l=o[2].textContent.trim(),i=o[3].textContent.trim();t.push([e,r,n,a,s,l,i])}})}if(0===t.length)return void showNotification("No hay datos para exportar","error");"undefined"==typeof jspdf&&(showNotification("Cargando librería PDF...","info"),await loadJsPDF());const{jsPDF:a}=window.jspdf,s=new a,l=AdminUtils.getCurrentUser();let i="";if(l&&l.complejo_id&&complexes&&complexes.length>0){const e=complexes.find(e=>e.id===l.complejo_id);e&&(i=e.nombre.replace(/\s+/g,"_"))}if(l&&l.complejo_id)try{const e={1:"/images/logos/borde-rio.png",2:"/images/logos/borde-rio.png",7:"/images/logos/borde-rio.png",8:"/images/logos/demo3-new-life-galilea.png"}[l.complejo_id];if(e){const t=await fetch(e);if(t.ok){const e=await t.blob(),o=new FileReader;await new Promise(t=>{o.onloadend=()=>{try{s.addImage(o.result,"PNG",170,5,30,30)}catch(e){e.message}t()},o.onerror=()=>t(),o.readAsDataURL(e)})}}}catch(e){e.message}s.setFontSize(18),s.text(r,14,20),i&&(s.setFontSize(12),s.text(i.replace(/_/g," "),14,28)),s.setFontSize(10);const c=document.getElementById("dateFrom")?.value||"",d=document.getElementById("dateTo")?.value||"",u=i?35:28;s.text(`Período: ${c} - ${d}`,14,u),s.autoTable({head:[o],body:t,startY:u+7,theme:"grid",headStyles:{fillColor:[102,126,234],textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3}});let p=n;i&&(p+=`_${i}`),p+=`_${c}_${d}.pdf`,s.save(p),showNotification(`PDF descargado: ${p}`,"success")}catch(e){console.error("❌ Error exportando PDF:",e),showNotification(`Error exportando PDF: ${e.message}`,"error")}}async function exportToExcel(e){try{showNotification(`Generando Excel de ${e}...`,"info");let t=[],o=[],r="",n="";switch(e){case"topComplexes":r="Top Complejos",n="Top_Complejos",o=["Complejo","Reservas","Ingresos","Ocupación"];document.querySelectorAll("#topComplexesTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=[o[0].textContent.trim(),o[1].textContent.trim(),o[2].textContent.trim().replace("$",""),o[3].textContent.trim()];t.push(e)}});break;case"topCourts":r="Top Canchas",n="Top_Canchas",o=["Cancha","Complejo","Reservas","Ingresos"];document.querySelectorAll("#topCourtsTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=[o[0].textContent.trim(),o[1].textContent.trim(),o[2].textContent.trim(),o[3].textContent.trim().replace("$","")];t.push(e)}});break;case"customers":r="Análisis de Clientes",n="Analisis_de_Clientes",o=["Cliente","Email","RUT","Teléfono","Reservas","Promedio","Última Reserva"];document.querySelectorAll("#customersTable tr").forEach(e=>{const o=e.querySelectorAll("td");if(o.length>0&&!o[0].getAttribute("colspan")){const e=o[0].querySelector(".fw-bold")?.textContent.trim()||"",r=o[0].querySelector(".text-muted")?.textContent.trim()||"",n=o[0].querySelector(".text-info")?.textContent.replace(/.*fa-id-card.*?/,"").trim()||"",a=o[0].querySelector(".text-success")?.textContent.replace(/.*fa-phone.*?/,"").trim()||"",s=o[1].textContent.trim(),l=o[2].textContent.trim().replace("$",""),i=o[3].textContent.trim();t.push([e,r,n,a,s,l,i])}})}if(0===t.length)return void showNotification("No hay datos para exportar","error");const a=AdminUtils.getCurrentUser();let s="";if(a&&a.complejo_id&&complexes&&complexes.length>0){const e=complexes.find(e=>e.id===a.complejo_id);e&&(s=e.nombre.replace(/\s+/g,"_"))}const l=document.getElementById("dateFrom")?.value||"",i=document.getElementById("dateTo")?.value||"",c=[],d=s?`${r} - ${s.replace(/_/g," ")}`:r;c.push([d]),c.push([]),c.push([`Período: ${l} - ${i}`]),c.push([]),c.push(o),t.forEach(e=>{c.push(e)});const u=XLSX.utils.aoa_to_sheet(c);u["!ref"],u.A1||(u.A1={}),u.A1.s={font:{bold:!0,sz:16,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"E67E22"}},alignment:{horizontal:"center",vertical:"center"}};const p=XLSX.utils.encode_cell({r:2,c:0});u[p]&&(u[p].s={font:{bold:!0,sz:11,color:{rgb:"34495E"}},fill:{fgColor:{rgb:"ECF0F1"}},alignment:{horizontal:"left",vertical:"center"}});const m=5,f={topComplexes:"3498DB",topCourts:"9B59B6",customers:"1ABC9C"}[e]||"5DADE2";o.forEach((e,t)=>{const o=XLSX.utils.encode_cell({r:m-1,c:t});u[o]&&(u[o].s={font:{bold:!0,sz:11,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:f}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"medium",color:{rgb:"2C3E50"}},bottom:{style:"medium",color:{rgb:"2C3E50"}},left:{style:"thin",color:{rgb:"2C3E50"}},right:{style:"thin",color:{rgb:"2C3E50"}}}})});const h=XLSX.utils.decode_range(u["!ref"]);for(let t=m;t<=h.e.r;++t){const o=(t-m)%2==0;for(let r=h.s.c;r<=h.e.c;++r){const n=XLSX.utils.encode_cell({r:t,c:r});u[n]&&(u[n].s||(u[n].s={}),u[n].s.fill={fgColor:{rgb:o?"F7F9FB":"FFFFFF"}},u[n].s.border={top:{style:"thin",color:{rgb:"D5DBDB"}},bottom:{style:"thin",color:{rgb:"D5DBDB"}},left:{style:"thin",color:{rgb:"D5DBDB"}},right:{style:"thin",color:{rgb:"D5DBDB"}}},u[n].s.alignment="customers"===e?4===r||5===r?{horizontal:"right",vertical:"center"}:6===r?{horizontal:"center",vertical:"center"}:{horizontal:"left",vertical:"center"}:{horizontal:"center",vertical:"center"})}}u["!cols"]="customers"===e?[{wch:28},{wch:32},{wch:16},{wch:14},{wch:12},{wch:14},{wch:16}]:o.map(()=>({wch:20})),u["!merges"]=[{s:{r:0,c:0},e:{r:0,c:o.length-1}},{s:{r:2,c:0},e:{r:2,c:o.length-1}}],u["!rows"]=[],u["!rows"][0]={hpt:28},u["!rows"][2]={hpt:20},u["!rows"][4]={hpt:24};for(let e=5;e<=h.e.r;e++)u["!rows"][e]={hpt:21};h.e.r,u["!rows"].length;const g=XLSX.utils.book_new();XLSX.utils.book_append_sheet(g,u,r.substring(0,31));let C=n;s&&(C+=`_${s}`),C+=`_${l}_${i}.xlsx`,XLSX.writeFile(g,C),showNotification(`Excel descargado: ${C}`,"success")}catch(e){console.error("❌ Error exportando Excel:",e),showNotification(`Error exportando Excel: ${e.message}`,"error")}}async function loadJsPDF(){return new Promise((e,t)=>{if(void 0!==window.jspdf)return void e();const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",o.onload=()=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)},o.onerror=t,document.head.appendChild(o)})}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="../../admin-login.html"}function forzarVisibilidadElementos(){const e=AdminUtils.getCurrentUser();if(e&&("owner"===e.rol||"super_admin"===e.rol)){['a[href="admin-gastos.html"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.classList.add("owner-visible"),e.classList.remove("hide-for-owner"),e.style.display="block",e.style.visibility="visible",e.style.opacity="1"})})}}document.addEventListener("DOMContentLoaded",async function(){if("undefined"==typeof Chart)return console.error("❌ Chart.js no está disponible"),void showNotification("Error: Chart.js no está disponible. Recarga la página.","error");Chart.version,AdminUtils.initializeRoleSystem()&&(AdminUtils.setupLogout(),currentUser=AdminUtils.getCurrentUser(),document.getElementById("adminWelcome").textContent=`Bienvenido, ${currentUser.nombre}`,await loadComplexes(),await aplicarPermisosPorRol(),AdminUtils.hideElementsByRole(),setupEventListeners(),setDefaultDates(),generateReports(),setTimeout(()=>{verifyDownloadButtons()},1e3))}),setInterval(forzarVisibilidadElementos,2e3);