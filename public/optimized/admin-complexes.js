let currentUser=null,complexes=[],cities=[];function setupEventListeners(){document.getElementById("searchComplex").addEventListener("input",function(){filterComplexes(this.value)})}async function loadCities(){try{const e=await AdminUtils.authenticatedFetch("/ciudades");e.ok?(cities=await e.json(),populateCitySelect()):console.error("Error cargando ciudades:",e.statusText)}catch(e){console.error("Error:",e)}}function populateCitySelect(){const e=document.getElementById("complexCity");e.innerHTML='<option value="">Seleccionar ciudad...</option>',cities.forEach(o=>{const t=document.createElement("option");t.value=o.id,t.textContent=o.nombre,e.appendChild(t)})}async function loadComplexes(){try{const e=await AdminUtils.authenticatedFetch("/admin/complejos");if(!e)return void console.error("❌ No se recibió respuesta");e.ok?(complexes=await e.json(),displayComplexes(complexes)):(console.error("❌ Error cargando complejos:",e.statusText),document.getElementById("complexesList").innerHTML=`\n                <div class="alert alert-danger">\n                    <i class="fas fa-exclamation-triangle me-2"></i>\n                    Error cargando complejos: ${e.statusText}\n                </div>\n            `)}catch(e){console.error("Error:",e),document.getElementById("complexesList").innerHTML='\n            <div class="alert alert-danger">\n                <i class="fas fa-exclamation-triangle me-2"></i>\n                Error de conexión\n            </div>\n        '}}function displayComplexes(e){const o=document.getElementById("complexesList");0!==e.length?o.innerHTML=e.map(e=>`\n        <div class="complex-card">\n            <div class="row">\n                <div class="col-md-8">\n                    <h5 class="mb-2">\n                        <i class="fas fa-building me-2"></i>\n                        ${e.nombre}\n                    </h5>\n                    <p class="text-muted mb-2">\n                        <i class="fas fa-map-marker-alt me-2"></i>\n                        ${getCityName(e.ciudad_id)}\n                    </p>\n                    <p class="mb-2">${e.direccion}</p>\n                    <p class="mb-0">\n                        <i class="fas fa-phone me-2"></i>\n                        ${e.telefono}\n                    </p>\n                </div>\n                <div class="col-md-4 text-end">\n                    <div class="btn-group-vertical" role="group">\n                        <button class="btn btn-outline-primary btn-sm mb-2" onclick="viewComplexDetails(${e.id})">\n                            <i class="fas fa-eye me-1"></i>\n                            Ver Detalles\n                        </button>\n                        <button class="btn btn-outline-warning btn-sm mb-2" onclick="editComplex(${e.id})">\n                            <i class="fas fa-edit me-1"></i>\n                            Editar\n                        </button>\n                        <button class="btn btn-outline-danger btn-sm" onclick="deleteComplex(${e.id})">\n                            <i class="fas fa-trash me-1"></i>\n                            Eliminar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `).join(""):o.innerHTML='\n            <div class="alert alert-info">\n                <i class="fas fa-info-circle me-2"></i>\n                No se encontraron complejos\n            </div>\n        '}function getCityName(e){const o=cities.find(o=>o.id===e);return o?o.nombre:"Ciudad no encontrada"}function filterComplexes(e){displayComplexes(complexes.filter(o=>o.nombre.toLowerCase().includes(e.toLowerCase())||getCityName(o.ciudad_id).toLowerCase().includes(e.toLowerCase())))}function openComplexModal(e=null){const o=document.getElementById("complexModal"),t=document.getElementById("complexModalTitle"),n=document.getElementById("complexForm");e?(t.textContent="Editar Complejo",loadComplexData(e)):(t.textContent="Agregar Nuevo Complejo",n.reset());new bootstrap.Modal(o).show()}async function loadComplexData(e){try{const o=complexes.find(o=>o.id===e);o&&(document.getElementById("complexName").value=o.nombre,document.getElementById("complexCity").value=o.ciudad_id,document.getElementById("complexAddress").value=o.direccion,document.getElementById("complexPhone").value=o.telefono,document.getElementById("complexDescription").value=o.descripcion||"")}catch(e){console.error("Error cargando datos del complejo:",e)}}async function saveComplex(){const e=document.getElementById("complexForm");if(!e.checkValidity())return void e.reportValidity();const o={nombre:document.getElementById("complexName").value,ciudad_id:parseInt(document.getElementById("complexCity").value),direccion:document.getElementById("complexAddress").value,telefono:document.getElementById("complexPhone").value,descripcion:document.getElementById("complexDescription").value},t=document.getElementById("complexModal").dataset.complexId,n=!!t;try{const e=localStorage.getItem("adminToken");if(!e)return showNotification("Sesión expirada. Por favor, inicie sesión nuevamente.","error"),void(window.location.href="../../admin-login.html");const i=n?`/admin/complejos/${t}`:"/admin/complejos",a=n?"PUT":"POST",l=await AdminUtils.authenticatedFetch(i,{method:a,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)});if(l.ok){await l.json();showNotification(n?"Complejo actualizado exitosamente":"Complejo creado exitosamente","success");bootstrap.Modal.getInstance(document.getElementById("complexModal")).hide(),loadComplexes()}else{showNotification((await l.json()).message||"Error al guardar el complejo","error")}}catch(e){console.error("Error:",e),showNotification("Error de conexión","error")}}function editComplex(e){openComplexModal(e)}async function deleteComplex(e){if(confirm("¿Estás seguro de que quieres eliminar este complejo?"))try{const o=localStorage.getItem("adminToken"),t=await AdminUtils.authenticatedFetch(`/admin/complejos/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}});if(t.ok)showNotification("Complejo eliminado exitosamente","success"),loadComplexes();else{showNotification((await t.json()).message||"Error al eliminar el complejo","error")}}catch(e){console.error("Error:",e),showNotification("Error de conexión","error")}}function viewComplexDetails(e){const o=complexes.find(o=>o.id===e);if(o){const e=getCityName(o.ciudad_id);alert(`Detalles del Complejo:\n\nNombre: ${o.nombre}\nCiudad: ${e}\nDirección: ${o.direccion}\nTeléfono: ${o.telefono}\nDescripción: ${o.descripcion||"Sin descripción"}`)}}function showNotification(e,o){const t="success"===o?"alert-success":"alert-danger",n="success"===o?"fa-check-circle":"fa-exclamation-triangle",i=document.createElement("div");i.className=`alert ${t} alert-dismissible fade show position-fixed`,i.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",i.innerHTML=`\n        <i class="fas ${n} me-2"></i>\n        ${e}\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},5e3)}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="../../admin-login.html"}document.addEventListener("DOMContentLoaded",function(){AdminUtils.initializeRoleSystem()&&(AdminUtils.hideElementsByRole(),AdminUtils.setupLogout(),currentUser=AdminUtils.getCurrentUser(),document.getElementById("adminWelcome").textContent=`Bienvenido, ${currentUser.nombre}`,loadCities(),loadComplexes(),setupEventListeners())});