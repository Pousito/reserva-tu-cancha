let reservas=[],reservasFiltradas=[],complejos=[],busquedaActual="",filtrosActivos={};function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}if(void 0===formatearHora)function formatearHora(e){if(!e)return"";if(e.includes(":")){const a=e.split(":");return`${a[0]}:${a[1]}`}return e}let vistaActual="lista",semanaActual=new Date,calendarioData={},canchas=[],bloqueoTemporalAdmin=null;function aplicarPermisosPorRol(){const e=AdminUtils.getCurrentUser();if(!e)return;const a=e.rol,n=document.querySelector('a[href="admin-complexes.html"]'),o=document.querySelector('a[href="admin-reports.html"]'),t=document.querySelector('a[href="/admin-gastos.html"]')||document.querySelector('a[href="admin-gastos.html"]');if("manager"===a?(n&&(n.style.display="none"),o&&(o.style.display="none"),t&&(t.style.display="none")):"owner"===a?(n&&(n.style.display="none"),o&&(o.style.display="block",o.style.visibility="visible",o.classList.remove("hide-for-manager")),t&&(t.style.display="block",t.style.visibility="visible",t.classList.remove("hide-for-manager"))):"super_admin"===a&&(n&&(n.style.display="block",n.style.visibility="visible"),o&&(o.style.display="block",o.style.visibility="visible",o.classList.remove("hide-for-manager")),t&&(t.style.display="block",t.style.visibility="visible",t.classList.remove("hide-for-manager"))),"manager"===a){document.querySelectorAll('[data-role="reports"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-role="all-complexes"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-role*="owner"], [data-role*="super_admin"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-role="complex-filter"]').forEach(e=>{e.style.display="none"});const e=document.getElementById("selectorComplejoCalendario");e&&(e.style.display="none"),document.querySelectorAll('[data-role="commission"]').forEach(e=>{e.style.display="none"});document.querySelectorAll("th").forEach(e=>{"Precio"===e.textContent.trim()&&(e.style.display="table-cell")}),actualizarColspanCarga()}else if("owner"===a){document.querySelectorAll('[data-role="all-complexes"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-role="complex-filter"]').forEach(e=>{e.style.display="none"});const e=document.getElementById("selectorComplejoCalendario");e&&(e.style.display="none")}else if("super_admin"===a){const e=document.getElementById("selectorComplejoCalendario");e&&(e.style.display="block");const a=document.querySelectorAll(".hide-for-manager, .hide-for-owner");a.length,a.forEach((e,a)=>{e.classList.remove("hide-for-manager"),e.classList.remove("hide-for-owner"),e.style.display="",e.style.visibility=""})}actualizarTituloCalendarioPorRol()}function actualizarColspanCarga(){const e=AdminUtils.getCurrentUser(),a=e&&"manager"===e.rol?"10":"11",n=document.getElementById("loadingRow");n&&n.setAttribute("colspan",a)}function configurarEventListeners(){const e=document.getElementById("complejoFilter"),a=document.getElementById("estadoFilter"),n=document.getElementById("tipoReservaFilter"),o=document.getElementById("fechaDesde"),t=document.getElementById("fechaHasta"),r=document.getElementById("ordenamientoFilter");e&&e.addEventListener("change",aplicarFiltros),a&&a.addEventListener("change",aplicarFiltros),n&&n.addEventListener("change",aplicarFiltros),o&&o.addEventListener("change",aplicarFiltros),t&&t.addEventListener("change",aplicarFiltros),r&&r.addEventListener("change",aplicarFiltros),o&&o.addEventListener("change",function(){this.blur()}),t&&t.addEventListener("change",function(){this.blur()})}async function cargarComplejos(){try{const e=AdminUtils.getCurrentUser();if(!AdminUtils.canViewAllComplexes()&&"owner"!==e.rol)return;const a=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/complejos`);if(!a)return;a.ok?(complejos=await a.json(),llenarSelectComplejos()):console.error("Error al cargar complejos")}catch(e){console.error("Error:",e)}}function llenarSelectComplejos(){const e=AdminUtils.getCurrentUser(),a=document.getElementById("complejoFilter"),n=document.getElementById("complejoCalendario");a.innerHTML='<option value="">Todos los complejos</option>',n.innerHTML='<option value="">Todos los complejos</option>',complejos.forEach(e=>{const o=document.createElement("option");o.value=e.id,o.textContent=e.nombre,a.appendChild(o);const t=document.createElement("option");t.value=e.id,t.textContent=e.nombre,n.appendChild(t)}),e&&("manager"===e.rol||"owner"===e.rol)&&e.complejo_id&&n&&(n.value=e.complejo_id),actualizarTituloCalendarioPorRol()}function actualizarTituloCalendarioPorRol(){const e=AdminUtils.getCurrentUser(),a=document.getElementById("tituloCalendario");if(!e||!a)return;const n=e.rol,o=e.complejo_nombre||"Complejo";if("super_admin"===n)actualizarTituloCalendario();else if("owner"===n||"manager"===n){const e=o.startsWith("Complejo ")?o.substring(9):o;a.innerHTML=`<i class="fas fa-calendar-week me-2"></i>Calendario Semanal - ${e}`}}function actualizarTituloCalendario(){const e=AdminUtils.getCurrentUser(),a=document.getElementById("complejoCalendario"),n=document.getElementById("tituloCalendario");if(!a||!n)return;if(e&&"super_admin"!==e.rol)return;const o=a.value;if(o){const e=complejos.find(e=>e.id==o);if(e){const a=e.nombre.startsWith("Complejo ")?e.nombre.substring(9):e.nombre;n.innerHTML=`<i class="fas fa-calendar-week me-2"></i>Calendario Semanal - ${a}`}}else n.innerHTML='<i class="fas fa-calendar-week me-2"></i>Calendario Semanal - Todos los Complejos'}async function cargarReservas(){try{const e=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/reservas`);if(!e)return;if(e.ok){const a=await e.json(),n=Array.isArray(a)?a:a.reservas||[];if(n&&n.length>0&&n.slice(0,3).forEach((e,a)=>{e.codigo_reserva,e.precio_total,e.precio_total}),Array.isArray(a))reservas=a;else{if(!a.reservas||!Array.isArray(a.reservas))return console.error("❌ Formato de datos inesperado:",a),void mostrarError("Formato de datos inesperado");reservas=a.reservas}reservasFiltradas=[...reservas],window.reservasData=reservas,reservas.length,mostrarReservas(reservasFiltradas),actualizarContador()}else console.error("❌ Error en respuesta:",e.status,e.statusText),mostrarError("Error al cargar las reservas")}catch(e){console.error("Error:",e),mostrarError("Error de conexión")}}function aplicarFiltros(){aplicarFiltrosAvanzados()}function mostrarReservas(e){const a=document.getElementById("reservationsTableBody"),n=AdminUtils.getCurrentUser(),o=n&&"manager"===n.rol,t=o?"10":"11";if(0===e.length)return void(a.innerHTML=`\n            <tr>\n                <td colspan="${t}" class="text-center text-muted">\n                    <i class="fas fa-inbox"></i> No se encontraron reservas\n                </td>\n            </tr>\n        `);const r=e.map(e=>{const a=busquedaActual?resaltarTexto(e.codigo_reserva,busquedaActual):e.codigo_reserva,n=busquedaActual?resaltarTexto(e.nombre_cliente||"Sin nombre",busquedaActual):e.nombre_cliente||"Sin nombre",t=e.tipo_reserva||"directa";let r=0,i=0;"directa"===t?(i=3.5,r=Math.round(.035*e.precio_total)):(i=1.75,r=Math.round(.0175*e.precio_total));let s=`\n        <tr>\n            <td>\n                <code>${a}</code>\n            </td>\n            <td>\n                <div>\n                    <strong>${n}</strong>\n                    <br>\n                    <small class="text-muted">${e.email_cliente||"Sin email"}</small>\n                    ${e.telefono_cliente?`<br><small class="text-muted"><i class="fas fa-phone me-1"></i>${e.telefono_cliente}</small>`:""}\n                </div>\n            </td>\n            <td>${e.complejo_nombre}</td>\n            <td>${e.cancha_nombre}</td>\n            <td>${e.fecha?formatearFechaParaAPI(e.fecha):"Sin fecha"}</td>\n            <td>\n                <span class="badge bg-light text-dark">\n                    ${formatearHora(e.hora_inicio)} - ${formatearHora(e.hora_fin)}\n                </span>\n            </td>\n            <td>\n                ${null!==e.precio_total&&void 0!==e.precio_total&&""!==e.precio_total?`<strong>$${formatCurrencyChile(e.precio_total)}</strong>`:'<span class="text-muted">-</span>'}\n            </td>\n            <td>\n                <span class="badge badge-tipo badge-${t}">\n                    ${"directa"===t?"Web":"Admin"}\n                </span>\n                ${"directa"===t?`\n                    <i class="fas fa-info-circle ms-1 text-info" \n                       style="cursor: pointer;" \n                       onclick="mostrarInfoPago('${e.codigo_reserva}', ${e.porcentaje_pagado||100}, ${e.precio_total||0})"\n                       title="Ver información de pago"></i>\n                `:""}\n            </td>`;return o||(s+=`\n            <td>\n                <div class="comision-info">\n                    <strong>$${formatCurrencyChile(r)}</strong>\n                    <br>\n                    <small>${i}%</small>\n                </div>\n            </td>`),s+=`\n            <td>\n                <span class="badge badge-status badge-${e.estado}">\n                    ${e.estado.charAt(0).toUpperCase()+e.estado.slice(1)}\n                </span>\n            </td>\n            <td class="reservation-actions">\n                <button class="btn btn-sm btn-outline-primary btn-action" onclick="verDetalles('${e.codigo_reserva}')" title="Ver detalles">\n                    <i class="fas fa-eye"></i>\n                </button>\n                ${"pendiente"===e.estado?`\n                    <button class="btn btn-sm btn-outline-success btn-action" onclick="confirmarReserva('${e.codigo_reserva}')" title="Confirmar">\n                        <i class="fas fa-check"></i>\n                    </button>\n                `:""}\n                ${"cancelada"!==e.estado?`\n                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="cancelarReserva('${e.codigo_reserva}')" title="Cancelar">\n                        <i class="fas fa-times"></i>\n                    </button>\n                `:""}\n            </td>\n        </tr>`,s}).join("");a.innerHTML=r}function verDetalles(e){const a=reservas.find(a=>a.codigo_reserva===e);if(!a)return;document.getElementById("reservationModalBody").innerHTML=`\n        <div class="row">\n            <div class="col-md-6">\n                <h6>Información del Cliente</h6>\n                <p><strong>Nombre:</strong> ${a.nombre_cliente}</p>\n                <p><strong>Email:</strong> ${a.email_cliente}</p>\n                <p><strong>RUT:</strong> ${a.rut_cliente}</p>\n                ${a.telefono_cliente?`<p><strong>Teléfono:</strong> ${a.telefono_cliente}</p>`:""}\n            </div>\n            <div class="col-md-6">\n                <h6>Detalles de la Reserva</h6>\n                <p><strong>Código:</strong> <code>${a.codigo_reserva}</code></p>\n                <p><strong>Complejo:</strong> ${a.complejo_nombre}</p>\n                <p><strong>Cancha:</strong> ${a.cancha_nombre}</p>\n                <p><strong>Fecha:</strong> ${formatearFechaParaAPI(a.fecha)}</p>\n                <p><strong>Hora:</strong> ${formatearHora(a.hora_inicio)} - ${formatearHora(a.hora_fin)}</p>\n                <p><strong>Precio:</strong> ${a.precio_total?`$${formatCurrencyChile(a.precio_total)}`:"No disponible"}</p>\n                <p><strong>Estado:</strong> \n                    <span class="badge badge-status badge-${a.estado}">\n                        ${a.estado.charAt(0).toUpperCase()+a.estado.slice(1)}\n                    </span>\n                </p>\n            </div>\n        </div>\n        <div class="row mt-3">\n            <div class="col-12">\n                <h6>Información Adicional</h6>\n                <p><strong>Fecha de Creación:</strong> ${formatearFechaHora(a.created_at)}</p>\n                <p><strong>ID de Transacción:</strong> ${a.transaction_id||"N/A"}</p>\n            </div>\n        </div>\n    `;new bootstrap.Modal(document.getElementById("reservationModal")).show()}async function confirmarReserva(e){if(confirm("¿Estás seguro de que quieres confirmar esta reserva?"))try{const a=localStorage.getItem("adminToken");(await fetch(`${API_BASE}/admin/reservas/${e}/confirmar`,{method:"PUT",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}})).ok?(mostrarNotificacion("Reserva confirmada exitosamente","success"),cargarReservas(),"calendario"===vistaActual&&cargarCalendario()):mostrarNotificacion("Error al confirmar la reserva","danger")}catch(e){console.error("Error:",e),mostrarNotificacion("Error de conexión","danger")}}async function cancelarReserva(e){if(confirm("¿Estás seguro de que quieres cancelar esta reserva?"))try{const a=localStorage.getItem("adminToken");(await fetch(`${API_BASE}/admin/reservas/${e}/cancelar`,{method:"PUT",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}})).ok?(mostrarNotificacion("Reserva cancelada exitosamente","success"),cargarReservas(),"calendario"===vistaActual&&cargarCalendario()):mostrarNotificacion("Error al cancelar la reserva","danger")}catch(e){console.error("Error:",e),mostrarNotificacion("Error de conexión","danger")}}function formatearFecha(e){if(!e)return"Sin fecha";try{let a;if(e instanceof Date)a=e;else if("string"==typeof e)if(e.includes("T")){const n=new Date(e);if(isNaN(n.getTime()))throw new Error("Fecha inválida");{const e=n.getUTCFullYear(),o=n.getUTCMonth(),t=n.getUTCDate();a=new Date(e,o,t)}}else{const[n,o,t]=e.split("-").map(Number);a=new Date(n,o-1,t)}else a=new Date(e);if(isNaN(a.getTime()))throw new Error("Fecha inválida");return a.toLocaleDateString("es-CL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}catch(a){return console.error("Error formateando fecha:",a,"Fecha original:",e),"Fecha inválida"}}function formatearFechaHora(e){return new Date(e).toLocaleString("es-CL",{timeZone:"America/Santiago"})}function mostrarError(e){const a=document.getElementById("reservationsTableBody"),n=AdminUtils.getCurrentUser(),o=n&&"manager"===n.rol?"10":"11";a.innerHTML=`\n        <tr>\n            <td colspan="${o}" class="text-center text-danger">\n                <i class="fas fa-exclamation-triangle"></i> ${e}\n            </td>\n        </tr>\n    `}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="../../admin-login.html"}function mostrarNotificacion(e,a,n=5e3){const o=document.createElement("div");o.className=`alert alert-${a} alert-dismissible fade show position-fixed`,o.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);",o.innerHTML=`\n        <div class="d-flex align-items-start">\n            <div class="flex-grow-1">\n                ${e}\n            </div>\n            <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>\n        </div>\n    `,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.remove()},n)}function buscarReservas(){const e=document.getElementById("searchInput").value.toLowerCase().trim();busquedaActual=e,aplicarFiltrosAvanzados()}function limpiarBusqueda(){document.getElementById("searchInput").value="",busquedaActual="",aplicarFiltrosAvanzados()}function toggleFiltrosAvanzados(){const e=document.getElementById("filtrosAvanzados"),a=event.target;"none"===e.style.display?(e.style.display="block",a.innerHTML='<i class="fas fa-filter me-2"></i>Ocultar Filtros',a.classList.remove("btn-primary"),a.classList.add("btn-outline-primary")):(e.style.display="none",a.innerHTML='<i class="fas fa-filter me-2"></i>Filtros Avanzados',a.classList.remove("btn-outline-primary"),a.classList.add("btn-primary"))}function aplicarFiltrosAvanzados(){const e=document.getElementById("complejoFilter")?.value||"",a=document.getElementById("estadoFilter")?.value||"",n=document.getElementById("tipoReservaFilter")?.value||"",o=document.getElementById("fechaDesde")?.value||"",t=document.getElementById("fechaHasta")?.value||"",r=document.getElementById("ordenamientoFilter")?.value||"";filtrosActivos={complejo:e,estado:a,tipoReserva:n,fechaDesde:o,fechaHasta:t,ordenamiento:r};let i=[...reservas];e&&(i=i.filter(a=>a.complejo_id==e)),a&&(i=i.filter(e=>e.estado===a)),n&&(i=i.filter(e=>e.tipo_reserva===n)),o&&(i=i.filter(e=>formatearFechaParaAPI(e.fecha)>=o)),t&&(i=i.filter(e=>formatearFechaParaAPI(e.fecha)<=t)),busquedaActual&&""!==busquedaActual.trim()&&(i=i.filter(e=>{const a=(e.codigo_reserva||"").toLowerCase(),n=(e.nombre_cliente||"").toLowerCase(),o=(e.email_cliente||"").toLowerCase();return a.includes(busquedaActual)||n.includes(busquedaActual)||o.includes(busquedaActual)})),r&&(i=aplicarOrdenamiento(i,r)),reservasFiltradas=i,mostrarReservas(reservasFiltradas),actualizarContador()}function aplicarOrdenamiento(e,a){const n=[...e];switch(a){case"fecha_reserva_asc":n.sort((e,a)=>{const n=formatearFechaParaAPI(e.fecha),o=formatearFechaParaAPI(a.fecha);if(n!==o)return new Date(n)-new Date(o);const t=e.hora_inicio||"00:00:00",r=a.hora_inicio||"00:00:00";return t.localeCompare(r)});break;case"fecha_reserva_desc":n.sort((e,a)=>{const n=formatearFechaParaAPI(e.fecha),o=formatearFechaParaAPI(a.fecha);if(n!==o)return new Date(o)-new Date(n);const t=e.hora_inicio||"00:00:00";return(a.hora_inicio||"00:00:00").localeCompare(t)});break;case"fecha_creacion_asc":n.sort((e,a)=>new Date(e.created_at)-new Date(a.created_at));break;case"fecha_creacion_desc":n.sort((e,a)=>{const n=new Date(e.created_at);return new Date(a.created_at)-n})}return n}function limpiarFiltros(){document.getElementById("searchInput").value="",busquedaActual="";const e=document.getElementById("complejoFilter"),a=document.getElementById("estadoFilter"),n=document.getElementById("tipoReservaFilter"),o=document.getElementById("fechaDesde"),t=document.getElementById("fechaHasta"),r=document.getElementById("ordenamientoFilter");e&&(e.value=""),a&&(a.value=""),n&&(n.value=""),o&&(o.value=""),t&&(t.value=""),r&&(r.value=""),filtrosActivos={},reservasFiltradas=[...reservas],mostrarReservas(reservasFiltradas),actualizarContador()}function actualizarContador(){const e=reservasFiltradas.length,a=document.getElementById("totalReservas");0===e?(a.textContent="0",a.className="badge bg-secondary ms-2"):e===reservas.length?(a.textContent=e,a.className="badge bg-primary ms-2"):(a.textContent=`${e} de ${reservas.length}`,a.className="badge bg-info ms-2")}function resaltarTexto(e,a){if(!a||""===a)return e;const n=new RegExp(`(${a})`,"gi");return e.replace(n,'<span class="search-highlight">$1</span>')}function mostrarVista(e){vistaActual=e;const a=document.getElementById("btnLista"),n=document.getElementById("btnCalendario"),o=document.getElementById("vistaLista"),t=document.getElementById("vistaCalendario");"lista"===e?(a.className="btn btn-primary",n.className="btn btn-outline-primary",o.style.display="block",t.style.display="none"):(a.className="btn btn-outline-primary",n.className="btn btn-primary",o.style.display="none",t.style.display="block",cargarCalendario())}async function cargarCalendario(){try{const e=AdminUtils.getCurrentUser();let a="";if(!e||"manager"!==e.rol&&"owner"!==e.rol){if(e&&"super_admin"===e.rol){const e=document.getElementById("complejoCalendario");a=e?e.value:""}}else a=e.complejo_id||"";const n=obtenerInicioSemana(semanaActual),o=obtenerFinSemana(semanaActual);e.rol;const t=document.getElementById("calendarGrid");t&&(t.innerHTML='<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Cargando calendario...</div>');const r=await fetch(`${API_BASE}/admin/calendar/week?fechaInicio=${n}&fechaFin=${o}&complejoId=${a}`,{headers:{Authorization:`Bearer ${AdminUtils.getAuthToken()}`}});if(r.ok){const e=await r.json();calendarioData=e.calendario||{},canchas=e.canchas||[],e.horarios,calendarioData["2025-09-12"]&&calendarioData["2025-09-12"],renderizarCalendario(e),actualizarRangoSemana()}else{if(console.error("Error al cargar calendario:",r.status,r.statusText),401===r.status)return void window.location.reload();const e=document.getElementById("calendarGrid");e&&(e.innerHTML=`\n                    <div class="text-center p-4">\n                        <div class="alert alert-warning" role="alert">\n                            <i class="fas fa-exclamation-triangle me-2"></i>\n                            <strong>Error al cargar el calendario</strong>\n                            <br>\n                            <small>Error ${r.status}: ${r.statusText}</small>\n                            <br>\n                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="cargarCalendario()">\n                                <i class="fas fa-redo me-1"></i>Reintentar\n                            </button>\n                        </div>\n                    </div>\n                `),await cargarCalendarioRespaldo(n,o,a)}}catch(e){console.error("Error al cargar calendario:",e);const a=document.getElementById("calendarGrid");a&&(a.innerHTML='\n                <div class="text-center p-4">\n                    <div class="alert alert-danger" role="alert">\n                        <i class="fas fa-exclamation-circle me-2"></i>\n                        <strong>Error de conexión</strong>\n                        <br>\n                        <small>No se pudo conectar con el servidor</small>\n                        <br>\n                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="cargarCalendario()">\n                            <i class="fas fa-redo me-1"></i>Reintentar\n                        </button>\n                    </div>\n                </div>\n            ')}}async function cargarCalendarioRespaldo(e,a,n){try{const n=await fetch(`${API_BASE}/admin/reservas?fechaDesde=${e}&fechaHasta=${a}`,{headers:{Authorization:`Bearer ${AdminUtils.getAuthToken()}`}});if(n.ok){const o=(await n.json()).reservas||[];o.length;renderizarCalendarioBasico({semana:{inicio:e,fin:a,dias:generarDiasSemana(e)},canchas:[],horarios:generarHorariosBasicos(),reservas:o,bloqueos:[],calendario:procesarReservasParaCalendario(o)})}else await cargarCalendarioOffline(e,a)}catch(n){console.error("❌ Error en función de respaldo:",n),await cargarCalendarioOffline(e,a)}}async function cargarCalendarioOffline(e,a){try{if(!e||!a)return console.error("❌ Fechas no válidas para calendario offline"),void mostrarCalendarioVacio(e||"N/A",a||"N/A");const n=window.reservasData||[];if(n.length,!Array.isArray(n)||0===n.length)return void mostrarCalendarioVacio(e,a);const o=n.filter(n=>{const o=new Date(n.fecha),t=new Date(e),r=new Date(a);return o>=t&&o<=r});o.length;renderizarCalendarioOffline({semana:{inicio:e,fin:a,dias:generarDiasSemana(e)},canchas:[],horarios:generarHorariosBasicos(),reservas:o,bloqueos:[],calendario:procesarReservasParaCalendario(o)})}catch(n){console.error("❌ Error en calendario offline:",n),mostrarCalendarioVacio(e,a)}}function mostrarCalendarioVacio(e,a){const n=document.getElementById("calendarGrid");n&&(n.innerHTML=`\n        <div class="text-center p-4">\n            <div class="alert alert-info" role="alert">\n                <i class="fas fa-calendar-alt me-2"></i>\n                <strong>Calendario Offline</strong>\n                <br>\n                <small>Mostrando calendario básico para ${e} a ${a}</small>\n                <br>\n                <small class="text-muted">No hay reservas en este rango de fechas</small>\n                <br>\n                <button class="btn btn-sm btn-outline-primary mt-2" onclick="cargarCalendario()">\n                    <i class="fas fa-sync me-1"></i>Reintentar Conexión\n                </button>\n            </div>\n        </div>\n    `)}function renderizarCalendarioOffline(e){const a=document.getElementById("calendarGrid");if(!a)return;let n='<div class="calendar-grid-offline">';n+=`\n        <div class="alert alert-warning mb-3" role="alert">\n            <i class="fas fa-wifi me-2"></i>\n            <strong>Modo Offline</strong> - Mostrando datos limitados (${e.reservas.length} reservas)\n            <br>\n            <small class="text-muted">\n                El servidor tiene problemas temporales. Usando datos de respaldo.\n                <a href="#" onclick="verificarEstadoServidor()" class="text-decoration-none">Verificar estado del servidor</a>\n            </small>\n            <div class="mt-2">\n                <button class="btn btn-sm btn-outline-primary me-2" onclick="cargarCalendario()">\n                    <i class="fas fa-sync me-1"></i>Reintentar Conexión\n                </button>\n                <button class="btn btn-sm btn-outline-success me-2" onclick="limpiarCacheYRecargar()">\n                    <i class="fas fa-broom me-1"></i>Limpiar Caché\n                </button>\n                <button class="btn btn-sm btn-outline-info" onclick="mostrarInfoOffline()">\n                    <i class="fas fa-info-circle me-1"></i>¿Por qué offline?\n                </button>\n            </div>\n        </div>\n    `,n+='<div class="calendar-header">',n+='<div class="calendar-time-slot">Hora</div>',e.semana.dias.forEach(e=>{n+=`<div class="calendar-day-header">${e.nombre}<br><small>${e.dia}</small></div>`}),n+="</div>";(e.horarios[0]?.horarios||[]).filter(e=>e.hora>=8&&e.hora<=22).forEach(a=>{n+='<div class="calendar-time-slot">',n+=`<div class="time-label">${a.label}</div>`,e.semana.dias.forEach(o=>{const t=e.calendario[o.fecha]?.[a.label]||[],r=t.length>0?"calendar-slot occupied":"calendar-slot available";n+=`<div class="${r}">`,t.length>0?t.forEach(e=>{const a=e.cliente||"Cliente",o=e.cancha||"Cancha N/A",t=e.estado||"confirmada",r=e.precio||0;n+=`\n                        <div class="reservation-item" title="${o} - $${r} - ${t}">\n                            <div class="fw-bold">${a}</div>\n                            <small class="text-muted">${o}</small>\n                            ${r>0?`<small class="d-block text-success">$${r}</small>`:""}\n                        </div>\n                    `}):n+='<div class="text-muted small">Disponible</div>',n+="</div>"}),n+="</div>"}),n+="</div>",a.innerHTML=n,actualizarRangoSemana()}function generarDiasSemana(e){const a=[],n=new Date(e);for(let e=0;e<7;e++){const o=new Date(n);o.setDate(n.getDate()+e),a.push({fecha:`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,dia:o.getDate(),nombre:o.toLocaleDateString("es-CL",{weekday:"short"}),nombreCompleto:o.toLocaleDateString("es-CL",{weekday:"long"})})}return a}function generarHorariosBasicos(){const e=[],a=AdminUtils.getCurrentUser(),n=a?.complejo_id;let o=8,t=23;6==n?(o=10,t=23):8==n&&(o=16,t=23);for(let a=0;a<7;a++){const n=[];for(let e=o;e<=t;e++)n.push({hora:e,label:`${e.toString().padStart(2,"0")}:00`});e.push({dia:a,horarios:n})}return e}function procesarReservasParaCalendario(e){const a={};return Array.isArray(e)?(e.forEach(e=>{try{if(!e.fecha||!e.hora_inicio)return void console.warn("⚠️ Reserva sin fecha o hora:",e);let n;n="string"==typeof e.fecha?e.fecha.includes("T")?e.fecha.split("T")[0]:e.fecha:e.fecha.toISOString().split("T")[0];const o=e.hora_inicio.split(":").slice(0,2).join(":");a[n]||(a[n]={}),a[n][o]||(a[n][o]=[]),a[n][o].push({reservada:!0,codigo_reserva:e.codigo_reserva||"N/A",cliente:e.nombre_cliente||"Cliente",cancha:`Cancha ${e.cancha_numero||e.cancha_nombre||"N/A"}`,tipo:"reserva",estado:e.estado||"confirmada",precio:e.precio_total||0})}catch(a){console.warn("⚠️ Error procesando reserva:",a,e)}}),a):(console.warn("⚠️ procesarReservasParaCalendario: reservas no es un array"),a)}function renderizarCalendarioBasico(e){const a=document.getElementById("calendarGrid");if(!a)return;let n='<div class="calendar-grid-basic">';n+='<div class="calendar-header">',n+='<div class="calendar-time-slot">Hora</div>',e.semana.dias.forEach(e=>{n+=`<div class="calendar-day-header">${e.nombre}<br><small>${e.dia}</small></div>`}),n+="</div>";(e.horarios[0]?.horarios||[]).forEach(a=>{n+='<div class="calendar-time-slot">',n+=`<div class="time-label">${a.label}</div>`,e.semana.dias.forEach(o=>{const t=e.calendario[o.fecha]?.[a.label]||[],r=t.length>0?"calendar-slot occupied":"calendar-slot available";n+=`<div class="${r}">`,t.length>0&&t.forEach(e=>{n+=`<div class="reservation-item">${e.cliente}</div>`}),n+="</div>"}),n+="</div>"}),n+="</div>",a.innerHTML=n,actualizarRangoSemana()}function renderizarCalendario(e=null){const a=document.getElementById("calendarGrid"),n=["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];semanaActual.toDateString();let o="";o+='<div class="calendar-header">Hora</div>';for(let e=0;e<7;e++){const a=new Date(semanaActual);a.setDate(semanaActual.getDate()-semanaActual.getDay()+1+e);const t=esMismoDia(a,new Date),r=a.getMonth()!==semanaActual.getMonth();a.toDateString(),a.getDate(),o+=`<div class="calendar-day-header ${t?"today":""} ${r?"other-month":""}">\n            ${n[e]}<br>\n            <small>${a.getDate()}</small>\n        </div>`}const t=new Set;if(e&&e.horarios&&e.horarios.forEach(e=>{e.horarios.forEach(e=>{t.add(e.label)})}),0===t.size)for(let e=0;e<7;e++){const a=new Date(semanaActual);a.setDate(semanaActual.getDate()-semanaActual.getDay()+1+e);generarHoras(formatearFecha(a)).forEach(e=>t.add(e))}Array.from(t).sort().forEach(e=>{o+=`<div class="calendar-time-slot">${e}</div>`;for(let a=0;a<7;a++){const n=new Date(semanaActual);n.setDate(semanaActual.getDate()-semanaActual.getDay()+1+a);const t=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`,r=new Date(semanaActual);r.setDate(semanaActual.getDate()-semanaActual.getDay()+1+a);const i=r.getDay(),s=AdminUtils.getCurrentUser(),l=s?.complejo_id;let c=!1;const d=parseInt(e.split(":")[0]);c=6==l?d>=10&&d<=23:8==l||i>=1&&i<=5?d>=16&&d<=23:d>=12&&d<=23;const m=new Date,u=new Date(r);u.setHours(d,0,0,0);const f=u<m;if(c){const a=[];if(calendarioData[t]&&calendarioData[t][e]){const n=calendarioData[t][e];Array.isArray(n)?a.push(...n):a.push(n)}"2025-09-12"===t&&"23:00"===e&&(calendarioData[t],canchas.length);const n=canchas.length,r=a.length,i=n-r;let s="",l="",c="",d="";0===r?(s="available",l="calendar-slot available",c=`onclick="seleccionarSlot('${t}', '${e}')"`,d=`Todas las canchas disponibles (${n}/${n}) - Click para reservar`):r<n?(s="partial",l="calendar-slot partial",c=`onclick="seleccionarSlot('${t}', '${e}')"`,d=`${i} cancha${i>1?"s":""} disponible${i>1?"s":""} (${i}/${n}) - Click para reservar`):(s="occupied",l="calendar-slot occupied",c="",d=`Todas las canchas ocupadas (${r}/${n}) - Click en icono para ver reservas`),f&&(l+=" past",c="",d=`Horario pasado - ${d}`),o+=`<div class="${l}" ${c} title="${d}">`,o+="occupied"===s||"partial"===s?`<div class="slot-content">\n                        <div class="slot-time">${e}</div>\n                        <div class="slot-info-icon" onclick="mostrarInfoReservas('${t}', '${e}', event)">\n                            <i class="fas fa-info-circle"></i>\n                        </div>\n                    </div>`:`<div class="slot-content">\n                        <div class="slot-time">${e}</div>\n                    </div>`,o+="</div>"}else{let e="calendar-slot unavailable";f&&(e+=" past"),o+=`<div class="${e}">\n                    <div class="slot-time">-</div>\n                </div>`}}}),a.innerHTML=o}function generarHoras(e=null){const a=[],n=AdminUtils.getCurrentUser(),o=n?.complejo_id;let t=16,r=23;if(6==o)t=10,r=23;else if(e){const a=new Date(e).getDay();a>=1&&a<=5?(t=16,r=23):(t=12,r=23)}for(let e=t;e<=r;e++){const n=`${e.toString().padStart(2,"0")}:00`;a.push(n)}return a}function obtenerInicioSemana(e){const a=new Date(e),n=a.getDay(),o=0===n?-6:1-n;a.setDate(a.getDate()+o);const t=a.toISOString().split("T")[0];return t}function obtenerFinSemana(e){const a=new Date(e),n=a.getDay(),o=0===n?0:7-n;a.setDate(a.getDate()+o);const t=a.toISOString().split("T")[0];return t}function obtenerInicioSemanaFormateado(e){const a=new Date(e),n=a.getDay(),o=0===n?-6:1-n;return a.setDate(a.getDate()+o),formatearFecha(a)}function obtenerFinSemanaFormateado(e){const a=new Date(e),n=a.getDay(),o=0===n?0:7-n;return a.setDate(a.getDate()+o),formatearFecha(a)}function esMismoDia(e,a){return e.getDate()===a.getDate()&&e.getMonth()===a.getMonth()&&e.getFullYear()===a.getFullYear()}function formatearFechaParaAPI(e){if(!e)return"";if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;if(e instanceof Date){const a=new Date(e.toLocaleString("en-US",{timeZone:"America/Santiago"}));return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}if("string"==typeof e)if(e.match(/^\d{4}-\d{2}-\d{2}$/)){const[a,n,o]=e.split("-").map(Number),t=new Date(a,n-1,o);if(!isNaN(t.getTime()))return`${a}-${String(n).padStart(2,"0")}-${String(o).padStart(2,"0")}`}else{const a=new Date(e);if(!isNaN(a.getTime())){if(e.endsWith("Z")||e.includes("T")){return`${a.getUTCFullYear()}-${String(a.getUTCMonth()+1).padStart(2,"0")}-${String(a.getUTCDate()).padStart(2,"0")}`}{const e=new Date(a.toLocaleString("en-US",{timeZone:"America/Santiago"}));return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}}}return""}function actualizarRangoSemana(){const e=obtenerInicioSemanaFormateado(semanaActual),a=obtenerFinSemanaFormateado(semanaActual),n=`${e.split(", ")[1]} - ${a.split(", ")[1]}`;document.getElementById("rangoSemana").textContent=n}function semanaAnterior(){const e=new Date(semanaActual);e.setDate(e.getDate()-7),semanaActual=e,semanaActual.toDateString(),cargarCalendario()}function semanaSiguiente(){const e=new Date(semanaActual);e.setDate(e.getDate()+7),semanaActual=e,semanaActual.toDateString(),cargarCalendario()}function irAHoy(){semanaActual=new Date,semanaActual.toDateString(),cargarCalendario()}function forzarActualizacionCalendario(){calendarioData={};const e=document.getElementById("calendarGrid");e&&(e.innerHTML=""),cargarCalendario()}async function seleccionarSlot(e,a){const[n,o,t]=e.split("-").map(Number),r=new Date(n,o-1,t).toLocaleDateString("es-CL",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"America/Santiago"}),[i,s]=a.split(":").map(Number),l=new Date;l.setHours(i+1,s,0,0);const c=`${l.getHours().toString().padStart(2,"0")}:${l.getMinutes().toString().padStart(2,"0")}`,d=await verificarBloqueosTemporales(e,a,c);if(d.length>0){const e=d.filter(e=>{try{const a=JSON.parse(e.datos_cliente||"{}");return!a.tipo_bloqueo||"cliente"===a.tipo_bloqueo}catch{return!0}}),a=d.filter(e=>{try{return"administrativo"===JSON.parse(e.datos_cliente||"{}").tipo_bloqueo}catch{return!1}});let n="";return n=e.length>0?`🚫 <strong>Horario temporalmente ocupado</strong><br><br>\n                      Hay ${e.length} cliente(s) reservando en este momento.<br>\n                      Por favor, intenta nuevamente en unos minutos.`:a.length>0?"⚠️ <strong>Horario en uso</strong><br><br>\n                      Otro administrador está procesando una reserva en este horario.<br>\n                      Por favor, intenta nuevamente en unos minutos.":"🔒 <strong>Horario temporalmente bloqueado</strong><br><br>\n                      Este horario está siendo procesado por otro usuario.<br>\n                      Por favor, intenta nuevamente en unos minutos.",void mostrarNotificacion(n,"warning",8e3)}const m=await crearBloqueoTemporalAdmin(e,a,c);if(!m.success){console.error("❌ Error creando bloqueo temporal administrativo:",m.error);let e="";return e=m.error.includes("AdminUtils.getToken is not a function")?"🔧 <strong>Error de configuración</strong><br><br>Hay un problema técnico temporal. Por favor, recarga la página e intenta nuevamente.":m.error.includes("Unauthorized")||m.error.includes("401")?"🔐 <strong>Sesión expirada</strong><br><br>Tu sesión ha expirado. Por favor, inicia sesión nuevamente.":m.error.includes("Network")||m.error.includes("fetch")?"🌐 <strong>Error de conexión</strong><br><br>No se pudo conectar con el servidor. Verifica tu conexión a internet.":"⚠️ <strong>Error inesperado</strong><br><br>Ocurrió un problema al procesar tu solicitud. Por favor, intenta nuevamente.",void mostrarNotificacion(e,"danger",8e3)}m.bloqueo;const u=document.getElementById("modalInfoFechaHora");u&&(u.innerHTML=`${r} de ${a} a ${c}`),window.reservaSeleccionada={fecha:e,horaInicio:a,horaFin:c,bloqueoId:m.bloqueo.id,bloqueosPorCancha:m.bloqueos||[]},abrirModalReserva(!0)}function mostrarInfoReservas(e,a,n){n.stopPropagation();const o=[];if(calendarioData[e]&&calendarioData[e][a]){const n=calendarioData[e][a];Array.isArray(n)?o.push(...n):o.push(n)}if(o.forEach((e,a)=>{}),0===o.length)return;let t=`\n        <div class="modal fade" id="modalInfoReservas" tabindex="-1">\n            <div class="modal-dialog">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title">Reservas - ${e} ${a}</h5>\n                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                    </div>\n                    <div class="modal-body">\n    `;o.forEach((e,a)=>{Object.keys(e);const n="directa"===(e.tipo_reserva||e.tipo||"directa")?"Web":"Admin",o=e.estado?e.estado.charAt(0).toUpperCase()+e.estado.slice(1):"N/A",r=e.codigo_reserva||e.codigo||"N/A",i=e.cliente||e.nombre_cliente||e.nombre||"N/A",s=e.cancha||e.cancha_nombre||e.cancha_nombre||"N/A",l=e.telefono||e.telefono_cliente||e.phone||null,c=e.precio||e.precio_total||e.price||0;t+=`\n            <div class="reservation-detail mb-3">\n                <div class="row">\n                    <div class="col-md-6">\n                        <strong>Código:</strong> <code>${r}</code><br>\n                        <strong>Cliente:</strong> ${i}<br>\n                        <strong>Cancha:</strong> ${s}<br>\n                        <strong>Estado:</strong> <span class="badge bg-${"confirmada"===e.estado?"success":"warning"}">${o}</span>\n                        ${l?`<br><strong>Teléfono:</strong> ${l}`:""}\n                    </div>\n                    <div class="col-md-6">\n                        <strong>Precio:</strong> $${formatCurrencyChile(c)}<br>\n                        <strong>Tipo:</strong> ${n}\n                    </div>\n                </div>\n            </div>\n        `}),t+='\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ';const r=document.getElementById("modalInfoReservas");r&&r.remove(),document.body.insertAdjacentHTML("beforeend",t);new bootstrap.Modal(document.getElementById("modalInfoReservas")).show(),document.getElementById("modalInfoReservas").addEventListener("hidden.bs.modal",function(){this.remove()})}function abrirModalReserva(e=!1){let a=document.getElementById("modalNuevaReserva");if(Array.from(document.querySelectorAll('[id*="modal"]')).map(e=>e.id),document.body.innerHTML.includes("modalNuevaReserva"),!a)return console.error("❌ Error: Modal modalNuevaReserva no encontrado en el DOM"),console.error("🔍 Total de elementos en el documento:",document.body.children.length),console.error("🔍 Último hijo del body:",document.body.lastElementChild?.tagName,document.body.lastElementChild?.id),void mostrarNotificacion("❌ Error técnico: No se pudo abrir el formulario de reserva.<br>Por favor, recarga la página.","danger",5e3);a.style.display="flex",a.style.visibility="visible",a.style.opacity="1",a.style.display,a.style.visibility,a.style.opacity;const n=document.getElementById("seccionComplejoModal"),o=document.getElementById("seccionCanchaModal");if(n&&(n.style.display=e?"none":"block"),o&&(o.style.display="block"),e){const e=document.getElementById("complejoCalendario"),a=document.getElementById("modalComplejo");if(e&&a&&e.value)a.value=e.value,cargarCanchasModal(e.value);else{const e=AdminUtils.getCurrentUser();if(e&&e.complejo_id)e.complejo_id,a&&(a.value=e.complejo_id,a.value),cargarCanchasModal(e.complejo_id);else if(e&&"super_admin"===e.rol&&complejos&&complejos.length>0){const e=complejos[0];a&&(a.value=e.id),cargarCanchasModal(e.id)}}}else cargarComplejosModal()}function cerrarModalReserva(){const e=document.getElementById("modalNuevaReserva");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0");const a=document.getElementById("formNuevaReserva");a&&a.reset(),limpiarValidacionesModal(),window.reservaSeleccionada=null;const n=document.getElementById("modalInfoFechaHora");n&&(n.textContent="Selecciona una hora en el calendario");const o=document.getElementById("seccionComplejoModal"),t=document.getElementById("seccionCanchaModal");o&&(o.style.display="block"),t&&(t.style.display="block")}function limpiarValidacionesModal(){["modalNombreCliente","modalEmailCliente","modalRutCliente","modalTelefonoCliente"].forEach(e=>{const a=document.getElementById(e);if(a){a.classList.remove("is-valid","is-invalid");const e=a.parentNode.querySelector(".valid-feedback, .invalid-feedback");e&&e.classList.add("d-none")}})}async function cargarComplejosModal(){const e=document.getElementById("modalComplejo");e.innerHTML='<option value="">Seleccionar complejo</option>',complejos.forEach(a=>{const n=document.createElement("option");n.value=a.id,n.textContent=a.nombre,e.appendChild(n)})}async function cargarCanchasModal(e=null){const a=document.getElementById("modalComplejo"),n=e||(a?a.value:""),o=document.getElementById("modalCancha");if(a&&a.value,o.innerHTML='<option value="">Seleccionar cancha</option>',n)try{API_BASE;const e=await fetch(`${API_BASE}/admin/canchas?complejoId=${n}`,{headers:{Authorization:`Bearer ${AdminUtils.getAuthToken()}`}});if(e.status,e.ok,!e.ok)throw new Error(`HTTP error! status: ${e.status}`);if(e.ok){const a=await e.json();if(a.length,0===a.length){const e=document.createElement("option");e.value="",e.textContent="No hay canchas disponibles",e.disabled=!0,o.appendChild(e)}else window.reservaSeleccionada?(window.reservaSeleccionada,await cargarCanchasDisponiblesModal(a,o,n)):a.forEach(e=>{const a=e.precio_hora||e.precio||0;e.precio_hora,e.precio;const n=document.createElement("option");n.value=e.id,n.textContent=`${e.nombre} - ${e.tipo}`,n.dataset.precio=a,o.appendChild(n)});o.innerHTML}else{console.error("❌ cargarCanchasModal - Error en respuesta:",e.status,e.statusText);const a=await e.text();console.error("❌ cargarCanchasModal - Respuesta completa:",a)}}catch(e){console.error("Error al cargar canchas:",e)}}async function cargarCanchasDisponiblesModal(e,a,n){const{fecha:o,horaInicio:t,horaFin:r}=window.reservaSeleccionada;let i=[];for(const a of e)try{const e=Date.now(),n=await fetch(`${API_BASE}/disponibilidad/${a.id}/${o}?t=${e}`,{headers:{Authorization:`Bearer ${AdminUtils.getAuthToken()}`}});if(n.ok){const e=await n.json();a.id;verificarDisponibilidadCanchaAdmin(t,r,e)?(a.id,i.push(a)):a.id}else console.error("❌ Error verificando disponibilidad de cancha",a.id,":",n.status),i.push(a)}catch(e){console.error("❌ Error verificando disponibilidad de cancha",a.id,":",e),i.push(a)}if(i.length,e.length,0===i.length){const e=document.createElement("option");e.value="",e.textContent="No hay canchas disponibles para este horario",e.disabled=!0,a.appendChild(e)}else i.forEach(e=>{const n=e.precio_hora||e.precio||0,o=document.createElement("option");o.value=e.id,o.textContent=`${e.nombre} - ${e.tipo}`,o.dataset.precio=n,a.appendChild(o)})}function verificarDisponibilidadCanchaAdmin(e,a,n){n.reservas,n.bloqueos;for(const o of n.reservas||[])if(haySuperposicionHorariosAdmin(e,a,o.hora_inicio,o.hora_fin))return!1;const o=AdminUtils.getCurrentUser();for(const t of n.bloqueos||[]){if(t.session_id&&t.session_id.includes(o?.email||"")||t.admin_id&&t.admin_id===o?.id||t.session_id&&t.session_id.includes(o?.id?.toString()||""))t.session_id,t.admin_id;else if(haySuperposicionHorariosAdmin(e,a,t.hora_inicio,t.hora_fin))return!1}return!0}function haySuperposicionHorariosAdmin(e,a,n,o){const t=timeToMinutesAdmin(e),r=timeToMinutesAdmin(a),i=timeToMinutesAdmin(n);return t<timeToMinutesAdmin(o)&&r>i}function timeToMinutesAdmin(e){const[a,n]=e.split(":"),o=parseInt(a),t=parseInt(n);return 0===o&&e.includes("00:00")?1440+t:60*o+t}function validarRUT(e){if((e=e.replace(/[^0-9kK]/g,"")).length<8)return!1;const a=e.slice(0,-1),n=e.slice(-1).toUpperCase();if(!/^\d+$/.test(a))return!1;if(!/^[0-9kK]$/.test(n))return!1;let o=0,t=2;for(let e=a.length-1;e>=0;e--)o+=parseInt(a[e])*t,t=7===t?2:t+1;const r=o%11;return n===(0===r?"0":1===r?"K":(11-r).toString())}function validarNombre(e){if(!e||"string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;if(e.length<2)return!1;if(!e.includes(" "))return!1;return/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(e)}function validarEmail(e){if(!e||"string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function formatearRUT(e){if((e=e.replace(/[^0-9kK]/g,"")).length<2)return e;if(e.length<8)return e.replace(/(\d{1,3})(\d{1,3})/,"$1.$2");const a=e.slice(0,-1),n=e.slice(-1).toUpperCase();return`${a.replace(/\B(?=(\d{3})+(?!\d))/g,".")}-${n}`}async function crearReservaAdmin(){const e=document.getElementById("modalNombreCliente"),a=document.getElementById("modalEmailCliente"),n=document.getElementById("modalRutCliente"),o=document.getElementById("modalTelefonoCliente"),t=document.getElementById("modalCancha"),r=e.value.trim(),i=a.value.trim(),s=n.value.trim(),l=o.value.trim(),c=t.value;if(!window.reservaSeleccionada)return void mostrarNotificacion("Por favor, selecciona una hora en el calendario","warning");if(!c)return mostrarNotificacion("Por favor, selecciona una cancha","warning"),void t.focus();if(!r)return mostrarNotificacion('Por favor completa el campo "Nombre del Cliente"',"danger"),void e.focus();if(!i)return mostrarNotificacion('Por favor completa el campo "Email del Cliente"',"danger"),void a.focus();if(!s)return mostrarNotificacion('Por favor completa el campo "RUT del Cliente"',"danger"),void n.focus();if(!validarNombre(r))return mostrarNotificacion("Por favor ingresa un nombre completo válido (nombre y apellido)","danger"),void e.focus();if(!validarEmail(i))return mostrarNotificacion("Por favor ingresa un email válido","danger"),void a.focus();if(!validarRUT(s))return mostrarNotificacion("Por favor ingresa un RUT válido","danger"),void n.focus();if(l&&!validarTelefono(l))return mostrarNotificacion("Por favor ingresa un teléfono válido","danger"),void o.focus();const d=canchas.find(e=>e.id==c),m=d&&(d.precio_hora||d.precio)||0,u={cancha_id:c,fecha:window.reservaSeleccionada.fecha,hora_inicio:window.reservaSeleccionada.horaInicio,hora_fin:window.reservaSeleccionada.horaFin,nombre_cliente:r,email_cliente:i,telefono_cliente:l||null,rut_cliente:formatearRUT(s),tipo_reserva:"administrativa",creada_por_admin:!0,precio_total:m,bloqueo_id:window.reservaSeleccionada.bloqueoId},f=document.querySelector("#modalNuevaReserva .btn-success"),g=f.innerHTML;f.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Creando reserva...',f.disabled=!0;try{const e=await fetch(`${API_BASE}/admin/calendar/reservation`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${AdminUtils.getAuthToken()}`},body:JSON.stringify(u)}),a=await e.json();e.ok?(await liberarBloqueoTemporalAdmin(),mostrarNotificacion(`✅ Reserva creada exitosamente<br>Código: <strong>${a.reserva?.codigo_reserva||"N/A"}</strong>`,"success",6e3),cerrarModalReserva(),cargarReservas(),"calendario"===vistaActual&&cargarCalendario()):(console.error("❌ Error al crear reserva:",a),mostrarNotificacion(`❌ Error al crear la reserva: ${a.error||"Error desconocido"}`,"danger",8e3))}catch(e){console.error("❌ Error de conexión:",e),mostrarNotificacion("❌ Error de conexión al crear la reserva","danger")}finally{f.innerHTML=g,f.disabled=!1}}function actualizarBloqueoIdPorCancha(){const e=document.getElementById("modalCancha").value;if(!e||!window.reservaSeleccionada||!window.reservaSeleccionada.bloqueosPorCancha)return;const a=window.reservaSeleccionada.bloqueosPorCancha.find(a=>a.cancha_id==e);a?(window.reservaSeleccionada.bloqueoId=a.id,a.id):console.warn("⚠️ No se encontró bloqueo específico para cancha",e)}function actualizarPrecioModal(){const e=document.getElementById("modalCancha"),a=document.getElementById("precioModal");if(!e||!a)return;const n=e.value;if(!n)return void(a.textContent="Selecciona una cancha");const o=canchas.find(e=>e.id==n);if(o){const e=o.precio_hora||o.precio||0;a.textContent=`$${formatCurrencyChile(e)} por hora`}else a.textContent="Precio no disponible"}function nuevaReservaAdmin(){mostrarVista("calendario"),setTimeout(()=>{const e=document.getElementById("vistaCalendario");e&&e.scrollIntoView({behavior:"smooth",block:"center"})},100),mostrarNotificacion('💡 <strong>Instrucciones para nueva reserva:</strong><br>1. Busca una hora disponible en el calendario (casillas en <span style="color: #28a745; font-weight: bold;">verde</span>)<br>2. Haz clic en la hora deseada<br>3. Completa el formulario que aparecerá',"info",8e3),setTimeout(()=>{resaltarHorasDisponibles()},500)}function resaltarHorasDisponibles(){const e=document.querySelectorAll(".calendar-slot.available");e.forEach((e,a)=>{e.classList.add("highlight-available"),setTimeout(()=>{e.classList.remove("highlight-available")},3e3+100*a)}),e.length}function configurarValidacionTiempoReal(){const e=document.getElementById("modalNombreCliente");e&&e.addEventListener("input",function(){validarCampoTiempoReal(this,validarNombre,"Nombre completo válido")});const a=document.getElementById("modalEmailCliente");a&&a.addEventListener("input",function(){validarCampoTiempoReal(this,validarEmail,"Email válido")});const n=document.getElementById("modalRutCliente");n&&n.addEventListener("input",function(){const e=this.value,a=e.replace(/[^0-9kK]/g,"");if(a.length>1){const n=formatearRUT(a);n!==e&&(this.value=n)}validarCampoTiempoReal(this,validarRUT,"RUT válido")});const o=document.getElementById("modalTelefonoCliente");o&&o.addEventListener("input",function(){if(this.value.trim())validarCampoTiempoReal(this,validarTelefono,"Teléfono válido");else{this.classList.remove("is-valid","is-invalid");const e=this.parentNode.querySelector(".valid-feedback, .invalid-feedback");e&&e.classList.add("d-none")}})}function validarTelefono(e){if(!e||"string"!=typeof e)return!1;e=e.trim();return[/^\+569\d{8}$/,/^569\d{8}$/,/^9\d{8}$/,/^2\d{8}$/,/^3\d{8}$/].some(a=>a.test(e))}function validarCampoTiempoReal(e,a,n){const o=e.value.trim();if(0===o.length){e.classList.remove("is-valid","is-invalid");const a=e.parentNode.querySelector(".valid-feedback, .invalid-feedback");return void(a&&a.classList.add("d-none"))}const t=a(o),r=e.parentNode.querySelector(".valid-feedback"),i=e.parentNode.querySelector(".invalid-feedback");t?(e.classList.remove("is-invalid"),e.classList.add("is-valid"),r&&(r.textContent=n,r.classList.remove("d-none")),i&&i.classList.add("d-none")):(e.classList.remove("is-valid"),e.classList.add("is-invalid"),r&&r.classList.add("d-none"),i&&i.classList.remove("d-none"))}async function verificarBloqueosTemporales(e,a,n){try{const o=await fetch(`${API_BASE}/admin/calendar/check-blocking`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${AdminUtils.getAuthToken()}`},body:JSON.stringify({fecha:e,hora_inicio:a,hora_fin:n})});if(!o.ok)throw new Error(`Error verificando bloqueos: ${o.status}`);const t=await o.json();return t.bloqueos||[]}catch(e){return console.error("❌ Error verificando bloqueos temporales:",e),e.message.includes("AdminUtils.getToken is not a function")?mostrarNotificacion("🔧 <strong>Error de configuración</strong><br><br>Hay un problema técnico temporal. Por favor, recarga la página.","warning",6e3):(e.message.includes("Unauthorized")||e.message.includes("401"))&&mostrarNotificacion("🔐 <strong>Sesión expirada</strong><br><br>Tu sesión ha expirado. Por favor, inicia sesión nuevamente.","danger",6e3),[]}}async function crearBloqueoTemporalAdmin(e,a,n){try{const o=`admin_${AdminUtils.getCurrentUser().id}_${Date.now()}`,t=await fetch(`${API_BASE}/admin/calendar/create-blocking`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${AdminUtils.getAuthToken()}`},body:JSON.stringify({fecha:e,hora_inicio:a,hora_fin:n,session_id:o,tipo:"administrativo"})});if(!t.ok){const e=await t.json();throw new Error(e.error||`Error creando bloqueo: ${t.status}`)}const r=await t.json();return bloqueoTemporalAdmin={id:r.bloqueoId,sessionId:o,fecha:e,horaInicio:a,horaFin:n},setTimeout(()=>{bloqueoTemporalAdmin&&liberarBloqueoTemporalAdmin()},12e4),{success:!0,bloqueo:bloqueoTemporalAdmin,bloqueos:r.bloqueos||[]}}catch(e){return console.error("❌ Error creando bloqueo temporal administrativo:",e),{success:!1,error:e.message}}}async function liberarBloqueoTemporalAdmin(){if(bloqueoTemporalAdmin)try{bloqueoTemporalAdmin.id;(await fetch(`${API_BASE}/admin/calendar/liberate-blocking/${bloqueoTemporalAdmin.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${AdminUtils.getAuthToken()}`}})).ok||console.error("⚠️ Error liberando bloqueo temporal administrativo")}catch(e){console.error("❌ Error liberando bloqueo temporal administrativo:",e)}finally{bloqueoTemporalAdmin=null}}async function verificarEstadoServidor(){try{const e=(await fetch(`${API_BASE.replace("/api","")}/health`)).ok?"✅ Funcionando":"❌ Con problemas",a=await fetch(`${API_BASE}/admin/calendar/week`),n=401===a.status?"✅ Requiere autenticación (normal)":502===a.status?"❌ Error 502 (problema interno)":200===a.status?"✅ Funcionando":`⚠️ Estado ${a.status}`;alert(`Estado del Servidor:\n        \n🏥 Salud del servidor: ${e}\n🔐 Endpoint calendario: ${n}\n📅 Estado actual: Modo offline activado\n\n🔍 DIAGNÓSTICO:\n• El servidor está funcionando correctamente (Status 200)\n• La base de datos está conectada (PostgreSQL)\n• El problema es específico del navegador o autenticación\n• Posibles causas: Token expirado, CORS, Cloudflare, caché\n\n🛠️ SOLUCIONES:\n• Recargar la página para obtener nuevo token\n• Limpiar caché del navegador\n• Verificar que el token de autenticación sea válido`)}catch(e){console.error("Error verificando servidor:",e),alert("No se pudo verificar el estado del servidor. Error: "+e.message)}}function mostrarInfoOffline(){alert(`¿Por qué está en modo offline?\n\n🔍 DIAGNÓSTICO:\n• El calendario normal requiere conexión al servidor\n• El servidor está devolviendo errores 502 (Bad Gateway)\n• Esto indica un problema interno del servidor de producción\n\n🛠️ SOLUCIONES:\n• El modo offline usa datos ya cargados en la página\n• Muestra las reservas disponibles pero con funcionalidad limitada\n• Puedes reintentar la conexión con el botón "Reintentar"\n\n📊 DATOS DISPONIBLES:\n• ${window.reservasData?.length||0} reservas cargadas\n• Vista de calendario básica\n• Información de clientes y canchas\n• Horarios de 8:00 a 22:00\n\n🔄 CUANDO SE RESTAURA:\n• El servidor se recupera automáticamente\n• Haz click en "Reintentar" para probar la conexión\n• El calendario volverá al formato normal`)}function limpiarCacheYRecargar(){try{localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),localStorage.removeItem("reservasData"),sessionStorage.clear(),"caches"in window&&caches.keys().then(e=>{e.forEach(e=>{caches.delete(e)})}),alert("🧹 Caché limpiado exitosamente.\n\nSe recargará la página para obtener un nuevo token de autenticación."),window.location.reload()}catch(e){console.error("Error limpiando caché:",e),alert("Error al limpiar el caché. Recargando página de todas formas..."),window.location.reload()}}function mostrarInfoPago(e,a,n){if(null==n||isNaN(n))return console.error("❌ Error: precioTotal inválido para la reserva:",e,"precioTotal:",n,"tipo:",typeof n),void mostrarNotificacion("Error: No se pudo obtener el precio de la reserva","danger");const o=50===a,t=o?"⚠️ Pago Parcial (50%)":"✅ Pago Completo (100%)",r=o?Math.round(n/2):n,i=o?Math.round(n/2):0,s=o?`<div class="alert alert-warning mb-0">\n               <h6 class="alert-heading">${t}</h6>\n               <p class="mb-2"><strong>Reserva:</strong> ${e}</p>\n               <hr>\n               <p class="mb-2"><strong>Precio Total Reserva:</strong> $${formatCurrencyChile(n)}</p>\n               <p class="mb-2"><strong>Pagado Online:</strong> <span class="text-success">$${formatCurrencyChile(r)}</span> (50%)</p>\n               <p class="mb-0"><strong>Pendiente en Complejo:</strong> <span class="text-danger">$${formatCurrencyChile(i)}</span> (50%)</p>\n               <hr>\n               <small class="text-muted">El cliente debe cancelar el 50% restante directamente en el complejo.</small>\n           </div>`:`<div class="alert alert-success mb-0">\n               <h6 class="alert-heading">${t}</h6>\n               <p class="mb-2"><strong>Reserva:</strong> ${e}</p>\n               <hr>\n               <p class="mb-2"><strong>Precio Total Reserva:</strong> $${formatCurrencyChile(n)}</p>\n               <p class="mb-0"><strong>Pagado Online:</strong> <span class="text-success">$${formatCurrencyChile(r)}</span> (100%)</p>\n           </div>`;if("undefined"!=typeof Swal)Swal.fire({title:"Información de Pago",html:s,icon:o?"warning":"success",confirmButtonText:"Cerrar",customClass:{confirmButton:"btn btn-primary"}});else{const a=o?`${t}\n\nReserva: ${e}\nPrecio Total: $${formatCurrencyChile(n)}\nPagado online: $${formatCurrencyChile(r)} (50%)\nPendiente en complejo: $${formatCurrencyChile(i)} (50%)\n\nEl cliente debe cancelar el 50% restante directamente en el complejo.`:`${t}\n\nReserva: ${e}\nPrecio Total: $${formatCurrencyChile(n)}\nPagado online: $${formatCurrencyChile(r)} (100%)`;alert(a)}}document.addEventListener("DOMContentLoaded",function(){if(!AdminUtils.isAuthenticated())return void(window.location.href="../../admin-login.html");const e=AdminUtils.getCurrentUser();if(e){document.getElementById("adminWelcome").textContent=`Bienvenido, ${e.nombre||"Admin"}`;const a=document.querySelector('[data-user="name"]'),n=document.querySelector('[data-user="role"]'),o=document.querySelector('[data-user="complex"]');a&&(a.textContent=e.nombre||"Admin"),n&&(n.textContent=AdminUtils.getRoleDisplayName(e.rol)),o&&(o.textContent=e.complejo_nombre||"Todos los complejos")}aplicarPermisosPorRol(),AdminUtils.setupLogout(),cargarComplejos(),cargarReservas(),configurarEventListeners()}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("modalComplejo");e&&e.addEventListener("change",cargarCanchasModal),document.getElementById("modalCancha").addEventListener("change",function(){actualizarPrecioModal(),actualizarBloqueoIdPorCancha()});const a=document.getElementById("complejoCalendario");a&&a.addEventListener("change",function(){const e=AdminUtils.getCurrentUser();e&&"super_admin"===e.rol&&(actualizarTituloCalendario(),cargarCalendario())}),configurarValidacionTiempoReal();const n=document.getElementById("modalNuevaReserva");n&&n.addEventListener("hidden.bs.modal",function(){liberarBloqueoTemporalAdmin()}),window.addEventListener("beforeunload",liberarBloqueoTemporalAdmin)});