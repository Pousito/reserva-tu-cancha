let currentUser=null,courts=[],complexes=[];function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}function aplicarPermisosPorRol(){const e=AdminUtils.getCurrentUser();if(!e)return;const o=e.rol,n=document.querySelector('a[href="admin-complexes.html"]'),t=document.querySelector('a[href="admin-reports.html"]'),r=document.querySelector('a[href="admin-gastos.html"]');if("manager"===o?(n&&(n.style.display="none"),t&&(t.style.display="none"),r&&(r.style.display="none")):"owner"===o?(n&&(n.style.display="none"),t&&(t.style.display="block",t.style.visibility="visible",t.classList.add("owner-visible"),t.classList.remove("hide-for-manager")),r&&(r.style.display="block",r.style.visibility="visible",r.classList.add("owner-visible"),r.classList.remove("hide-for-manager"))):"super_admin"===o&&(n&&(n.style.display="block",n.style.visibility="visible"),t&&(t.style.display="block",t.style.visibility="visible",t.classList.remove("hide-for-manager")),r&&(r.style.display="block",r.style.visibility="visible",r.classList.remove("hide-for-manager"))),"manager"===o){document.querySelectorAll('[data-role="reports"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-role="all-complexes"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll("#filterComplex").forEach(e=>{e.style.display="none"});const e=document.querySelector('button[data-bs-target="#courtModal"]');e&&(e.style.display="none")}else if("owner"===o)document.querySelectorAll('[data-role="all-complexes"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll("#filterComplex").forEach(e=>{e.style.display="none"});else if("super_admin"===o){const e=document.querySelectorAll(".hide-for-manager, .hide-for-owner");e.length,e.forEach((e,o)=>{e.classList.remove("hide-for-manager"),e.classList.remove("hide-for-owner"),e.style.display="",e.style.visibility=""})}}function setupEventListeners(){document.getElementById("searchCourt").addEventListener("input",function(){filterCourts()}),document.getElementById("filterType").addEventListener("change",function(){filterCourts()}),document.getElementById("filterComplex").addEventListener("change",function(){filterCourts()})}async function loadComplexes(){try{if(!AdminUtils.canViewAllComplexes()&&"owner"!==currentUser.rol)return;const e=localStorage.getItem("adminToken"),o=await AdminUtils.authenticatedFetch("/admin/complejos",{headers:{Authorization:`Bearer ${e}`}});o.ok?(complexes=await o.json(),populateComplexSelect()):console.error("Error cargando complejos:",o.statusText)}catch(e){console.error("Error:",e)}}function populateComplexSelect(){const e=document.getElementById("courtComplex");e.innerHTML='<option value="">Seleccionar complejo...</option>',complexes.forEach(o=>{const n=document.createElement("option");n.value=o.id,n.textContent=o.nombre,e.appendChild(n)}),e.addEventListener("change",function(){loadCourtTypesForComplex(this.value)}),populateComplexFilter()}function populateComplexFilter(){const e=document.getElementById("filterComplex");e.innerHTML='<option value="">Todos los complejos</option>';let o=complexes;currentUser&&"super_admin"!==currentUser.rol&&(o=complexes.filter(e=>e.id==currentUser.complejo_id)),o.forEach(o=>{const n=document.createElement("option");n.value=o.id,n.textContent=o.nombre,e.appendChild(n)})}async function loadFilterTypes(){try{const e=await AdminUtils.authenticatedFetch("/admin/canchas");if(e&&e.ok){const o=await e.text();try{const e=JSON.parse(o);let n=e;currentUser&&"super_admin"!==currentUser.rol&&(n=e.filter(e=>e.complejo_id==currentUser.complejo_id));const t=[...new Set(n.map(e=>e.tipo))],r=document.getElementById("filterType");r.innerHTML='<option value="">Todos los tipos</option>',t.forEach(e=>{const o=document.createElement("option");o.value=e,o.textContent=capitalizeCourtType(e),r.appendChild(o)})}catch(e){console.error("‚ùå Error parseando JSON para tipos:",e),console.error("üìÑ Texto recibido:",o)}}}catch(e){console.error("Error cargando tipos para filtro:",e)}}async function loadCourtTypesForComplex(e){const o=document.getElementById("courtType");if(e)try{const n=await AdminUtils.authenticatedFetch("/admin/canchas");if(n&&n.ok){const t=(await n.json()).filter(o=>o.complejo_id==e),r=[...new Set(t.map(e=>e.tipo))];if(o.innerHTML='<option value="">Seleccionar tipo...</option>',r.length>0)r.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=capitalizeCourtType(e),o.appendChild(n)});else{const e=document.createElement("option");e.value="padel",e.textContent=capitalizeCourtType("padel"),o.appendChild(e);const n=document.createElement("option");n.value="futbol",n.textContent=capitalizeCourtType("futbol"),o.appendChild(n)}}}catch(e){console.error("Error cargando tipos de cancha:",e),o.innerHTML=`\n            <option value="">Seleccionar tipo...</option>\n            <option value="padel">${capitalizeCourtType("padel")}</option>\n            <option value="futbol">${capitalizeCourtType("futbol")}</option>\n        `}else o.innerHTML=`\n            <option value="">Seleccionar tipo...</option>\n            <option value="padel">${capitalizeCourtType("padel")}</option>\n            <option value="futbol">${capitalizeCourtType("futbol")}</option>\n        `}async function loadCourts(){try{const e=await AdminUtils.authenticatedFetch("/admin/canchas");if(!e)return void console.error("‚ùå No se recibi√≥ respuesta");if(e.ok){const o=await e.text();try{courts=JSON.parse(o),displayCourts(courts)}catch(e){console.error("‚ùå Error parseando JSON:",e),console.error("üìÑ Texto recibido:",o)}}else console.error("‚ùå Error cargando canchas:",e.statusText),document.getElementById("courtsList").innerHTML=`\n                <div class="alert alert-danger">\n                    <i class="fas fa-exclamation-triangle me-2"></i>\n                    Error cargando canchas: ${e.statusText}\n                </div>\n            `}catch(e){console.error("Error:",e),document.getElementById("courtsList").innerHTML='\n            <div class="alert alert-danger">\n                <i class="fas fa-exclamation-triangle me-2"></i>\n                Error de conexi√≥n\n            </div>\n        '}}function displayCourts(e){const o=document.getElementById("courtsList");0!==e.length?o.innerHTML=e.map(e=>`\n        <div class="court-card">\n            <div class="row">\n                <div class="col-md-8">\n                    <h5 class="mb-2">\n                        <i class="fas fa-futbol me-2"></i>\n                        ${e.nombre}\n                    </h5>\n                    <p class="text-muted mb-2">\n                        <i class="fas fa-building me-2"></i>\n                        ${getComplexName(e.complejo_id)}\n                    </p>\n                    <p class="mb-2">\n                        <i class="fas fa-tag me-2"></i>\n                        ${capitalizeCourtType(e.tipo)}\n                    </p>\n                    <p class="mb-0">\n                        <i class="fas fa-dollar-sign me-2"></i>\n                        ${e.precio_hora?`$${formatCurrencyChile(e.precio_hora)} por hora`:"Precio no disponible"}\n                    </p>\n                </div>\n                <div class="col-md-4 text-end">\n                    ${currentUser&&"manager"!==currentUser.rol?`\n                    <div class="btn-group-vertical" role="group">\n                        <button class="btn btn-outline-primary btn-sm mb-2" onclick="openPromocionesModal(${e.id}, '${e.nombre.replace(/'/g,"\\'")}', ${e.precio_hora})">\n                            <i class="fas fa-percent me-1"></i>\n                            Promociones\n                        </button>\n                        <button class="btn btn-outline-warning btn-sm mb-2" onclick="editCourt(${e.id})">\n                            <i class="fas fa-edit me-1"></i>\n                            Editar\n                        </button>\n                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCourt(${e.id})">\n                            <i class="fas fa-trash me-1"></i>\n                            Eliminar\n                        </button>\n                    </div>\n                    `:'\n                    <div class="text-muted">\n                        <small>Solo lectura</small>\n                    </div>\n                    '}\n                </div>\n            </div>\n        </div>\n    `).join(""):o.innerHTML='\n            <div class="alert alert-info">\n                <i class="fas fa-info-circle me-2"></i>\n                No se encontraron canchas\n            </div>\n        '}function capitalizeCourtType(e){return e?"padel"===e?"Padel":"F√∫tbol":""}function getComplexName(e){if(currentUser&&("manager"===currentUser.rol||"owner"===currentUser.rol)&&currentUser.complejo_nombre)return currentUser.complejo_nombre;const o=complexes.find(o=>o.id===e);return o?o.nombre:"Complejo no encontrado"}function filterCourts(){const e=document.getElementById("searchCourt").value.toLowerCase(),o=document.getElementById("filterType").value,n=document.getElementById("filterComplex").value;displayCourts(courts.filter(t=>{const r=!e||t.nombre.toLowerCase().includes(e)||getComplexName(t.complejo_id).toLowerCase().includes(e)||t.tipo.toLowerCase().includes(e),i=!o||t.tipo===o,a=!n||t.complejo_id==n;return r&&i&&a}))}function openCourtModal(e=null){const o=document.getElementById("courtModal"),n=document.getElementById("courtModalTitle"),t=document.getElementById("courtForm");if(e)n.textContent="Editar Cancha",loadCourtData(e);else if(n.textContent="Agregar Nueva Cancha",t.reset(),o.dataset.courtId="",currentUser&&"manager"===currentUser.rol){document.getElementById("courtComplex").value=currentUser.complejo_id,loadCourtTypesForComplex(currentUser.complejo_id)}new bootstrap.Modal(o).show()}async function loadCourtData(e){try{const o=courts.find(o=>o.id===e);o&&(document.getElementById("courtModal").dataset.courtId=e,document.getElementById("courtName").value=o.nombre,document.getElementById("courtComplex").value=o.complejo_id,document.getElementById("courtPrice").value=o.precio_hora,document.getElementById("courtDescription").value=o.descripcion||"",await loadCourtTypesForComplex(o.complejo_id),document.getElementById("courtType").value=o.tipo)}catch(e){console.error("Error cargando datos de la cancha:",e)}}async function saveCourt(){const e=document.getElementById("courtForm");if(!e.checkValidity())return void e.reportValidity();const o={nombre:document.getElementById("courtName").value,complejo_id:parseInt(document.getElementById("courtComplex").value),tipo:document.getElementById("courtType").value,precio_hora:parseFloat(document.getElementById("courtPrice").value),descripcion:document.getElementById("courtDescription").value},n=document.getElementById("courtModal").dataset.courtId,t=!!n;try{const e=localStorage.getItem("adminToken");if(!e)return showNotification("Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.","error"),void(window.location.href="../../admin-login.html");const r=t?`/admin/canchas/${n}`:"/admin/canchas",i=t?"PUT":"POST",a=await AdminUtils.authenticatedFetch(r,{method:i,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)});if(a.ok){await a.json();showNotification(t?"Cancha actualizada exitosamente":"Cancha creada exitosamente","success");bootstrap.Modal.getInstance(document.getElementById("courtModal")).hide(),loadCourts()}else{showNotification((await a.json()).message||"Error al guardar la cancha","error")}}catch(e){console.error("Error:",e),showNotification("Error de conexi√≥n","error")}}function editCourt(e){openCourtModal(e)}async function deleteCourt(e){if(confirm("¬øEst√°s seguro de que quieres eliminar esta cancha?"))try{const o=localStorage.getItem("adminToken"),n=await AdminUtils.authenticatedFetch(`/admin/canchas/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}});if(n.ok)showNotification("Cancha eliminada exitosamente","success"),loadCourts();else{showNotification((await n.json()).message||"Error al eliminar la cancha","error")}}catch(e){console.error("Error:",e),showNotification("Error de conexi√≥n","error")}}function showNotification(e,o){const n="success"===o?"alert-success":"alert-danger",t="success"===o?"fa-check-circle":"fa-exclamation-triangle",r=document.createElement("div");r.className=`alert ${n} alert-dismissible fade show position-fixed`,r.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",r.innerHTML=`\n        <i class="fas ${t} me-2"></i>\n        ${e}\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},5e3)}function logout(){localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="../../admin-login.html"}function forzarVisibilidadElementos(){const e=AdminUtils.getCurrentUser();if(e&&("owner"===e.rol||"super_admin"===e.rol)){['a[href="admin-reports.html"]','a[href="admin-gastos.html"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.classList.add("owner-visible"),e.classList.remove("hide-for-owner"),e.style.display="block",e.style.visibility="visible",e.style.opacity="1"})})}}document.addEventListener("DOMContentLoaded",function(){if(AdminUtils.isAuthenticated()){if(currentUser=AdminUtils.getCurrentUser(),currentUser){document.getElementById("adminWelcome").textContent=`Bienvenido, ${currentUser.nombre||"Admin"}`;const e=document.querySelector('[data-user="name"]'),o=document.querySelector('[data-user="role"]'),n=document.querySelector('[data-user="complex"]');e&&(e.textContent=currentUser.nombre||"Admin"),o&&(o.textContent=AdminUtils.getRoleDisplayName(currentUser.rol)),n&&(n.textContent=currentUser.complejo_nombre||"Todos los complejos")}aplicarPermisosPorRol(),AdminUtils.hideElementsByRole(),AdminUtils.setupLogout(),loadComplexes(),loadCourts(),loadFilterTypes(),setupEventListeners()}else window.location.href="../../admin-login.html"}),setInterval(forzarVisibilidadElementos,2e3);let currentCanchaPromocion=null,currentCanchaNombre="",currentCanchaPrecio=0,currentPromocionEdit=null;async function openPromocionesModal(e,o,n){currentCanchaPromocion=e,currentCanchaNombre=o,currentCanchaPrecio=n,currentPromocionEdit=null;const t=document.getElementById("promocionesModal"),r=document.getElementById("promocionesModalSubtitle"),i=document.getElementById("promocionesListContainer"),a=document.getElementById("promocionFormContainer");if(!(t&&r&&i&&a))return console.error("‚ùå Elementos del modal de promociones no encontrados. Recarga la p√°gina."),void showNotification("Error: Elementos del modal no encontrados. Por favor, recarga la p√°gina.","error");r.textContent=`Cancha: ${o} - Precio normal: $${formatCurrencyChile(n)}`,poblarHorariosComplejo(),configurarAutoCloseDatePickers(),setTimeout(()=>{"function"==typeof updatePromocionFields&&updatePromocionFields()},100);new bootstrap.Modal(t).show(),a.style.display="none",i.style.display="block",await loadPromociones()}function poblarHorariosComplejo(){const e=AdminUtils.getCurrentUser(),o=e?.complejo_id;let n=12,t=23;6===o?(n=10,t=23):7===o&&(n=16,t=23);const r=[];for(let e=n;e<=t;e++){const o=e.toString().padStart(2,"0")+":00";r.push(`<option value="${o}">${o}</option>`)}["horaEspecifica","horaInicio","horaFin"].forEach(e=>{const o=document.getElementById(e);if(o){const e=o.value;o.innerHTML='<option value="">Selecciona una hora...</option>'+r.join(""),e&&(o.value=e)}})}function configurarAutoCloseDatePickers(){document.querySelectorAll(".date-auto-close").forEach(e=>{e.removeEventListener("change",cerrarDatePicker),e.addEventListener("change",cerrarDatePicker)})}function cerrarDatePicker(e){e.target.blur()}async function loadPromociones(){const e=document.getElementById("promocionesListContainer");e.innerHTML='\n        <div class="text-center text-muted py-4">\n            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>\n            <p>Cargando promociones...</p>\n        </div>\n    ';try{const o=await AdminUtils.authenticatedFetch(`/promociones/cancha/${currentCanchaPromocion}`);if(!o.ok)return o.status,void(e.innerHTML='\n                <div class="alert alert-info">\n                    <i class="fas fa-info-circle me-2"></i>\n                    No hay promociones configuradas para esta cancha. Haz clic en "Nueva Promoci√≥n" para crear una.\n                </div>\n            ');let n;try{n=await o.json()}catch(o){return void(e.innerHTML='\n                <div class="alert alert-info">\n                    <i class="fas fa-info-circle me-2"></i>\n                    No hay promociones configuradas para esta cancha. Haz clic en "Nueva Promoci√≥n" para crear una.\n                </div>\n            ')}if(0===n.length)return void(e.innerHTML='\n                <div class="alert alert-info">\n                    <i class="fas fa-info-circle me-2"></i>\n                    No hay promociones configuradas para esta cancha. Haz clic en "Nueva Promoci√≥n" para crear una.\n                </div>\n            ');e.innerHTML=n.map(e=>{const o=currentCanchaPrecio-e.precio_promocional,n=Math.round(o/currentCanchaPrecio*100);return`\n                <div class="card mb-3 ${e.activo?"border-success":"border-secondary"}">\n                    <div class="card-body">\n                        <div class="d-flex justify-content-between align-items-start">\n                            <div class="flex-grow-1">\n                                <h6 class="card-title mb-2">\n                                    ${e.nombre||"Promoci√≥n sin nombre"}\n                                    ${e.activo?'<span class="badge bg-success ms-2">Activa</span>':'<span class="badge bg-secondary ms-2">Inactiva</span>'}\n                                </h6>\n                                <p class="mb-2">\n                                    <strong class="text-success">$${formatCurrencyChile(e.precio_promocional)}</strong>\n                                    <span class="text-muted ms-2">(${n}% desc.)</span>\n                                </p>\n                                <div class="text-muted small">\n                                    <div><i class="fas fa-calendar me-1"></i>${formatPromocionFechas(e)}</div>\n                                    <div><i class="fas fa-clock me-1"></i>${formatPromocionHorarios(e)}</div>\n                                    ${e.descripcion?`<div class="mt-1"><i class="fas fa-info-circle me-1"></i>${e.descripcion}</div>`:""}\n                                </div>\n                            </div>\n                            <div class="btn-group-vertical ms-3">\n                                <button class="btn btn-sm btn-outline-${e.activo?"warning":"success"}" onclick="togglePromocionActiva(${e.id}, ${!e.activo})">\n                                    <i class="fas fa-${e.activo?"pause":"play"} me-1"></i>${e.activo?"Desactivar":"Activar"}\n                                </button>\n                                <button class="btn btn-sm btn-outline-primary" onclick="editPromocion(${e.id})">\n                                    <i class="fas fa-edit me-1"></i>Editar\n                                </button>\n                                <button class="btn btn-sm btn-outline-danger" onclick="deletePromocion(${e.id}, '${(e.nombre||"esta promoci√≥n").replace(/'/g,"\\'")}')">\n                                    <i class="fas fa-trash me-1"></i>Eliminar\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `}).join("")}catch(o){console.error("Error cargando promociones:",o),e.innerHTML='\n            <div class="alert alert-danger">\n                <i class="fas fa-exclamation-triangle me-2"></i>\n                Error cargando promociones. Por favor, intenta nuevamente.\n            </div>\n        '}}function formatPromocionFechas(e){if("especifico"===e.tipo_fecha&&e.fecha_especifica){let o=e.fecha_especifica;return"object"==typeof o?o=o.toISOString().split("T")[0]:o.includes("T")&&(o=o.split("T")[0]),`Fecha espec√≠fica: ${o}`}if("rango"===e.tipo_fecha&&e.fecha_inicio&&e.fecha_fin){let o=e.fecha_inicio,n=e.fecha_fin;return"object"==typeof o?o=o.toISOString().split("T")[0]:o.includes("T")&&(o=o.split("T")[0]),"object"==typeof n?n=n.toISOString().split("T")[0]:n.includes("T")&&(n=n.split("T")[0]),`Del ${o} al ${n}`}if("recurrente_semanal"===e.tipo_fecha&&e.dias_semana){return`Recurrente: ${(Array.isArray(e.dias_semana)?e.dias_semana:JSON.parse(e.dias_semana||"[]")).join(", ")}`}return"Fechas no especificadas"}function formatPromocionHorarios(e){return"especifico"===e.tipo_horario?`Hora: ${e.hora_especifica.substring(0,5)}`:"rango"===e.tipo_horario?`De ${e.hora_inicio.substring(0,5)} a ${e.hora_fin.substring(0,5)}`:"Horarios no especificados"}function openPromocionForm(){currentPromocionEdit=null,document.getElementById("promocionForm").reset(),document.getElementById("promocionId").value="",document.getElementById("promocionCanchaId").value=currentCanchaPromocion,document.getElementById("promocionFormTitle").innerHTML='<i class="fas fa-plus-circle me-2"></i>Nueva Promoci√≥n',document.getElementById("precioNormalLabel").textContent=`(Normal: $${formatCurrencyChile(currentCanchaPrecio)})`;const e=new Date;e.setDate(e.getDate()+7);const o=e.toISOString().split("T")[0];document.getElementById("fechaEspecifica").min=o,document.getElementById("fechaInicio").min=o,document.getElementById("fechaFin").min=o,document.getElementById("promocionesListContainer").style.display="none",document.getElementById("promocionFormContainer").style.display="block",updatePromocionFields()}function cancelPromocionForm(){document.getElementById("promocionFormContainer").style.display="none",document.getElementById("promocionesListContainer").style.display="block"}function updatePromocionFields(){const e=document.querySelector('input[name="tipoFecha"]:checked').value,o=document.querySelector('input[name="tipoHorario"]:checked').value;document.getElementById("fechaEspecificoContainer").style.display="especifico"===e?"block":"none",document.getElementById("fechaRangoContainer").style.display="rango"===e?"block":"none",document.getElementById("fechaRecurrenteContainer").style.display="recurrente_semanal"===e?"block":"none";const n=document.getElementById("horaEspecifica"),t=document.getElementById("horaInicio"),r=document.getElementById("horaFin");"especifico"===o?(document.getElementById("horarioEspecificoContainer").style.display="block",document.getElementById("horarioRangoContainer").style.display="none",n&&(n.required=!0),t&&(t.required=!1),r&&(r.required=!1)):(document.getElementById("horarioEspecificoContainer").style.display="none",document.getElementById("horarioRangoContainer").style.display="block",n&&(n.required=!1),t&&(t.required=!0),r&&(r.required=!0))}async function savePromocion(e){e.preventDefault();const o=document.querySelector('input[name="tipoFecha"]:checked').value,n=document.querySelector('input[name="tipoHorario"]:checked').value,t={cancha_id:currentCanchaPromocion,nombre:document.getElementById("promocionNombre").value.trim(),precio_promocional:parseFloat(document.getElementById("promocionPrecio").value),tipo_fecha:o,tipo_horario:n,descripcion:document.getElementById("promocionDescripcion").value.trim()||null};if(t.precio_promocional>=currentCanchaPrecio)return void showNotification("El precio promocional debe ser menor que el precio normal de la cancha","error");if("especifico"===o){if(t.fecha_especifica=document.getElementById("fechaEspecifica").value,!t.fecha_especifica)return void showNotification("Por favor, selecciona una fecha espec√≠fica","error")}else if("rango"===o){if(t.fecha_inicio=document.getElementById("fechaInicio").value,t.fecha_fin=document.getElementById("fechaFin").value,!t.fecha_inicio||!t.fecha_fin)return void showNotification("Por favor, selecciona las fechas de inicio y fin","error");if(t.fecha_inicio>t.fecha_fin)return void showNotification("La fecha de inicio debe ser anterior a la fecha de fin","error")}else if("recurrente_semanal"===o){const e=[];if(["lunes","martes","mi√©rcoles","jueves","viernes","s√°bado","domingo"].forEach(o=>{const n=document.getElementById(`dia${o.charAt(0).toUpperCase()+o.slice(1)}`);n&&n.checked&&e.push(o)}),0===e.length)return void showNotification("Por favor, selecciona al menos un d√≠a de la semana","error");t.dias_semana=e}if("especifico"===n){if(t.hora_especifica=document.getElementById("horaEspecifica").value,!t.hora_especifica)return void showNotification("Por favor, selecciona una hora espec√≠fica","error")}else if("rango"===n){if(t.hora_inicio=document.getElementById("horaInicio").value,t.hora_fin=document.getElementById("horaFin").value,!t.hora_inicio||!t.hora_fin)return void showNotification("Por favor, selecciona las horas de inicio y fin","error");if(t.hora_inicio>=t.hora_fin)return void showNotification("La hora de inicio debe ser anterior a la hora de fin","error")}const r=document.getElementById("promocionId").value,i=""!==r,a=i?`/promociones/${r}`:"/promociones",c=i?"PUT":"POST";try{const e=await AdminUtils.authenticatedFetch(a,{method:c,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)return e.status,void(404===e.status?showNotification("El sistema de promociones a√∫n no est√° disponible. Pr√≥ximamente.","info"):showNotification("Error al guardar promoci√≥n. C√≥digo: "+e.status,"error"));let o;try{o=await e.json()}catch(e){return void showNotification("Error en la respuesta del servidor","error")}showNotification(o.mensaje||`Promoci√≥n ${i?"actualizada":"creada"} exitosamente`,"success"),cancelPromocionForm(),await loadPromociones()}catch(e){console.error("Error guardando promoci√≥n:",e),showNotification("Error de conexi√≥n al guardar promoci√≥n","error")}}async function editPromocion(e){try{const o=await AdminUtils.authenticatedFetch(`/promociones/cancha/${currentCanchaPromocion}`),n=(await o.json()).find(o=>o.id===e);if(!n)return void showNotification("Promoci√≥n no encontrada","error");currentPromocionEdit=n,document.getElementById("promocionId").value=n.id,document.getElementById("promocionCanchaId").value=currentCanchaPromocion,document.getElementById("promocionNombre").value=n.nombre||"",document.getElementById("promocionPrecio").value=n.precio_promocional,document.getElementById("promocionDescripcion").value=n.descripcion||"",document.getElementById(`tipoFecha${n.tipo_fecha.charAt(0).toUpperCase()+n.tipo_fecha.slice(1).replace("_semanal","").replace("recurrente","Recurrente")}`).checked=!0,"especifico"===n.tipo_fecha?document.getElementById("fechaEspecifica").value=n.fecha_especifica:"rango"===n.tipo_fecha?(document.getElementById("fechaInicio").value=n.fecha_inicio,document.getElementById("fechaFin").value=n.fecha_fin):"recurrente_semanal"===n.tipo_fecha&&n.dias_semana.forEach(e=>{const o=document.getElementById(`dia${e.charAt(0).toUpperCase()+e.slice(1)}`);o&&(o.checked=!0)}),document.getElementById(`tipoHorario${n.tipo_horario.charAt(0).toUpperCase()+n.tipo_horario.slice(1)}`).checked=!0,"especifico"===n.tipo_horario?document.getElementById("horaEspecifica").value=n.hora_especifica.substring(0,5):"rango"===n.tipo_horario&&(document.getElementById("horaInicio").value=n.hora_inicio.substring(0,5),document.getElementById("horaFin").value=n.hora_fin.substring(0,5)),updatePromocionFields(),document.getElementById("promocionFormTitle").innerHTML='<i class="fas fa-edit me-2"></i>Editar Promoci√≥n',document.getElementById("precioNormalLabel").textContent=`(Normal: $${formatCurrencyChile(currentCanchaPrecio)})`,document.getElementById("promocionesListContainer").style.display="none",document.getElementById("promocionFormContainer").style.display="block"}catch(e){console.error("Error cargando promoci√≥n para editar:",e),showNotification("Error cargando datos de la promoci√≥n","error")}}async function deletePromocion(e,o){if(confirm(`¬øEst√°s seguro de eliminar la promoci√≥n "${o}"?`))try{const o=await AdminUtils.authenticatedFetch(`/promociones/${e}`,{method:"DELETE"}),n=await o.json();o.ok?(showNotification("Promoci√≥n eliminada exitosamente","success"),await loadPromociones()):showNotification(n.error||"Error al eliminar promoci√≥n","error")}catch(e){console.error("Error eliminando promoci√≥n:",e),showNotification("Error de conexi√≥n al eliminar promoci√≥n","error")}}async function togglePromocionActiva(e,o){try{const n=await AdminUtils.authenticatedFetch(`/promociones/${e}/toggle`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({activo:o})}),t=await n.json();n.ok?(showNotification(`Promoci√≥n ${o?"activada":"desactivada"} exitosamente`,"success"),await loadPromociones()):showNotification(t.error||"Error al cambiar estado de promoci√≥n","error")}catch(e){console.error("Error cambiando estado de promoci√≥n:",e),showNotification("Error de conexi√≥n al cambiar estado","error")}}document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{const e=document.querySelectorAll('input[name="tipoFecha"]'),o=document.querySelectorAll('input[name="tipoHorario"]');e.forEach(e=>{e.addEventListener("change",updatePromocionFields)}),o.forEach(e=>{e.addEventListener("change",updatePromocionFields)});const n=document.getElementById("promocionForm");n&&n.addEventListener("submit",savePromocion)},1e3)});