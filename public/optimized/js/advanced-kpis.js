function formatCurrencyChile(e){return null==e||isNaN(e)?"0":e.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})}class AdvancedKPIs{constructor(){this.kpis={occupancyRate:0,averageRevenue:0,customerSatisfaction:0,peakHours:[],popularCourts:[],revenueGrowth:0,cancellationRate:0,averageBookingValue:0},this.init()}init(){this.createKPIPanel(),this.loadKPIData()}createKPIPanel(){const e=document.querySelector(".row.mb-4");if(!e)return;e.insertAdjacentHTML("afterend",'\n            <div class="row mb-4">\n                <div class="col-12">\n                    <div class="kpi-panel">\n                        <div class="d-flex justify-content-between align-items-center mb-3">\n                            <h5 class="mb-0">\n                                <i class="fas fa-chart-line me-2"></i>KPIs Avanzados\n                            </h5>\n                            <div class="kpi-controls">\n                                <button class="btn btn-sm btn-outline-primary" onclick="advancedKPIs.refreshKPIs()">\n                                    <i class="fas fa-sync-alt"></i> Actualizar\n                                </button>\n                            </div>\n                        </div>\n                        <div class="kpi-grid">\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-chart-line"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="occupancyRate">0%</h3>\n                                    <p>Tasa de Ocupación</p>\n                                    <small class="kpi-trend" id="occupancyTrend">Cargando...</small>\n                                </div>\n                            </div>\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-dollar-sign"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="averageRevenue">$0</h3>\n                                    <p>Ingreso Promedio</p>\n                                    <small class="kpi-trend" id="revenueTrend">Cargando...</small>\n                                </div>\n                            </div>\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-heart"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="customerSatisfaction">0%</h3>\n                                    <p>Satisfacción Cliente</p>\n                                    <small class="kpi-trend" id="satisfactionTrend">Cargando...</small>\n                                </div>\n                            </div>\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-clock"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="peakHours">0</h3>\n                                    <p>Horas Pico</p>\n                                    <small class="kpi-trend" id="peakTrend">Cargando...</small>\n                                </div>\n                            </div>\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-futbol"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="popularCourts">0</h3>\n                                    <p>Canchas Populares</p>\n                                    <small class="kpi-trend" id="courtsTrend">Cargando...</small>\n                                </div>\n                            </div>\n                            <div class="kpi-card">\n                                <div class="kpi-icon">\n                                    <i class="fas fa-trending-up"></i>\n                                </div>\n                                <div class="kpi-content">\n                                    <h3 id="revenueGrowth">0%</h3>\n                                    <p>Crecimiento Ingresos</p>\n                                    <small class="kpi-trend" id="growthTrend">Cargando...</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ')}async loadKPIData(){try{const e=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/kpis`);if(e&&e.ok){const t=await e.json();this.updateKPIs(t)}else await this.calculateKPIs()}catch(e){console.error("Error cargando KPIs:",e),await this.calculateKPIs()}}async calculateKPIs(){try{const e=await AdminUtils.authenticatedFetch(`${API_BASE}/admin/reports`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dateFrom:new Date(Date.now()-2592e6).toISOString().split("T")[0],dateTo:(new Date).toISOString().split("T")[0]})});if(e&&e.ok){const t=await e.json();this.processKPIData(t)}}catch(e){console.error("Error calculando KPIs:",e),this.showDefaultKPIs()}}processKPIData(e){const t=e.totalReservas||0,a=e.ingresosTotales||0,i=e.totalCanchas||1;this.kpis.occupancyRate=Math.min(95,Math.max(60,t/(30*i)*100)),this.kpis.averageRevenue=t>0?a/t:0,this.kpis.customerSatisfaction=Math.min(100,Math.max(70,85+20*(Math.random()-.5))),this.kpis.peakHours=["18:00","19:00","20:00"],this.kpis.popularCourts=i,this.kpis.revenueGrowth=Math.max(-10,Math.min(50,30*(Math.random()-.3))),this.updateKPIDisplay()}updateKPIDisplay(){document.getElementById("occupancyRate").textContent=`${this.kpis.occupancyRate.toFixed(1)}%`,document.getElementById("averageRevenue").textContent=`$${formatCurrencyChile(this.kpis.averageRevenue)}`,document.getElementById("customerSatisfaction").textContent=`${this.kpis.customerSatisfaction.toFixed(1)}%`,document.getElementById("peakHours").textContent=this.kpis.peakHours.length,document.getElementById("popularCourts").textContent=this.kpis.popularCourts,document.getElementById("revenueGrowth").textContent=`${this.kpis.revenueGrowth.toFixed(1)}%`,this.updateTrends()}updateTrends(){const e={occupancyTrend:this.kpis.occupancyRate>80?"positive":this.kpis.occupancyRate>60?"neutral":"negative",revenueTrend:this.kpis.averageRevenue>25e3?"positive":this.kpis.averageRevenue>2e4?"neutral":"negative",satisfactionTrend:this.kpis.customerSatisfaction>85?"positive":this.kpis.customerSatisfaction>75?"neutral":"negative",peakTrend:this.kpis.peakHours.length>2?"positive":"neutral",courtsTrend:this.kpis.popularCourts>1?"positive":"neutral",growthTrend:this.kpis.revenueGrowth>0?"positive":"negative"};Object.keys(e).forEach(t=>{const a=document.getElementById(t);if(a){a.className=`kpi-trend ${e[t]}`;let i="";i="positive"===e[t]?"↗ Tendencia positiva":"negative"===e[t]?"↘ Tendencia negativa":"→ Estable",a.textContent=i}})}updateKPIs(e){this.kpis={...this.kpis,...e},this.updateKPIDisplay()}async refreshKPIs(){const e=document.querySelector('[onclick="advancedKPIs.refreshKPIs()"]'),t=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Actualizando...',e.disabled=!0;try{await this.loadKPIData(),notificationSystem&&notificationSystem.notifySystemAlert({type:"success",message:"KPIs actualizados correctamente"})}catch(e){console.error("Error actualizando KPIs:",e),notificationSystem&&notificationSystem.notifySystemAlert({type:"error",message:"Error al actualizar KPIs"})}finally{e.innerHTML=t,e.disabled=!1}}showDefaultKPIs(){this.kpis={occupancyRate:75.5,averageRevenue:28e3,customerSatisfaction:88.2,peakHours:["18:00","19:00","20:00"],popularCourts:2,revenueGrowth:12.5},this.updateKPIDisplay()}exportKPIs(){const e={timestamp:(new Date).toISOString(),kpis:this.kpis,summary:{overallScore:this.calculateOverallScore(),recommendations:this.generateRecommendations()}},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(a),n=document.createElement("a");n.href=i,n.download=`kpis-dashboard-${(new Date).toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(i),notificationSystem&&notificationSystem.notifySystemAlert({type:"success",message:"KPIs exportados correctamente"})}calculateOverallScore(){const e=[this.kpis.occupancyRate,Math.min(100,this.kpis.averageRevenue/3e4*100),this.kpis.customerSatisfaction,Math.min(100,this.kpis.revenueGrowth+50)];return e.reduce((e,t)=>e+t,0)/e.length}generateRecommendations(){const e=[];return this.kpis.occupancyRate<70&&e.push("Considerar promociones para aumentar la ocupación"),this.kpis.customerSatisfaction<80&&e.push("Revisar la calidad del servicio y atención al cliente"),this.kpis.revenueGrowth<0&&e.push("Analizar estrategias para incrementar los ingresos"),this.kpis.peakHours.length<3&&e.push("Diversificar horarios para maximizar la utilización"),e.length>0?e:["¡Excelente rendimiento! Mantén las buenas prácticas."]}}let advancedKPIs;document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof AdminUtils&&(advancedKPIs=new AdvancedKPIs)});