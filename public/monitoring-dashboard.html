<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoreo - Reserva Tu Cancha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .metric-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .metric-value { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #007bff; 
        }
        .metric-label { 
            color: #6c757d; 
            font-size: 0.9rem; 
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        .alert-item {
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }
        .alert-critical { border-left-color: #dc3545; background: #fff5f5; }
        .alert-warning { border-left-color: #ffc107; background: #fffbf0; }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1><i class="fas fa-chart-line"></i> Dashboard de Monitoreo</h1>
                        <div class="refresh-indicator">
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i> Actualizar
                            </button>
                            <small class="text-muted d-block mt-1" id="lastUpdate">Última actualización: --</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métricas Principales -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="uptime">--</div>
                    <div class="metric-label">Tiempo Activo</div>
                    <small class="text-muted" id="uptimeText">--</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="totalRequests">--</div>
                    <div class="metric-label">Total Requests</div>
                    <small class="text-muted">Última hora</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="avgResponseTime">--</div>
                    <div class="metric-label">Tiempo Respuesta Promedio</div>
                    <small class="text-muted">ms</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="errorRate">--</div>
                    <div class="metric-label">Tasa de Error</div>
                    <small class="text-muted">%</small>
                </div>
            </div>
        </div>

        <!-- Métricas de Negocio -->
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-value text-success" id="totalReservations">--</div>
                    <div class="metric-label">Reservas Totales</div>
                    <small class="text-muted">Hoy</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-value text-success" id="totalRevenue">--</div>
                    <div class="metric-label">Ingresos Totales</div>
                    <small class="text-muted">$</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-value text-success" id="paymentSuccessRate">--</div>
                    <div class="metric-label">Tasa Éxito Pagos</div>
                    <small class="text-muted">%</small>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <div class="col-md-6">
                <div class="metric-card">
                    <h5><i class="fas fa-chart-area"></i> Uso de Memoria</h5>
                    <div class="chart-container">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metric-card">
                    <h5><i class="fas fa-chart-bar"></i> Requests por Hora</h5>
                    <div class="chart-container">
                        <canvas id="requestsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- APIs y Base de Datos -->
        <div class="row">
            <div class="col-md-6">
                <div class="metric-card">
                    <h5><i class="fas fa-code"></i> APIs Más Utilizadas</h5>
                    <div id="topApis">
                        <div class="text-center text-muted">Cargando...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metric-card">
                    <h5><i class="fas fa-database"></i> Queries de Base de Datos</h5>
                    <div id="topQueries">
                        <div class="text-center text-muted">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <h5><i class="fas fa-exclamation-triangle"></i> Alertas Recientes</h5>
                    <div id="recentAlerts">
                        <div class="text-center text-muted">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let memoryChart, requestsChart;
        let refreshInterval;

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            refreshData();
            
            // Auto-refresh cada 30 segundos
            refreshInterval = setInterval(refreshData, 30000);
        });

        // Inicializar gráficos
        function initializeCharts() {
            // Gráfico de memoria
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memoria Usada (MB)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico de requests
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            requestsChart = new Chart(requestsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        backgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Actualizar datos
        async function refreshData() {
            try {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.classList.add('fa-spin');

                const [summaryResponse, apisResponse, queriesResponse, alertsResponse] = await Promise.all([
                    fetch('/api/monitoring/summary'),
                    fetch('/api/monitoring/apis'),
                    fetch('/api/monitoring/database'),
                    fetch('/api/monitoring/alerts?limit=10')
                ]);

                const [summary, apis, queries, alerts] = await Promise.all([
                    summaryResponse.json(),
                    apisResponse.json(),
                    queriesResponse.json(),
                    alertsResponse.json()
                ]);

                if (summary.success) {
                    updateSummaryMetrics(summary.data);
                }

                if (apis.success) {
                    updateApisList(apis.data);
                }

                if (queries.success) {
                    updateQueriesList(queries.data);
                }

                if (alerts.success) {
                    updateAlertsList(alerts.data);
                }

                document.getElementById('lastUpdate').textContent = 
                    `Última actualización: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.classList.remove('fa-spin');
            }
        }

        // Actualizar métricas principales
        function updateSummaryMetrics(data) {
            document.getElementById('uptime').textContent = formatUptime(data.overview.uptime);
            document.getElementById('uptimeText').textContent = formatUptimeText(data.overview.uptime);
            document.getElementById('totalRequests').textContent = data.overview.totalApiCalls.toLocaleString();
            document.getElementById('avgResponseTime').textContent = data.overview.averageApiResponseTime;
            document.getElementById('errorRate').textContent = data.overview.totalErrors.toLocaleString();
            
            document.getElementById('totalReservations').textContent = data.business.totalReservations.toLocaleString();
            document.getElementById('totalRevenue').textContent = '$' + data.business.totalRevenue.toLocaleString();
            document.getElementById('paymentSuccessRate').textContent = 
                Math.round(data.business.paymentSuccessRate * 100) + '%';
        }

        // Actualizar lista de APIs
        function updateApisList(apis) {
            const container = document.getElementById('topApis');
            if (apis.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No hay datos disponibles</div>';
                return;
            }

            container.innerHTML = apis.slice(0, 5).map(api => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>${api.endpoint}</strong><br>
                        <small class="text-muted">${api.calls} llamadas</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">${api.averageDuration}ms</span><br>
                        <small class="text-muted">${Math.round(api.errorRate * 100)}% error</small>
                    </div>
                </div>
            `).join('');
        }

        // Actualizar lista de queries
        function updateQueriesList(queries) {
            const container = document.getElementById('topQueries');
            if (queries.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No hay datos disponibles</div>';
                return;
            }

            container.innerHTML = queries.map(query => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>${query.type}</strong><br>
                        <small class="text-muted">${query.queries} queries</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info">${query.averageDuration}ms</span><br>
                        <small class="text-muted">${Math.round(query.errorRate * 100)}% error</small>
                    </div>
                </div>
            `).join('');
        }

        // Actualizar lista de alertas
        function updateAlertsList(alerts) {
            const container = document.getElementById('recentAlerts');
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No hay alertas recientes</div>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.severity === 'critical' ? 'alert-critical' : 
                    alert.severity === 'warning' ? 'alert-warning' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${alert.message}</strong><br>
                            <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                        </div>
                        <span class="badge ${alert.severity === 'critical' ? 'bg-danger' : 
                            alert.severity === 'warning' ? 'bg-warning' : 'bg-info'}">${alert.severity}</span>
                    </div>
                </div>
            `).join('');
        }

        // Formatear tiempo activo
        function formatUptime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }

        function formatUptimeText(ms) {
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            if (days > 0) {
                return `${days} días`;
            }
            return 'Menos de 1 día';
        }

        // Limpiar interval al cerrar
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
